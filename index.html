<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Davomad | GPS Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg: #248b65; --blue: #007AFF; --bg: #f2f2f7; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; margin-bottom: 15px; }
        .hidden { display: none !important; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-main { background: var(--tg); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-out { background: white; color: red; border: 1px solid red; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; }
        .nav div { flex: 1; text-align: center; padding: 15px; font-size: 12px; color: #888; }
        .nav .active { color: var(--blue); font-weight: bold; }
    </style>
</head>
<body>

<div id="view-reg" class="card hidden">
    <h2>Ro'yxatdan o'tish</h2>
    <input type="text" id="reg-name" placeholder="Ismingiz">
    <select id="reg-role">
        <option value="student">Talaba</option>
        <option value="teacher">O'qituvchi</option>
    </select>
    <button class="btn-blue" onclick="saveUser()">Saqlash</button>
</div>

<div id="view-student" class="tab-content hidden">
    <div class="card">
        <h3 id="st-name">Salom</h3>
        <p id="gps-status">GPS tekshirilmoqda...</p>
        <button id="btn-auth" class="btn-main" onclick="startAuth()">Davomatni tasdiqlash</button>
    </div>
</div>

<div id="view-teacher" class="tab-content hidden">
    <div class="card">
        <h3>Bugun kelganlar:</h3>
        <div id="list" style="text-align: left;"></div>
    </div>
</div>

<div id="view-settings" class="tab-content hidden">
    <div class="card">
        <h3>Sozlamalar</h3>
        <p id="prof-info"></p>
        <button class="btn-out" onclick="logout()">Tizimdan chiqish</button>
    </div>
</div>

<div id="bottom-nav" class="nav hidden">
    <div id="nav-home" class="active" onclick="showTab('home')">üè†<br>Asosiy</div>
    <div id="nav-set" onclick="showTab('settings')">‚öôÔ∏è<br>Sozlama</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe.user?.id || "test_id";
    let user = null;

    // GPS koordinatalari (Siz bergan nuqta)
    const UNI_LAT = 39.800911;
    const UNI_LON = 64.426838;
    const RADIUS = 0.5; // 500 metr atrofida

    async function init() {
        tg.expand();
        const s = await get(ref(db, `users/${userId}`));
        if(s.exists()){
            user = s.val();
            render();
        } else {
            document.getElementById('view-reg').classList.remove('hidden');
        }
    }
    init();

    window.saveUser = async () => {
        const name = document.getElementById('reg-name').value;
        const role = document.getElementById('reg-role').value;
        if(!name) return;
        user = { name, role };
        await set(ref(db, `users/${userId}`), user);
        render();
    };

    function render() {
        document.getElementById('view-reg').classList.add('hidden');
        document.getElementById('bottom-nav').classList.remove('hidden');
        document.getElementById('prof-info').innerText = `${user.name} (${user.role})`;
        showTab('home');
    }

    window.showTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.getElementById('nav-home').classList.remove('active');
        document.getElementById('nav-set').classList.remove('active');

        if(tab === 'home') {
            document.getElementById('nav-home').classList.add('active');
            if(user.role === 'teacher') {
                document.getElementById('view-teacher').classList.remove('hidden');
                loadList();
            } else {
                document.getElementById('view-student').classList.remove('hidden');
                document.getElementById('st-name').innerText = user.name;
                checkGPS();
            }
        } else {
            document.getElementById('nav-set').classList.add('active');
            document.getElementById('view-settings').classList.remove('hidden');
        }
    };

    function checkGPS() {
        navigator.geolocation.getCurrentPosition(pos => {
            const dist = Math.sqrt(Math.pow(pos.coords.latitude - UNI_LAT, 2) + Math.pow(pos.coords.longitude - UNI_LON, 2)) * 111;
            if(dist <= RADIUS) {
                document.getElementById('gps-status').innerHTML = "‚úÖ Universitet hududidasiz";
                document.getElementById('btn-auth').disabled = false;
            } else {
                document.getElementById('gps-status').innerHTML = "‚ùå Universitetda emassiz";
                document.getElementById('btn-auth').disabled = true;
            }
        }, () => {
            document.getElementById('gps-status').innerText = "GPS ruxsat berilmagan!";
        });
    }

    window.startAuth = () => {
        tg.BiometricManager.init(() => {
            tg.BiometricManager.authenticate({ reason: "Tasdiqlang" }, async (ok) => {
                if(ok) {
                    const today = new Date().toISOString().split('T')[0];
                    await set(ref(db, `attendance/${today}/${userId}`), { name: user.name });
                    tg.showAlert("Davomat qilindi! ‚úÖ");
                }
            });
        });
    };

    function loadList() {
        const today = new Date().toISOString().split('T')[0];
        onValue(ref(db, `attendance/${today}`), s => {
            const l = document.getElementById('list');
            l.innerHTML = "";
            s.forEach(c => { l.innerHTML += `‚Ä¢ ${c.val().name}<br>`; });
        });
    }

    window.logout = async () => {
        await remove(ref(db, `users/${userId}`));
        location.reload();
    };
</script>
</body>
</html>
