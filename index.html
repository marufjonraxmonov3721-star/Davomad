<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kino Pro: Perfect Sleep</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding: 0; overflow: hidden; }
        
        /* Video Container */
        .main-wrapper { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .video-card { width: 95%; max-width: 650px; background: #111; border-radius: 20px; border: 2px solid #333; position: relative; overflow: hidden; }
        video#v { width: 100%; display: block; }

        /* Aqlli bildirishnoma */
        #sleep-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(123, 66, 245, 0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }

        .controls { background: linear-gradient(135deg, var(--p), #4b0082); padding: 20px; }
        .status-line { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; color: #ddd; }
        
        /* Kamera preview - aniqlashni tekshirish uchun */
        #debug-cam { position: absolute; top: 10px; right: 10px; width: 60px; height: 45px; border-radius: 5px; opacity: 0.4; border: 1px solid white; transform: scaleX(-1); }
        
        .btn-main { background: white; color: black; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

<div class="main-wrapper" id="start-view">
    <div style="text-align: center; padding: 40px; border: 2px dashed var(--p); border-radius: 20px; cursor: pointer;" onclick="document.getElementById('file-in').click()">
        <span style="font-size: 60px;">üëÅÔ∏è‚Äçüó®Ô∏è</span>
        <h2>Mukammal Aqlli Pleyer</h2>
        <p>Kino tanlang. Ilova ko'zlaringizni 99% aniqlikda kuzatadi.</p>
        <input type="file" id="file-in" hidden accept="video/*" onchange="bootApp(event)">
    </div>
</div>

<div class="main-wrapper" id="player-view" style="display: none;">
    <div class="video-card">
        <video id="debug-cam" autoplay muted></video>
        <video id="v" controls></video>
        
        <div id="sleep-overlay">
            <h1>UYQU REJIMI üò¥</h1>
            <p>Ko'zlaringiz yopildi. 10 soniyadan keyin o'chadi.</p>
            <button class="btn-main" onclick="wakeUp()">MEN UYG'OQMAN!</button>
        </div>

        <div class="controls">
            <div class="status-line">
                <span>Datchik: <b id="eye-label">Yuklanmoqda...</b></span>
                <span id="save-tag">SAQLANDI ‚úÖ</span>
            </div>
            <button class="btn-main" onclick="location.reload()" style="background: #000; color: white; border: 1px solid #555;">YOPISH</button>
        </div>
    </div>
</div>

<script>
    const v = document.getElementById('v');
    const eyeLabel = document.getElementById('eye-label');
    const sleepOverlay = document.getElementById('sleep-overlay');
    let eyeClosedStart = null;
    let isSleeping = false;

    async function bootApp(e) {
        const file = e.target.files[0];
        if(!file) return;

        // Modellar yuklanishi
        eyeLabel.innerText = "Modellar yuklanmoqda...";
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);

        // Kamera
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320 } });
        document.getElementById('debug-cam').srcObject = stream;

        // UI o'zgarishi
        v.src = URL.createObjectURL(file);
        document.getElementById('start-view').style.display = 'none';
        document.getElementById('player-view').style.display = 'flex';
        
        // Eslab qolish (LocalStorage)
        const saved = localStorage.getItem(file.name);
        if(saved) v.currentTime = saved;
        
        v.play();
        startTracking();
    }

    function startTracking() {
        setInterval(async () => {
            if (v.paused || isSleeping) return;

            const detection = await faceapi.detectSingleFace(
                document.getElementById('debug-cam'), 
                new faceapi.TinyFaceDetectorOptions()
            ).withFaceLandmarks();

            if (detection) {
                const landmarks = detection.landmarks;
                const left = landmarks.getLeftEye();
                const right = landmarks.getRightEye();

                // EAR (Eye Aspect Ratio) algoritmi - mukammal aniqlik uchun
                const eyeHeight = (left[4].y - left[1].y + right[4].y - right[1].y) / 2;
                
                if (eyeHeight < 2.5) { // Ko'z haqiqatda yopildi
                    if (!eyeClosedStart) eyeClosedStart = Date.now();
                    let diff = Math.floor((Date.now() - eyeClosedStart) / 1000);
                    
                    eyeLabel.innerText = `Yopiq (${10 - diff}s)`;
                    eyeLabel.style.color = "red";

                    if (diff >= 10) triggerSleep();
                } else {
                    eyeClosedStart = null;
                    eyeLabel.innerText = "Ochiq üëÄ";
                    eyeLabel.style.color = "#00ff00";
                }
            } else {
                eyeLabel.innerText = "Yuz ko'rinmadi ‚ö†Ô∏è";
                eyeLabel.style.color = "orange";
            }
        }, 500);
    }

    function triggerSleep() {
        isSleeping = true;
        v.pause();
        sleepOverlay.style.display = 'flex';
    }

    function wakeUp() {
        isSleeping = false;
        sleepOverlay.style.display = 'none';
        eyeClosedStart = null;
        v.play();
    }

    // Har 5 soniyada vaqtni eslab qolish
    setInterval(() => {
        if(!v.paused) localStorage.setItem(v.src, v.currentTime);
    }, 5000);
</script>
</body>
</html>
