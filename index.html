<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro: Smart Sensor</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #000; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        
        .main-app { height: 100vh; display: flex; flex-direction: column; }
        video { width: 100%; flex-grow: 1; background: #000; }

        /* Aktivlik tekshiruvi oynasi */
        #check-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
        }

        .purple-bar { background: linear-gradient(135deg, var(--p), #4b0082); padding: 15px; text-align: center; }
        
        .btn-tg { 
            background: #fff; color: #000; border: none; padding: 15px; 
            border-radius: 12px; font-weight: bold; width: 80%; cursor: pointer;
        }

        #sensor-info { font-size: 10px; color: #777; margin-top: 5px; }
    </style>
</head>
<body>

<div id="setup" style="display: flex; height: 100vh; justify-content: center; align-items: center; flex-direction: column; padding: 20px; text-align: center;">
    <h1 style="color: var(--p);">ðŸŽ¬ KINO PRO</h1>
    <p>Aqlli harakat datchigi yoqilgan</p>
    <button class="btn-tg" onclick="document.getElementById('f').click()">KINO TANLASH</button>
    <input type="file" id="f" hidden accept="video/*" onchange="startApp(event)">
</div>

<div id="player-ui" class="main-app" style="display: none;">
    <video id="v" controls playsinline></video>
    
    <div id="check-overlay">
        <h2 style="color: var(--p);">UYG'OQMISIZ?</h2>
        <p>Iltimos, tasdiqlang, aks holda video o'chadi.</p>
        <button class="btn-tg" onclick="confirmIdentity()">HA, UYG'OQMAN</button>
        <div id="countdown" style="margin-top: 15px; font-size: 20px;">20</div>
    </div>

    <div class="purple-bar">
        <div style="display: flex; justify-content: space-between; font-size: 12px;">
            <span id="move-status">Harakat: Barqaror âœ…</span>
            <span id="timer-display">Tekshiruv: 15:00</span>
        </div>
        <div id="sensor-info">Giroskop faol...</div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const v = document.getElementById('v');
    let lastMove = Date.now();
    let checkInterval = 15 * 60; // Har 15 daqiqada
    let countdownVal = 20;
    let timerIdx, countIdx;

    function startApp(e) {
        const file = e.target.files[0];
        if(!file) return;

        v.src = URL.createObjectURL(file);
        document.getElementById('setup').style.display = 'none';
        document.getElementById('player-ui').style.display = 'flex';
        
        // Eslab qolish
        const saved = localStorage.getItem(file.name);
        if(saved) v.currentTime = saved;

        v.play();
        initSensors();
        startCheckTimer();
    }

    // 1. Giroskop (Harakatni sezish)
    function initSensors() {
        window.addEventListener('deviceorientation', (event) => {
            // Agar telefon burchagi keskin o'zgarsa (uxlab qolib qo'ldan tushsa yoki og'sa)
            if (Math.abs(event.beta) > 45 || Math.abs(event.gamma) > 45) {
                lastMove = Date.now();
                document.getElementById('move-status').innerText = "Harakat: Sezildi âš¡";
            }
        });

        // Ekran bosilganda ham vaqtni yangilash
        window.addEventListener('touchstart', () => { lastMove = Date.now(); });
    }

    // 2. Aktivlik taymeri
    function startCheckTimer() {
        timerIdx = setInterval(() => {
            if (v.paused) return;
            
            checkInterval--;
            let mins = Math.floor(checkInterval / 60);
            let secs = checkInterval % 60;
            document.getElementById('timer-display').innerText = `Tekshiruv: ${mins}:${secs < 10 ? '0' : ''}${secs}`;

            // Agar 15 daqiqa harakatsiz bo'lsa yoki vaqt tugasa
            if (checkInterval <= 0) {
                triggerCheck();
            }
        }, 1000);
    }

    function triggerCheck() {
        clearInterval(timerIdx);
        v.pause();
        document.getElementById('check-overlay').style.display = 'flex';
        
        countdownVal = 20;
        countIdx = setInterval(() => {
            countdownVal--;
            document.getElementById('countdown').innerText = countdownVal;
            if (countdownVal <= 0) {
                clearInterval(countIdx);
                tg.close(); // Ilovani butunlay yopish
            }
        }, 1000);
    }

    function confirmIdentity() {
        clearInterval(countIdx);
        document.getElementById('check-overlay').style.display = 'none';
        checkInterval = 15 * 60; // Taymerni qayta tiklash
        startCheckTimer();
        v.play();
    }

    // Har 5 soniyada eslab qolish
    setInterval(() => {
        if(!v.paused) localStorage.setItem(v.src, v.currentTime);
    }, 5000);

</script>
</body>
</html>
