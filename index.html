<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OXU Davomat PRO</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
 --blue:#0047AB;
 --grad:linear-gradient(135deg,#0052D4,#4364F7,#6FB1FC);
}
body{margin:0;font-family:system-ui;background:#f2f4f8}
.header{background:var(--grad);color:#fff;text-align:center;padding:25px;border-radius:0 0 25px 25px}
.container{padding:15px;max-width:430px;margin:auto}
.card{background:#fff;border-radius:18px;padding:20px;margin:15px 0;box-shadow:0 8px 20px rgba(0,0,0,.1)}
button{width:100%;padding:14px;border:none;border-radius:12px;font-weight:bold;margin-top:8px}
.ok{background:#1a8a5f;color:#fff}
.blue{background:var(--blue);color:#fff}
.red{background:#dc3545;color:#fff}
.hidden{display:none}
.list{padding:8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between}
.small{font-size:12px;color:#666}
</style>
</head>
<body>

<div class="header">
<h3>üìö OXU DAVOMAT PRO</h3>
</div>

<div class="container">

<!-- REG -->
<div id="reg" class="card">
<input id="name" placeholder="F.I.SH">
<input id="pin" maxlength="4" placeholder="PIN (4 xonali)">
<select id="role">
<option value="student">Talaba</option>
<option value="teacher">O'qituvchi</option>
</select>
<button class="blue" onclick="saveUser()">Kirish</button>
</div>

<!-- STUDENT -->
<div id="student" class="hidden">

<div class="card" style="text-align:center">
<img id="avatar" width="70" style="border-radius:50%">
<h3 id="welcome"></h3>

<p id="gps" class="small">GPS tekshirilmoqda...</p>

<button id="bioBtn" class="ok" disabled onclick="bio()">Barmoq izi</button>
<input id="loginPin" maxlength="4" placeholder="PIN">
<button id="pinBtn" class="blue" disabled onclick="pinLogin()">PIN</button>
</div>

<div class="card">
<h4>Oxirgi 7 kun</h4>
<div id="history"></div>
</div>

</div>

<!-- TEACHER -->
<div id="teacher" class="hidden">

<div class="card">
<button class="blue" onclick="genQR()">QR yaratish</button>
<canvas id="qr"></canvas>
<button class="ok" onclick="exportExcel()">Excel yuklab olish</button>
</div>

<div class="card">
<h4>Bugungi davomat</h4>
<div id="list"></div>
</div>

</div>

<audio id="okSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,set,get,onValue} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
 databaseURL:"https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
 projectId:"gen-lang-client-0228947349",
 appId:"1:253793341504:web:709752258000dab44fcfa5"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const tg=window.Telegram.WebApp;
tg.expand();

const uid=tg.initDataUnsafe.user?.id || "debug";
let user;

const TARGET={lat:39.800911,lon:64.426838,radius:.3};

init();

async function init(){
 const s=await get(ref(db,'users/'+uid));
 if(s.exists()){ user=s.val(); render(); }
}

window.saveUser=async()=>{
 user={
  name:name.value,
  pin:pin.value,
  role:role.value
 };
 await set(ref(db,'users/'+uid),user);
 render();
};

function render(){
 reg.classList.add("hidden");

 if(user.role==="student"){
  student.classList.remove("hidden");
  welcome.innerText="Salom, "+user.name;
  avatar.src=tg.initDataUnsafe.user.photo_url || "";
  checkGPS();
  loadHistory();
 }
 else{
  teacher.classList.remove("hidden");
  loadList();
 }
}

/* ================= GPS ================= */
function checkGPS(){
 navigator.geolocation.getCurrentPosition(pos=>{
  const d=Math.sqrt((pos.coords.latitude-TARGET.lat)**2+(pos.coords.longitude-TARGET.lon)**2)*111;
  if(d<=TARGET.radius){
   gps.innerText="‚úÖ Hududdasiz";
   bioBtn.disabled=false;
   pinBtn.disabled=false;
  } else gps.innerText="‚ùå Tashqarida";
 });
}

/* ================= TIME LIMIT ================= */
function allowedTime(){
 const h=new Date().getHours();
 return h>=8 && h<=9;
}

/* ================= SAVE ================= */
async function save(method){

 if(!allowedTime()) return alert("Davomat vaqti 08:00‚Äì09:00");

 const today=new Date().toISOString().split('T')[0];

 const snap=await get(ref(db,'attendance/'+today+'/'+uid));
 if(snap.exists()) return alert("Allaqachon bosgansiz");

 await set(ref(db,'attendance/'+today+'/'+uid),{
  name:user.name,
  time:new Date().toLocaleTimeString(),
  method
 });

 okSound.play();
 alert("Qabul qilindi ‚úÖ");
 loadHistory();
}

/* ================= AUTH ================= */
window.pinLogin=()=> loginPin.value===user.pin?save("PIN"):alert("Xato");

window.bio=()=>{
 tg.BiometricManager.init(()=>{
  tg.BiometricManager.authenticate({}, ok=>{
   if(ok) save("BIO");
  });
 });
};

/* ================= HISTORY ================= */
async function loadHistory(){
 history.innerHTML="";
 for(let i=0;i<7;i++){
  const d=new Date();
  d.setDate(d.getDate()-i);
  const day=d.toISOString().split('T')[0];
  const s=await get(ref(db,'attendance/'+day+'/'+uid));
  history.innerHTML+=`<div class="list">${day}<b>${s.exists()?"‚úÖ":"‚ùå"}</b></div>`;
 }
}

/* ================= TEACHER ================= */
function loadList(){
 const today=new Date().toISOString().split('T')[0];
 onValue(ref(db,'attendance/'+today),s=>{
  list.innerHTML="";
  if(!s.exists()) return list.innerText="Hali yo'q";
  s.forEach(c=>{
   const v=c.val();
   list.innerHTML+=`<div class="list">${v.name}<span>${v.time}</span></div>`;
  });
 });
}

/* ================= EXCEL ================= */
window.exportExcel=async()=>{
 const today=new Date().toISOString().split('T')[0];
 const s=await get(ref(db,'attendance/'+today));
 if(!s.exists()) return;

 const arr=[];
 s.forEach(c=>arr.push(c.val()));

 const ws=XLSX.utils.json_to_sheet(arr);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Attendance");
 XLSX.writeFile(wb,"attendance.xlsx");
};

/* ================= QR ================= */
window.genQR=()=>{
 const canvas=document.getElementById("qr");
 const ctx=canvas.getContext("2d");
 canvas.width=200;
 canvas.height=200;
 ctx.fillRect(0,0,200,200);
 ctx.fillStyle="#fff";
 ctx.fillText("OXU QR ACTIVE",30,100);
};

</script>
</body>
</html>
