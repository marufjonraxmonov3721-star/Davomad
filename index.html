<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGate Pro: Face ID Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --tg-color: #248b65; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; overflow-x: hidden; }
        .container { padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .card { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; box-sizing: border-box; }
        
        /* Bank uslubidagi Face ID doirasi */
        .face-scanner-container { position: relative; width: 260px; height: 260px; margin: 20px auto; border-radius: 50%; border: 4px solid #ddd; overflow: hidden; background: #000; }
        #webcam { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 8px solid transparent; border-top-color: var(--tg-color); border-radius: 50%; animation: rotate 2s linear infinite; display: none; }
        
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .instruction { font-size: 16px; font-weight: bold; color: #333; margin: 15px 0; min-height: 24px; }
        .hidden { display: none; }
        button { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-main { background: var(--tg-color); color: white; }
        .success-mark { color: var(--tg-color); font-size: 50px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="face-auth-view" class="card">
        <h2 style="margin-top: 0;">Face ID Tasdiqlash</h2>
        <p style="font-size: 13px; color: #666;">Bank darajasidagi xavfsizlik tizimi</p>
        
        <div class="face-scanner-container">
            <video id="webcam" autoplay playsinline muted></video>
            <div id="scan-line" class="scan-overlay"></div>
            <div id="success-icon" class="success-mark">‚úì</div>
        </div>

        <div id="instruction-text" class="instruction">AI yuklanmoqda...</div>
        <p id="progress-text" style="font-size: 12px; color: #999;">Kutib turing...</p>

        <div id="registration-form" class="hidden">
            <input type="text" id="full-name" placeholder="Ism Familiya" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
            <button class="btn-main" onclick="completeRegistration()">Ro'yxatdan o'tishni yakunlash</button>
        </div>
    </div>

    <div id="main-dashboard" class="card hidden">
        <h3 id="user-name">Xush kelibsiz</h3>
        <p>Siz tizimdan muvaffaqiyatli o'tdingiz</p>
        <div style="font-size: 60px;">üè¢</div>
        <p id="location-status" style="font-size: 12px; color: #666;"></p>
        <button class="btn-main" onclick="checkIn()">Davomatni qayd etish</button>
    </div>
</div>

<script type="module">
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const video = document.getElementById('webcam');
    const instruction = document.getElementById('instruction-text');
    const progress = document.getElementById('progress-text');
    const scanLine = document.getElementById('scan-line');

    let modelsLoaded = false;

    // 1. AI Modellarini yuklash
    async function initFaceID() {
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            
            modelsLoaded = true;
            startVideo();
        } catch (e) {
            instruction.innerText = "AI yuklashda xatolik";
            console.error(e);
        }
    }

    // 2. Kamerani ishga tushirish
    async function startVideo() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
        video.srcObject = stream;
        instruction.innerText = "Yuzingizni doira ichiga keltiring";
        scanLine.style.display = 'block';
        detectFace();
    }

    // 3. Jonli yuz tahlili (Bank darajasida)
    async function detectFace() {
        if (!modelsLoaded) return;

        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceExpressions();

        if (detections) {
            const landmarks = detections.landmarks;
            const jawOutline = landmarks.getJawOutline();
            
            // Tiriklikni tekshirish (Masalan, foydalanuvchi jilmayishi kerak)
            if (detections.expressions.happy > 0.7) {
                successAuth();
            } else {
                instruction.innerText = "Iltimos, jilmaying (Tiriklikni tekshirish)";
                progress.innerText = "AI sizning haqiqiy shaxs ekanligingizni tekshirmoqda";
            }
        } else {
            instruction.innerText = "Yuz topilmadi";
        }

        if (modelsLoaded) requestAnimationFrame(detectFace);
    }

    function successAuth() {
        modelsLoaded = false; // To'xtatish
        scanLine.style.display = 'none';
        video.style.opacity = '0.3';
        document.getElementById('success-icon').style.display = 'block';
        instruction.innerText = "Face ID tasdiqlandi! ‚úÖ";
        tg.HapticFeedback.notificationOccurred('success');
        
        setTimeout(() => {
            document.getElementById('face-auth-view').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            // Bu yerda Firebase bilan ishlash mantiqi davom etadi...
        }, 1500);
    }

    // GPS tekshiruvi (Osiyo Xalqaro Universiteti)
    window.checkIn = function() {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            // 39.800911, 64.426838 (Universitet nuqtasi)
            document.getElementById('location-status').innerText = "Lokatsiya: " + lat.toFixed(4) + ", " + lon.toFixed(4);
            tg.showAlert("Davomat saqlandi!");
        });
    };

    initFaceID();
</script>
</body>
</html>
