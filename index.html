<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGate: Limitsiz Tizim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-color: #248b65; --accent: #0088cc; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        .form-group { text-align: left; margin-bottom: 15px; }
        label { display: block; font-size: 13px; margin-bottom: 5px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-reg { background: var(--accent); color: white; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color: var(--accent);">Ro'yxatdan o'tish</h2>
    <p style="font-size: 13px; color: #888; margin-bottom: 20px;">Email orqali limitsiz ro'yxatdan o'ting</p>

    <div id="reg-form">
        <div class="form-group"><label>Ism</label><input type="text" id="reg-name" placeholder="Masalan: Maruf"></div>
        <div class="form-group"><label>Familiya</label><input type="text" id="reg-surname" placeholder="Masalan: Raxmonov"></div>
        <div class="form-group"><label>Otasining ismi</label><input type="text" id="reg-patronymic" placeholder="Masalan: Akmalovich"></div>
        <div class="form-group"><label>Gmail / Email</label><input type="email" id="reg-email" placeholder="example@gmail.com"></div>
        <div class="form-group"><label>Parol (kamida 6 ta belgi)</label><input type="password" id="reg-password" placeholder="******"></div>
        
        <button class="btn-reg" onclick="handleEmailReg()">Ro'yxatdan o'tish</button>
    </div>

    <div id="main-panel" class="hidden">
        <h3 id="user-title">Xush kelibsiz!</h3>
        <p>Siz muvaffaqiyatli ro'yxatdan o'tdingiz.</p>
        <button style="background: var(--tg-color); color: white;" onclick="location.reload()">Asosiy sahifaga o'tish</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;

    const tid = tg.initDataUnsafe.user?.id || "test_id";

    // Tekshirish: Agar foydalanuvchi allaqachon ro'yxatdan o'tgan bo'lsa
    get(ref(db, `users/${tid}`)).then(snap => {
        if(snap.exists()){
            showMain(snap.val());
        }
    });

    window.handleEmailReg = function() {
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const name = document.getElementById('reg-name').value;
        const surname = document.getElementById('reg-surname').value;
        const patronymic = document.getElementById('reg-patronymic').value;

        if(!email || password.length < 6 || !name) {
            tg.showAlert("Iltimos, barcha maydonlarni to'g'ri to'ldiring (Parol min. 6 ta belgi)");
            return;
        }

        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                const userData = {
                    name, surname, patronymic, email, 
                    role: "student",
                    verified: true
                };
                
                // Telegram ID bo'yicha bazaga saqlash
                set(ref(db, `users/${tid}`), userData).then(() => {
                    showMain(userData);
                });
            })
            .catch((error) => {
                tg.showAlert("Xatolik: " + error.message);
            });
    };

    function showMain(data) {
        document.getElementById('reg-form').classList.add('hidden');
        document.getElementById('main-panel').classList.remove('hidden');
        document.getElementById('user-title').innerText = `Assalomu alaykum, ${data.name}!`;
    }
</script>
</body>
</html>
