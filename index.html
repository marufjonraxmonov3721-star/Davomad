<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aql Jangi | Alohida Tizim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --gold: #FFD700; --gold-glow: rgba(255, 215, 0, 0.3);
            --bg: #050505; --card-bg: rgba(25, 25, 25, 0.9);
            --text: #ffffff; --green: #00ff88; --red: #ff4d4d; 
        }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            margin: 0; padding: 0; overflow: hidden; user-select: none;
        }

        /* Sahifalar boshqaruvi */
        .page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box; background: var(--bg); z-index: 10;
        }
        .page.active { display: flex; animation: slideIn 0.4s ease-out; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dizayn elementlari */
        .glass-card {
            background: var(--card-bg); padding: 30px; border-radius: 35px;
            border: 1px solid rgba(255,255,255,0.1); width: 100%; max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6); text-align: center;
        }

        .btn-main {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            border: none; padding: 18px; border-radius: 20px;
            color: #000; font-weight: 800; width: 100%;
            cursor: pointer; text-transform: uppercase; margin-top: 20px;
            box-shadow: 0 5px 15px var(--gold-glow);
        }

        .reg-input {
            width: 100%; padding: 18px; margin-bottom: 15px; border-radius: 18px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);
            color: #fff; font-size: 16px; box-sizing: border-box; outline: none;
        }

        /* O'yin elementlari */
        .color-btn { height: 85px; border-radius: 20px; border: 2px solid #222; cursor: pointer; }
        #color-word { font-size: 45px; font-weight: 900; margin: 20px 0; text-transform: uppercase; }

        /* Pastki Navigatsiya */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: #0a0a0a; display: none; justify-content: space-around;
            align-items: center; border-top: 1px solid #222; z-index: 100;
        }
        .nav-link { color: #666; text-align: center; font-size: 10px; flex: 1; cursor: pointer; }
        .nav-link.active-link { color: var(--gold); }
        .nav-link svg { width: 24px; height: 24px; }
    </style>
</head>
<body>

<div id="page-lang" class="page">
    <div class="glass-card">
        <div style="font-size: 50px; margin-bottom: 10px;">üåç</div>
        <h2 id="lt-lang-title">Tilni tanlang / –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h2>
        <button class="btn-main" onclick="setLang('uz')">O'zbekcha üá∫üáø</button>
        <button class="btn-main" style="margin-top:10px;" onclick="setLang('uz_cyr')">–é–∑–±–µ–∫—á–∞ üá∫üáø</button>
    </div>
</div>

<div id="page-auth" class="page">
    <div class="glass-card">
        <h2 id="lt-auth-title">Ro'yxatdan o'tish</h2>
        <input type="text" id="reg-name" class="reg-input" placeholder="Ismingiz">
        <input type="text" id="reg-surname" class="reg-input" placeholder="Familiyangiz">
        <button class="btn-main" id="lt-auth-btn" onclick="register()">Davom etish</button>
    </div>
</div>

<div id="page-onboarding" class="page">
    <div class="glass-card">
        <h2 id="ob-title" style="color:var(--gold)"></h2>
        <p id="ob-desc" style="font-size: 15px; line-height: 1.6; margin: 20px 0;"></p>
        <button class="btn-main" id="lt-ob-btn" onclick="nextObStep()">Keyingisi</button>
    </div>
</div>

<div id="page-tournament" class="page">
    <div class="glass-card">
        <h2 id="lt-tour-title">Turnir Markazi</h2>
        <p id="tour-status-msg" style="font-weight: bold;"></p>
        <div id="pay-details" style="text-align: left; background: #000; padding: 15px; border-radius: 15px; font-size: 13px; margin: 15px 0; border: 1px dashed var(--gold);">
            <p id="lt-pay-price">üí∞ Kirish: 5 000 so'm</p>
            <p>üí≥ Karta: 4073 4200 6816 5541</p>
            <p>üë§ Ega: Maruf Raxmonov</p>
        </div>
        <div id="p-counter" style="margin-bottom: 10px; opacity: 0.7;">Ishtirokchilar: <b id="p-count">0</b></div>
        <input type="file" id="receipt-input" style="display:none;" onchange="handleReceipt(this)">
        <button class="btn-main" style="background:#222; color:var(--gold);" onclick="document.getElementById('receipt-input').click()" id="lt-upload-btn">Chekni yuklash</button>
        <button class="btn-main" onclick="pay()" id="lt-pay-btn">To'lov qildim</button>
        <button class="btn-main" style="display:none; background:var(--green);" onclick="startTurnir()" id="lt-start-btn">O'yinni boshlash</button>
    </div>
</div>

<div id="page-game" class="page" style="justify-content: flex-start; padding-top: 40px;">
    <div class="glass-card">
        <div style="display:flex; justify-content:space-between; font-size: 14px;">
            <span><b id="round-idx">1</b>/30</span>
            <span style="color:var(--gold)"><b id="game-score">0</b> PTS</span>
        </div>
        <div style="background:rgba(255,255,255,0.1); height:4px; margin:15px 0; border-radius:2px;">
            <div id="timer-bar" style="height:100%; width:100%; background:var(--gold); transition:linear;"></div>
        </div>
        <div id="color-word">...</div>
        <div id="color-options" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
    </div>
</div>

<div id="page-leaderboard" class="page">
    <h2 style="color:var(--gold)">üèÜ REYTING</h2>
    <div id="rank-list" class="glass-card" style="padding: 10px; max-height: 70vh; overflow-y: auto;"></div>
</div>

<div id="page-settings" class="page">
    <div class="glass-card">
        <h2 id="lt-settings-title">Sozlamalar</h2>
        <button class="btn-main" style="background:#333;" onclick="showPage('page-lang')">Tilni o'zgartirish</button>
        <button class="btn-main" style="background:var(--red);" onclick="logout()">Tizimdan chiqish</button>
    </div>
</div>

<div class="bottom-nav" id="navbar">
    <div class="nav-link" onclick="navigate('tournament')" id="nav-tour">‚öîÔ∏è<br>Turnir</div>
    <div class="nav-link" onclick="navigate('leaderboard')" id="nav-rank">üèÜ<br>Reyting</div>
    <div class="nav-link" onclick="navigate('settings')" id="nav-sett">‚öôÔ∏è<br>Sozlamalar</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI", authDomain: "gen-lang-client-0228947349.firebaseapp.com", databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com", projectId: "gen-lang-client-0228947349", appId: "1:253793341504:web:709752258000dab44fcfa5" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id ? "u" + tg.initDataUnsafe.user.id : "test_user";
    const userRef = ref(db, 'brain_users/' + uid);

    let userData = { lang: 'uz' };
    let obStep = 0, currentScore = 0, currentRound = 1, timerInt, receiptData = null;

    const colors = [
        { uz: "QIZIL", kir: "“ö–ò–ó–ò–õ", val: "#ff3b3b" },
        { uz: "YASHIL", kir: "–Ø–®–ò–õ", val: "#00ff88" },
        { uz: "KO'K", kir: "–ö–é–ö", val: "#007bff" },
        { uz: "SARIQ", kir: "–°–ê–†–ò“ö", val: "#FFD700" },
        { uz: "OQ", kir: "–û“ö", val: "#ffffff" }
    ];

    const trans = {
        uz: {
            authT: "Ro'yxatdan o'tish", authB: "Davom etish", tourT: "Turnir Markazi", payP: "üí∞ Kirish: 5 000 so'm", upload: "Chekni yuklash", payB: "To'lov qildim", startB: "O'yinni boshlash", settT: "Sozlamalar",
            ob: [
                { t: "Xush kelibsiz!", d: "Aql Jangi ‚Äî bu tezkorlik turniri. Kirish narxi: 5 000 so'm." },
                { t: "Qoida", d: "So'zni o'qimang, so'z qaysi RANGDA yozilgan bo'lsa, o'sha rangni tanlang!" },
                { t: "Sovrinlar", d: "ü•á 80k, ü•à 50k, ü•â 20k so'm. Omad!" }
            ]
        },
        uz_cyr: {
            authT: "–†—û–π—Ö–∞—Ç–¥–∞–Ω —û—Ç–∏—à", authB: "–î–∞–≤–æ–º —ç—Ç–∏—à", tourT: "–¢—É—Ä–Ω–∏—Ä –ú–∞—Ä–∫–∞–∑–∏", payP: "üí∞ –ö–∏—Ä–∏—à: 5 000 —Å—û–º", upload: "–ß–µ–∫–Ω–∏ —é–∫–ª–∞—à", payB: "–¢—û–ª–æ–≤ “õ–∏–ª–¥–∏–º", startB: "–é–π–∏–Ω–Ω–∏ –±–æ—à–ª–∞—à", settT: "–°–æ–∑–ª–∞–º–∞–ª–∞—Ä",
            ob: [
                { t: "–•—É—à –∫–µ–ª–∏–±—Å–∏–∑!", d: "–ê“õ–ª –ñ–∞–Ω–≥–∏ ‚Äî –±—É —Ç–µ–∑–∫–æ—Ä–ª–∏–∫ —Ç—É—Ä–Ω–∏—Ä–∏. –ö–∏—Ä–∏—à –Ω–∞—Ä—Ö–∏: 5 000 —Å—û–º." },
                { t: "“ö–æ–∏–¥–∞", d: "–°—û–∑–Ω–∏ —û“õ–∏–º–∞–Ω–≥, —Å—û–∑ “õ–∞–π—Å–∏ –†–ê–ù–ì–î–ê —ë–∑–∏–ª–≥–∞–Ω –±—û–ª—Å–∞, —û—à–∞ —Ä–∞–Ω–≥ni —Ç–∞–Ω–ª–∞–Ω–≥!" },
                { t: "–°–æ–≤—Ä–∏–Ω–ª–∞—Ä", d: "ü•á 80–∫, ü•à 50–∫, ü•â 20–∫ —Å—û–º. –û–º–∞–¥!" }
            ]
        }
    };

    window.showPage = (id) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('navbar').style.display = (id.includes('tournament') || id.includes('leaderboard') || id.includes('settings')) ? 'flex' : 'none';
    };

    window.setLang = (l) => {
        userData.lang = l;
        const t = trans[l];
        document.getElementById('lt-auth-title').innerText = t.authT;
        document.getElementById('lt-auth-btn').innerText = t.authB;
        document.getElementById('lt-tour-title').innerText = t.tourT;
        document.getElementById('lt-pay-price').innerText = t.payP;
        document.getElementById('lt-upload-btn').innerText = t.upload;
        document.getElementById('lt-pay-btn').innerText = t.payB;
        document.getElementById('lt-start-btn').innerText = t.startB;
        document.getElementById('lt-settings-title').innerText = t.settT;
        showPage('page-auth');
    };

    window.register = async () => {
        const n = document.getElementById('reg-name').value, s = document.getElementById('reg-surname').value;
        if(!n || !s) return alert("To'ldiring!");
        userData.name = n; userData.surname = s; userData.tourStatus = "none";
        await set(userRef, userData);
        showPage('page-onboarding'); showObStep();
    };

    function showObStep() {
        const t = trans[userData.lang].ob[obStep];
        document.getElementById('ob-title').innerText = t.t;
        document.getElementById('ob-desc').innerText = t.d;
    }

    window.nextObStep = () => { obStep < 2 ? (obStep++, showObStep()) : navigate('tournament'); };

    window.handleReceipt = (i) => { 
        const r = new FileReader(); r.onload=(e)=>receiptData=e.target.result; r.readAsDataURL(i.files[0]); 
    };

    window.pay = async () => {
        if(!receiptData) return alert("Chekni yuklang!");
        await update(userRef, { tourStatus: "pending", paymentReceipt: receiptData });
        alert("Yuborildi!"); loadTourStatus();
    };

    async function loadTourStatus() {
        const snap = await get(userRef); userData = snap.val();
        onValue(ref(db, 'brain_users'), (s) => {
            let count = 0; s.forEach(u => u.val().tourStatus === 'active' && count++);
            document.getElementById('p-count').innerText = count;
            if(userData.tourStatus === 'active') {
                document.getElementById('lt-start-btn').style.display='block';
                document.getElementById('lt-pay-btn').style.display='none';
                document.getElementById('lt-upload-btn').style.display='none';
                document.getElementById('pay-details').style.display='none';
            }
        });
        document.getElementById('tour-status-msg').innerText = userData.tourStatus === 'pending' ? "Tekshirilmoqda..." : (userData.tourStatus === 'active' ? "Siz turnirdasiz!" : "To'lov qiling");
    }

    window.startTurnir = () => { currentScore = 0; currentRound = 1; showPage('page-game'); nextRound(); };

    function nextRound() {
        if(currentRound > 30) return finish();
        document.getElementById('round-idx').innerText = currentRound;
        document.getElementById('game-score').innerText = currentScore;
        const correct = colors[Math.floor(Math.random()*colors.length)];
        const text = colors[Math.floor(Math.random()*colors.length)];
        const word = document.getElementById('color-word');
        word.innerText = userData.lang === 'uz' ? text.uz : text.kir;
        word.style.color = correct.val;
        const box = document.getElementById('color-options'); box.innerHTML = "";
        [...colors].sort(()=>Math.random()-0.5).forEach(c => {
            const b = document.createElement('div'); b.className = "color-btn"; b.style.backgroundColor = c.val;
            b.onclick = () => { clearInterval(timerInt); if(c.val === correct.val) currentScore += 10; currentRound++; nextRound(); };
            box.appendChild(b);
        });
        let limit = Math.max(0.7, 2.5 - (currentRound * 0.05));
        const bar = document.getElementById('timer-bar'); bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { bar.style.transition = `width ${limit}s linear`; bar.style.width = '0%'; }, 50);
        timerInt = setTimeout(() => { currentRound++; nextRound(); }, limit * 1000);
    }

    async function finish() {
        await update(userRef, { totalPoints: currentScore, tourStatus: "done" });
        document.getElementById('final-score').innerText = currentScore;
        showPage('result-screen');
    }

    window.navigate = (id) => {
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-link'));
        document.getElementById('nav-' + id.substring(0,4)).classList.add('active-link');
        if(id === 'tournament') loadTourStatus();
        if(id === 'leaderboard') fetchRank();
        showPage('page-' + id);
    };

    async function fetchRank() {
        const snap = await get(ref(db, 'brain_users'));
        let html = ""; let list = []; snap.forEach(u => u.val().tourStatus === 'done' && list.push(u.val()));
        list.sort((a,b) => b.totalPoints - a.totalPoints).forEach((u, i) => {
            html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;"><span>${i+1}. ${u.name}</span><b>${u.totalPoints}</b></div>`;
        });
        document.getElementById('rank-list').innerHTML = html || "Hali natijalar yo'q";
    }

    window.logout = async () => { if(confirm("Chiqasizmi?")) { await remove(userRef); location.reload(); } };

    window.onload = async () => {
        const snap = await get(userRef);
        document.getElementById('page-lang').style.display = 'none';
        if(snap.exists() && snap.val().name) { userData = snap.val(); navigate('tournament'); }
        else { showPage('page-lang'); }
    };
</script>
</body>
</html>
