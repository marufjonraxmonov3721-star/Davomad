<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yakuniyga tayyorlovchi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #ffffff; --text: #ff0000; --card: #ffffff; --nav-bg: #ffffff; --accent: #ff0000; }
        [data-theme="dark"] { --bg: #000000; --text: #ffd700; --card: #000000; --nav-bg: #000000; --accent: #ffd700; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; transition: 0.3s; }
        .container { padding: 20px; max-width: 600px; margin: auto; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--nav-bg); display: flex; justify-content: space-around; padding: 15px 0; border-top: 2px solid var(--accent); z-index: 1000; }
        .nav-item { text-align: center; font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: var(--accent); }
        .header { text-align: center; font-weight: 800; font-size: 22px; padding: 25px 0; text-transform: uppercase; }
        .card { background: var(--card); border: 2px solid var(--accent); padding: 20px; margin-bottom: 15px; border-radius: 12px; cursor: pointer; text-align: center; font-weight: 800; }
        #quiz-screen, #errors-screen, #settings-screen, #mode-screen, #result-screen, #payment-screen { display: none; }
        .timer-display { text-align: center; font-size: 42px; font-weight: 900; margin-bottom: 15px; color: var(--accent); display: block; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .mode-title { text-align: center; font-size: 20px; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; opacity: 0.8; }
        .question-text { font-size: 19px; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }
        .option { border: 2px solid var(--accent); padding: 16px; margin: 12px 0; border-radius: 14px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .correct { background: #22c55e !important; color: white !important; border-color: #22c55e; }
        .wrong { background: #ef4444 !important; color: white !important; border-color: #ef4444; }
        .mode-btn { width: 100%; padding: 20px; margin: 10px 0; border: 2px solid var(--accent); background: transparent; color: var(--text); font-weight: 800; border-radius: 12px; cursor: pointer; font-size: 16px; text-transform: uppercase; }
        .theme-btn { width: 100%; padding: 18px; margin: 10px 0; border: 2px solid var(--accent); background: transparent; color: var(--text); font-weight: 800; border-radius: 10px; cursor: pointer; }
        .result-container, .payment-container { background: var(--card); border: 4px solid var(--accent); padding: 40px 20px; border-radius: 25px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .big-score { font-size: 60px; font-weight: 900; margin: 20px 0; }
        .promo-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid var(--accent); background: transparent; color: var(--text); border-radius: 10px; text-align: center; font-weight: 800; font-size: 18px; box-sizing: border-box; }
    </style>
</head>
<body data-theme="dark">

<div class="container">
    <div id="home-screen"><div class="header">Yakuniyga tayyorlovchi</div><div id="loader" style="text-align:center;">Yuklanmoqda...</div><div id="subjects-list"></div></div>
    <div id="mode-screen"><div class="header" id="mode-subject-name">FAN NOMI</div><button class="mode-btn" onclick="startQuizProcess('practice')">üìñ MASHQ QILISH</button><button class="mode-btn" onclick="startQuizProcess('exam')">‚è± IMTIHON (35 SAVOL)</button><button class="theme-btn" onclick="showScreen('home')">ORQAGA</button></div>
    <div id="quiz-screen"><div id="timer-box" class="timer-display">35:00</div><div id="quiz-label" class="mode-title">MASHQ</div><div id="question-box" class="question-text"></div><div id="options-box"></div></div>
    <div id="result-screen"><div class="result-container"><h1 id="res-status">NATIJA</h1><div id="res-score" class="big-score">0/70</div><p id="res-info" style="font-size: 18px; font-weight: bold;"></p><button class="mode-btn" onclick="showScreen('home')">YANA BOSHLASH</button></div></div>
    <div id="payment-screen">
        <div class="payment-container">
            <h1>FANNI OCHISH</h1><p>Barcha savollar uchun <b>10 000 so'm</b> to'lov qiling.</p>
            <div style="border: 2px dashed var(--accent); padding: 10px; border-radius: 10px; margin: 10px 0;"><p style="color: var(--accent); font-size: 20px; font-weight: 900; margin: 5px 0;">4073 4200 6816 5541</p><p style="margin: 0; font-weight: 700;">Maruf Raxmonov</p></div>
            <button class="mode-btn" style="background: #0088cc; color: white; border: none; padding: 12px;" onclick="sendReceipt()">Chekni Botga yuborish</button>
            <hr style="border: 1px solid var(--accent); opacity: 0.3; margin: 15px 0;"><p>Faqat ushbu fan uchun kodingizni kiriting:</p>
            <input type="text" id="promoCodeInput" class="promo-input" placeholder="PROMO KOD">
            <button class="mode-btn" onclick="checkPromoCode()">TASDIQLASH</button><button class="theme-btn" onclick="showScreen('home')">ORQAGA</button>
        </div>
    </div>
    <div id="errors-screen"><div class="header">Xatolar Ustida Ishlash</div><div id="errors-list"></div><button class="theme-btn" onclick="clearErrors()" style="margin-top: 20px;">TOZALASH</button></div>
    <div id="settings-screen">
        <div class="header">Sozlamalar</div>
        <button class="theme-btn" onclick="setTheme('light')">KUNDUZGI (OQ/QIZIL)</button>
        <button class="theme-btn" onclick="setTheme('dark')">TUNGI (QORA/TILLA)</button>
        <button class="mode-btn" style="background: #ef4444; color: white; border: none; margin-top: 40px;" onclick="logoutSystem()">üö™ TIZIMDAN CHIQISH</button>
    </div>
</div>

<div class="bottom-nav"><div class="nav-item" onclick="showScreen('home')">üè†<br>Fanlar</div><div class="nav-item" onclick="showScreen('errors')">‚ùå<br>Xatolar</div><div class="nav-item" onclick="showScreen('settings')">‚öôÔ∏è<br>Sozlamalar</div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
    authDomain: "gen-lang-client-0228947349.firebaseapp.com",
    databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
    projectId: "gen-lang-client-0228947349",
    storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
    messagingSenderId: "253793341504",
    appId: "1:253793341504:web:709752258000dab44fcfa5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allData = {}, currentSet = [], activeSub = "", idx = 0, mode = "", countdownInterval = null, points = 0, corrects = 0, totalSeconds = 0;

window.showScreen = (name) => {
    if(name !== 'quiz' && countdownInterval){ clearInterval(countdownInterval); countdownInterval=null; }
    ['home','mode','quiz','errors','settings','result','payment'].forEach(s=>{ const e=document.getElementById(s+'-screen'); if(e) e.style.display='none'; });
    document.getElementById(name+'-screen').style.display='block';
};

onValue(ref(db,'questions'), (snap)=>{ if(snap.exists()){ allData=snap.val(); document.getElementById('loader').style.display='none'; renderList(); } });

function isSubjectPaid(subName) { return (JSON.parse(localStorage.getItem('paid_subjects')) || []).includes(subName); }

function renderList(){
    const list=document.getElementById('subjects-list'); list.innerHTML="";
    Object.keys(allData).forEach(s=>{
        const c=document.createElement('div'); c.className='card';
        c.innerHTML=`<strong>${s.toUpperCase()}</strong><br><small>${isSubjectPaid(s) ? "‚úÖ OCHILGAN" : "üîì SINOV (5 TA SAVOL)"}</small>`;
        c.onclick=()=>{ activeSub=s; document.getElementById('mode-subject-name').innerText=s.toUpperCase(); showScreen('mode'); };
        list.appendChild(c);
    });
}

window.startQuizProcess=(m)=>{
    mode=m; idx=0; points=0; corrects=0;
    const src=allData[activeSub], isPaid = isSubjectPaid(activeSub), timerEl=document.getElementById('timer-box');
    if(m==='exam'){
        const tempSet = [...src].sort(()=>Math.random()-0.5);
        currentSet = isPaid ? tempSet.slice(0,35) : tempSet.slice(0, 5);
        timerEl.style.display='block'; totalSeconds = 35*60; updateTimer(timerEl);
        if(countdownInterval) clearInterval(countdownInterval);
        countdownInterval=setInterval(()=>{ totalSeconds--; updateTimer(timerEl); if(totalSeconds<=0){ clearInterval(countdownInterval); endQuiz(); } },1000);
    }else{ currentSet = isPaid ? [...src] : src.slice(0, 5); timerEl.style.display='none'; }
    showScreen('quiz'); renderQ();
};

function updateTimer(el){ let mins=Math.floor(totalSeconds/60), secs=totalSeconds%60; el.innerText=`${mins}:${secs<10?'0'+secs:secs}`; }

function renderQ(){
    if(idx>=currentSet.length){ if(!isSubjectPaid(activeSub)) showScreen('payment'); else mode==='exam'?endQuiz():showScreen('home'); return; }
    const q=currentSet[idx]; document.getElementById('question-box').innerHTML=`${idx+1}. ${q.question}`;
    const box=document.getElementById('options-box'); box.innerHTML="";
    const opts=[{t:q.options.A,c:true},{t:q.options.B,c:false},{t:q.options.C,c:false},{t:q.options.D,c:false}].sort(()=>Math.random()-0.5);
    opts.forEach(o=>{
        const d=document.createElement('div'); d.className='option'; d.innerHTML=o.t;
        d.onclick=()=>{
            const btns=box.querySelectorAll('.option'); btns.forEach(b=>b.style.pointerEvents='none');
            if(mode==='practice'){
                if(o.c) d.classList.add('correct');
                else { d.classList.add('wrong'); btns.forEach(b=>{ if(opts.find(opt=>opt.t===b.innerHTML && opt.c)) b.classList.add('correct'); }); saveX(q,activeSub); }
            } else { if(o.c){ corrects++; points+=2; } else saveX(q,activeSub); d.style.borderColor="var(--text)"; d.style.backgroundColor="rgba(255,255,255,0.1)"; }
            setTimeout(()=>{ idx++; renderQ(); }, 600);
        };
        box.appendChild(d);
    });
}

window.sendReceipt = () => {
    const text = `Men "${activeSub.toUpperCase()}" fani uchun to'lov qildim. Mana chek ilova qilinmoqda.`;
    window.open(`https://t.me/Yakuniyga_tayyorlovchi_bot?text=${encodeURIComponent(text)}`);
};

window.checkPromoCode = () => {
    const code = document.getElementById('promoCodeInput').value.trim().toUpperCase();
    const sub = activeSub.toLowerCase();
    let subPrefix = "FAN";

    // Bazadagi 5 ta fan uchun prefixlar
    if (sub.includes("dinshunoslik")) subPrefix = "DIN";
    else if (sub.includes("fizika")) subPrefix = "FIZ";
    else if (sub.includes("oliy matematika")) subPrefix = "MAT";
    else if (sub.includes("texnik_tizimlarda_akt")) subPrefix = "AKT";
    else if (sub.includes("yo'nalishga kirish")) subPrefix = "YON";

    let usedCodes = JSON.parse(localStorage.getItem('used_promos')) || [];

    // Tekshirish: Kod aynan shu fan prefixi bilan boshlanadimi va ishlatilmaganmi
    if(code.startsWith(subPrefix + '_YK') && code.length === 10 && !usedCodes.includes(code)) {
        let paid = JSON.parse(localStorage.getItem('paid_subjects')) || [];
        if(!paid.includes(activeSub)) {
            paid.push(activeSub);
            localStorage.setItem('paid_subjects', JSON.stringify(paid));
            usedCodes.push(code);
            localStorage.setItem('used_promos', JSON.stringify(usedCodes));
            alert("Fan muvaffaqiyatli ochildi! ‚úÖ");
            renderList(); showScreen('home');
        } else { alert("Bu fan allaqachon ochilgan."); }
    } else if (usedCodes.includes(code)) {
        alert("Bu promo-kod allaqachon ishlatilgan! ‚ùå");
    } else {
        alert("Xato! Bu kod boshqa fan uchun yoki noto'g'ri. ‚ùå");
    }
};

window.logoutSystem = () => {
    if(confirm("Tizimdan chiqilsa barcha ochilgan fanlar va xatolar butunlay o'chib ketadi. Rozimisiz?")) {
        localStorage.clear();
        location.reload();
    }
};

function endQuiz(){
    if(countdownInterval) clearInterval(countdownInterval);
    const st=document.getElementById('res-status'), sc=document.getElementById('res-score');
    sc.innerText=`${points}/70`; document.getElementById('res-info').innerText=`To'g'ri javoblar: ${corrects}/35`;
    if(points>=42){ st.innerText="MUVAFFAQIYATLI!"; st.style.color="#22c55e"; }
    else{ st.innerText="YIQILDINGIZ!"; st.style.color="#ef4444"; }
    showScreen('result');
}

function saveX(q,s){
    let x=JSON.parse(localStorage.getItem('xatolar'))||[];
    if(!x.find(i=>i.question===q.question)){ x.push({...q,sub:s}); localStorage.setItem('xatolar',JSON.stringify(x)); }
}

function renderErrors(){
    const list=document.getElementById('errors-list'), x=JSON.parse(localStorage.getItem('xatolar'))||[];
    list.innerHTML=x.length?"":"<p style='text-align:center'>Xatolar yo'q.</p>";
    x.forEach(e=>{
        list.innerHTML+=`<div class="card" style="text-align:left; font-weight:normal;"><span style="font-size:10px; background:var(--accent); color:var(--bg); padding:2px 5px; border-radius:3px; text-transform:uppercase;">${e.sub}</span><br><p>${e.question}</p><p style="color:#22c55e"><b>To'g'ri javob:</b> ${e.options.A}</p></div>`;
    });
}

window.clearErrors=()=>{ localStorage.removeItem('xatolar'); renderErrors(); };
window.setTheme=(t)=>{ document.body.setAttribute('data-theme',t); localStorage.setItem('theme',t); };
setTheme(localStorage.getItem('theme')||'dark');
</script>
</body>
</html>
