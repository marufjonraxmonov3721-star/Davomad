<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro: Volume Fade</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #000; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        
        .main-app { height: 100vh; display: flex; flex-direction: column; }
        video { width: 100%; flex-grow: 1; background: #000; }

        .purple-bar { 
            background: linear-gradient(135deg, var(--p), #4b0082); 
            padding: 15px; text-align: center; border-top: 1px solid #333;
        }
        
        .btn-tg { 
            background: #fff; color: #000; border: none; padding: 15px; 
            border-radius: 12px; font-weight: bold; width: 85%; cursor: pointer;
        }

        .volume-indicator {
            height: 4px; background: rgba(255,255,255,0.2); margin-top: 10px; border-radius: 2px; overflow: hidden;
        }
        #v-bar { height: 100%; background: #00ff00; width: 100%; transition: width 0.5s; }
        
        #status-text { font-size: 11px; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div id="setup" style="display: flex; height: 100vh; justify-content: center; align-items: center; flex-direction: column; padding: 20px; text-align: center;">
    <h1 style="color: var(--p);">ðŸŽ¬ KINO PRO</h1>
    <p>Ovoz pasayishi orqali uyqu nazorati (5s test)</p>
    <button class="btn-tg" onclick="document.getElementById('f').click()">KINO TANLASH</button>
    <input type="file" id="f" hidden accept="video/*" onchange="startApp(event)">
</div>

<div id="player-ui" class="main-app" style="display: none;">
    <video id="v" controls playsinline></video>
    
    <div class="purple-bar" onclick="resetVolume()">
        <span id="status-text">Ovoz nazorati: Faol âœ…</span>
        <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold;">
            <span>Hozirgi ovoz balandligi:</span>
            <span id="v-num">100%</span>
        </div>
        <div class="volume-indicator">
            <div id="v-bar"></div>
        </div>
        <p style="font-size: 10px; margin-top: 8px; opacity: 0.8;">Ovoz pasaysa, ekranga bosing!</p>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const v = document.getElementById('v');
    const vBar = document.getElementById('v-bar');
    const vNum = document.getElementById('v-num');
    const statusText = document.getElementById('status-text');
    
    let fadeTimer;
    let currentVolume = 1.0;

    function startApp(e) {
        const file = e.target.files[0];
        if(!file) return;

        v.src = URL.createObjectURL(file);
        document.getElementById('setup').style.display = 'none';
        document.getElementById('player-ui').style.display = 'flex';
        
        // Saqlangan joyidan davom etish
        const saved = localStorage.getItem("kino_" + file.name);
        if(saved) v.currentTime = saved;

        v.play();
        startFadeLogic();
    }

    // Har 5 soniyada ovozni pasaytirish mantiqi
    function startFadeLogic() {
        fadeTimer = setInterval(() => {
            if (v.paused) return;

            currentVolume -= 0.1; // 10% ga pasaytirish
            if (currentVolume < 0) currentVolume = 0;

            v.volume = currentVolume;
            updateUI();

            // Agar ovoz nolga tushsa va foydalanuvchi uxlab qolgan bo'lsa
            if (currentVolume <= 0) {
                clearInterval(fadeTimer);
                v.pause();
                alert("Ovoz pasayishiga reaksiya bermadingiz. Video to'xtatildi.");
                tg.close(); // Telegram Web Appni yopish
            }
        }, 5000); // 5 soniya (test uchun)
    }

    function resetVolume() {
        currentVolume = 1.0;
        v.volume = 1.0;
        updateUI();
        statusText.innerText = "Ovoz tiklandi! âœ…";
        statusText.style.color = "#00ff00";
        setTimeout(() => { 
            statusText.innerText = "Ovoz nazorati: Faol âœ…"; 
            statusText.style.color = "white";
        }, 2000);
    }

    function updateUI() {
        const percent = Math.round(currentVolume * 100);
        vBar.style.width = percent + "%";
        vNum.innerText = percent + "%";
        
        // Rangni o'zgartirish (ogohlantirish uchun)
        if (percent < 40) vBar.style.background = "red";
        else if (percent < 70) vBar.style.background = "yellow";
        else vBar.style.background = "#00ff00";
    }

    // Videoga teginilganda ham ovozni tiklash
    v.addEventListener('mousedown', resetVolume);
    v.addEventListener('touchstart', resetVolume);

    // Progresni saqlash
    setInterval(() => {
        if(!v.paused) localStorage.setItem("kino_" + v.src, v.currentTime);
    }, 5000);
</script>
</body>
</html>
