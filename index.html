<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Aql Jangi | Xavfsiz Tizim</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #FFD700; --gold-dark: #B8860B; --bg: #000000; --card: #0a0a0a; --text: #FFD700; --green: #28a745; --red: #ff3b3b; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; min-height: 100vh; box-sizing: border-box; }
        #auth, #onboarding, #tournament, #game, #leaderboard, #settings, #result-screen { display: none; text-align: center; }
        .active { display: block !important; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .reg-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--gold-dark); background: #000; color: #fff; font-size: 16px; box-sizing: border-box; outline: none; }
        .btn-main { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); border: none; padding: 18px; border-radius: 15px; color: #000; font-weight: bold; width: 100%; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-main:active { transform: scale(0.97); opacity: 0.9; }
        .quiz-card { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid #222; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #222; z-index: 1000; }
        .nav-link { font-size: 11px; opacity: 0.5; cursor: pointer; text-align: center; color: var(--gold); flex: 1; transition: 0.3s; }
        .nav-link.active-link { opacity: 1; font-weight: bold; transform: translateY(-2px); }
        #color-word { font-size: 42px; font-weight: 900; margin: 25px 0; text-transform: uppercase; height: 50px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .color-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .color-btn { height: 75px; border-radius: 18px; border: 2px solid #222; cursor: pointer; transition: 0.15s; position: relative; overflow: hidden; }
        .timer-bar-container { background: #111; height: 8px; border-radius: 4px; margin: 15px 0; overflow: hidden; border: 1px solid #222; }
        #timer-bar { height: 100%; width: 100%; background: var(--gold); transition: linear; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:40px; height:40px; border:4px solid #111; border-top:4px solid var(--gold); border-radius:50%; animation:rotate 0.8s linear infinite;"></div>
</div>

<div class="container">
    <div id="auth">
        <h1 style="font-size: 36px; margin-top: 30px;">Aql Jangi</h1>
        <p id="txt-app-slogan" style="opacity: 0.7;">Xavfsiz Turnir Platformasi</p>
        <select id="reg-lang" class="reg-input" onchange="window.switchLang(this.value)">
            <option value="uz">O'zbekcha üá∫üáø</option>
            <option value="uz_cyr">–é–∑–±–µ–∫—á–∞ üá∫üáø</option>
        </select>
        <input type="text" id="reg-name" class="reg-input" maxlength="20" placeholder="Ismingiz">
        <input type="text" id="reg-surname" class="reg-input" maxlength="20" placeholder="Familiyangiz">
        <button class="btn-main" id="btn-next" onclick="register()">DAVOM ETISH</button>
    </div>

    <div id="onboarding">
        <div class="quiz-card">
            <h2 id="ob-title" style="color:var(--gold)"></h2>
            <p id="ob-desc" style="color:#fff; font-size: 15px; opacity: 0.9; white-space: pre-line;"></p>
            <button class="btn-main" id="btn-ob-next" onclick="nextObStep()">KEYINGISI</button>
        </div>
    </div>

    <div id="tournament">
        <h2 id="txt-tour-title" style="color:var(--gold)">‚öîÔ∏è TURNIR MARKAZI</h2>
        <div class="quiz-card">
            <p id="tour-status-msg" style="font-weight:bold;"></p>
            <div style="margin:15px 0; background:#050505; padding:15px; border-radius:15px; border:1px dashed #333; text-align:left;">
                <p id="txt-pay-info">üí∞ Kirish: <b>5 000 so'm</b></p>
                <p>üí≥ Karta: <code>4073 4200 6816 5541</code></p>
                <p>üë§ Ega: <b>Maruf Raxmonov</b></p>
            </div>
            <div style="margin-bottom:15px; font-size: 14px; opacity: 0.8;">
                <span id="txt-p-label">Ishtirokchilar:</span> <b id="p-count">0</b>
            </div>
            <input type="file" id="receipt-input" accept="image/jpeg,image/png" style="display:none;" onchange="handleReceipt(this)">
            <button class="btn-main" id="btn-upload" style="background:#111; color:var(--gold); border:1px solid #222; margin-bottom:10px;" onclick="document.getElementById('receipt-input').click()">CHEKNI YUKLASH</button>
            <button class="btn-main" id="btn-pay" onclick="pay()">TO'LOV QILDIM</button>
            <button class="btn-main" id="btn-start" style="display:none; background:var(--green); color:#fff;" onclick="startTurnir()">TURNIRNI BOSHLASH</button>
        </div>
    </div>

    <div id="game">
        <div class="quiz-card">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size: 14px;">
                <span id="lvl-label" style="color:var(--gold)">RANGNI TANLANG!</span>
                <span><b id="game-score">0</b> PTS</span>
                <span><b id="round-idx">1</b>/30</span>
            </div>
            <div class="timer-bar-container"><div id="timer-bar"></div></div>
            <div id="color-word">...</div>
            <div class="color-options" id="color-options"></div>
        </div>
    </div>

    <div id="result-screen">
        <div class="quiz-card">
            <h2 id="res-title">NATIJA</h2>
            <p id="txt-final-res">To'plagan ballingiz:</p>
            <b id="final-score" style="font-size:48px; color:var(--gold);">0</b>
            <button class="btn-main" id="btn-res-next" onclick="navigate('tournament')">YOPISH</button>
        </div>
    </div>

    <div id="leaderboard">
        <h2 id="txt-rank-title" style="color:var(--gold)">üèÜ REYTING</h2>
        <div id="rank-list" class="quiz-card" style="padding:10px;"></div>
    </div>

    <div id="settings">
        <h2 id="txt-settings-title" style="color:var(--gold)">‚öôÔ∏è SOZLAMALAR</h2>
        <div class="quiz-card">
            <p id="txt-set-lang">Tilni tanlang:</p>
            <select id="set-lang-select" class="reg-input" onchange="window.switchLang(this.value)">
                <option value="uz">O'zbekcha</option>
                <option value="uz_cyr">–é–∑–±–µ–∫—á–∞</option>
            </select>
            <button class="btn-main" style="background:var(--red); color:#fff;" onclick="logout()">TIZIMDAN CHIQISH</button>
        </div>
    </div>
</div>

<div class="bottom-nav" id="navbar" style="display:none">
    <div class="nav-link" id="nav-tour" onclick="navigate('tournament')">‚öîÔ∏è<br><span id="nav-tour-text">Turnir</span></div>
    <div class="nav-link" id="nav-rank" onclick="navigate('leaderboard')">üèÜ<br><span id="nav-rank-text">Reyting</span></div>
    <div class="nav-link" id="nav-sett" onclick="navigate('settings')">‚öôÔ∏è<br><span id="nav-sett-text">Sozlamalar</span></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI", authDomain: "gen-lang-client-0228947349.firebaseapp.com", databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com", projectId: "gen-lang-client-0228947349", appId: "1:253793341504:web:709752258000dab44fcfa5" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Secure UID generation
    const uid = tg.initDataUnsafe?.user?.id ? "user_" + tg.initDataUnsafe.user.id : "guest_" + Math.random().toString(36).substr(2, 9);
    const userRef = ref(db, 'brain_users/' + uid);

    let userData = { lang: 'uz' };
    let currentScore = 0, currentRound = 1, timerInt, lastClickTime = 0;
    let receiptData = null, obStep = 0;
    
    const colors = [
        { name_uz: "QIZIL", name_kir: "“ö–ò–ó–ò–õ", value: "#ff3b3b" },
        { name_uz: "YASHIL", name_kir: "–Ø–®–ò–õ", value: "#28a745" },
        { name_uz: "KO'K", name_kir: "–ö–é–ö", value: "#007bff" },
        { name_uz: "SARIQ", name_kir: "–°–ê–†–ò“ö", value: "#FFD700" },
        { name_uz: "OQ", name_kir: "–û“ö", value: "#ffffff" },
        { name_uz: "BINAFSHA", name_kir: "–ë–ò–ù–ê–§–®–ê", value: "#a333c8" }
    ];

    const translations = {
        uz: {
            title: "Aql Jangi", slogan: "Xavfsiz Turnir Platformasi", name: "Ismingiz", surname: "Familiyangiz", next: "DAVOM ETISH",
            tour: "Turnir", rank: "Reyting", sett: "Sozlamalar", pLabel: "Ishtirokchilar:", upload: "CHEKNI YUKLASH", pay: "TO'LOV QILDIM",
            final: "To'plagan ballingiz:", resTitle: "NATIJA", payMsg: "To'lov qiling va chekni yuklang.",
            ob: [
                { t: "Rangli Reaksiya!", d: "Xavfsiz va adolatli tizimga xush kelibsiz.\nEkranda rang nomi chiqadi, siz uning haqiqiy rangini tanlashingiz kerak!" },
                { t: "Anti-Cheat!", d: "Tizim botlardan himoyalangan. Faqat tezkorlik va diqqat sizga g'alaba keltiradi." },
                { t: "Sovrinlar üèÜ", d: "ü•á 1-o'rin: 80 000 so'm\nü•à 2-o'rin: 50 000 so'm\nü•â 3-o'rin: 20 000 so'm\nTurnir kirish: 5 000 so'm." }
            ],
            confirm: "Boshladik!", wait: "Tekshirilmoqda...", logout: "Hisobingizni o'chirib chiqasizmi?"
        },
        uz_cyr: {
            title: "–ê“õ–ª –ñ–∞–Ω–≥–∏", slogan: "–•–∞–≤—Ñ—Å–∏–∑ –¢—É—Ä–Ω–∏—Ä –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å–∏", name: "–ò—Å–º–∏–Ω–≥–∏–∑", surname: "–§–∞–º–∏–ª–∏—è–Ω–≥–∏–∑", next: "–î–ê–í–û–ú –≠–¢–ò–®",
            tour: "–¢—É—Ä–Ω–∏—Ä", rank: "–†–µ–π—Ç–∏–Ω–≥", sett: "–°–æ–∑–ª–∞–º–∞–ª–∞—Ä", pLabel: "–ò—à—Ç–∏—Ä–æ–∫—á–∏–ª–∞—Ä:", upload: "–ß–ï–ö–ù–ò –Æ–ö–õ–ê–®", pay: "–¢–é–õ–û–í “ö–ò–õ–î–ò–ú",
            final: "–¢—û–ø–ª–∞–≥–∞–Ω –±–∞–ª–ª–∏–Ω–≥–∏–∑:", resTitle: "–ù–ê–¢–ò–ñ–ê", payMsg: "–¢—û–ª–æ–≤ “õ–∏–ª–∏–Ω–≥ –≤–∞ —á–µ–∫–Ω–∏ —é–∫–ª–∞–Ω–≥.",
            ob: [
                { t: "–†–∞–Ω–≥–ª–∏ –†–µ–∞–∫—Ü–∏—è!", d: "–•–∞–≤—Ñ—Å–∏–∑ –≤–∞ –∞–¥–æ–ª–∞—Ç–ª–∏ —Ç–∏–∑–∏–º–≥–∞ —Ö—É—à –∫–µ–ª–∏–±—Å–∏–∑.\n–≠–∫—Ä–∞–Ω–¥–∞ —Ä–∞–Ω–≥ –Ω–æ–º–∏ —á–∏“õ–∞–¥–∏, —Å–∏–∑ —É–Ω–∏–Ω–≥ “≥–∞“õ–∏“õ–∏–π —Ä–∞–Ω–≥–∏–Ω–∏ —Ç–∞–Ω–ª–∞—à–∏–Ω–≥–∏–∑ –∫–µ—Ä–∞–∫!" },
                { t: "Anti-Cheat!", d: "–¢–∏–∑–∏–º –±–æ—Ç–ª–∞—Ä–¥–∞–Ω “≥–∏–º–æ—è–ª–∞–Ω–≥–∞–Ω. –§–∞“õ–∞—Ç —Ç–µ–∑–∫–æ—Ä–ª–∏–∫ –≤–∞ –¥–∏“õ“õ–∞—Ç —Å–∏–∑–≥–∞ “ì–∞–ª–∞–±–∞ –∫–µ–ª—Ç–∏—Ä–∞–¥–∏." },
                { t: "–°–æ–≤—Ä–∏–Ω–ª–∞—Ä üèÜ", d: "ü•á 1-—û—Ä–∏–Ω: 80 000 —Å—û–º\nü•à 2-—û—Ä–∏–Ω: 50 000 —Å—û–º\nü•â 3-—û—Ä–∏–Ω: 20 000 —Å—û–º\n–¢—É—Ä–Ω–∏—Ä –∫–∏—Ä–∏—à: 5 000 —Å—û–º." }
            ],
            confirm: "–ë–æ—à–ª–∞–¥–∏–∫!", wait: "–¢–µ–∫—à–∏—Ä–∏–ª–º–æ“õ–¥–∞...", logout: "“≤–∏—Å–æ–±–∏–Ω–≥–∏–∑–Ω–∏ —û—á–∏—Ä–∏–± —á–∏“õ–∞—Å–∏–∑–º–∏?"
        }
    };

    // Security: Input Sanitization
    const sanitize = (str) => str.replace(/[<>]/g, "").trim();

    window.switchLang = async (l) => {
        userData.lang = l;
        const t = translations[l];
        document.getElementById('reg-name').placeholder = t.name;
        document.getElementById('reg-surname').placeholder = t.surname;
        document.getElementById('btn-next').innerText = t.next;
        document.getElementById('txt-tour-title').innerText = "‚öîÔ∏è " + t.tour.toUpperCase();
        document.getElementById('txt-nav-tour').innerText = t.tour;
        document.getElementById('txt-nav-rank').innerText = t.rank;
        document.getElementById('txt-nav-sett').innerText = t.sett;
        if (userData.name) await update(userRef, { lang: l });
    };

    window.register = async () => {
        const name = sanitize(document.getElementById('reg-name').value);
        const surname = sanitize(document.getElementById('reg-surname').value);
        if(name.length < 2 || surname.length < 2) return alert("Ism/Familiya juda qisqa!");
        
        userData = { name, surname, lang: userData.lang, tourStatus: "none", totalPoints: 0, ts: Date.now() };
        await set(userRef, userData);
        showScreen('onboarding'); showObStep();
    };

    function showObStep() {
        const t = translations[userData.lang].ob[obStep];
        document.getElementById('ob-title').innerText = t.t;
        document.getElementById('ob-desc').innerText = t.d;
        document.getElementById('btn-ob-next').innerText = obStep === 2 ? translations[userData.lang].confirm : translations[userData.lang].next;
    }

    window.nextObStep = () => { obStep < 2 ? (obStep++, showObStep()) : navigate('tournament'); };

    // Security: File validation
    window.handleReceipt = (i) => { 
        const file = i.files[0];
        if(file.size > 2 * 1024 * 1024) return alert("Rasm hajmi juda katta (Max 2MB)!");
        const r = new FileReader(); 
        r.onload=(e)=>receiptData=e.target.result; 
        r.readAsDataURL(file); 
    };

    window.pay = async () => {
        if(!receiptData) return alert(translations[userData.lang].payMsg);
        await update(userRef, { tourStatus: "pending", paymentReceipt: receiptData, appliedAt: Date.now() });
        tg.showConfirm("OK! Yuborildi."); loadTourStatus();
    };

    async function loadTourStatus() {
        const snap = await get(userRef); userData = snap.val();
        const msg = document.getElementById('tour-status-msg');
        onValue(ref(db, 'brain_users'), (s) => {
            let count = 0; s.forEach(u => u.val().tourStatus === 'active' && count++);
            document.getElementById('p-count').innerText = count;
            if(userData.tourStatus === 'active') document.getElementById('btn-start').style.display='block';
        });
        msg.innerText = translations[userData.lang][userData.tourStatus] || translations[userData.lang].payMsg;
    }

    window.startTurnir = () => {
        currentScore = 0; currentRound = 1;
        showScreen('game');
        nextColorRound();
    };

    function nextColorRound() {
        if(currentRound > 30) return finishGame();
        document.getElementById('round-idx').innerText = currentRound;
        document.getElementById('game-score').innerText = currentScore;
        
        const correctColor = colors[Math.floor(Math.random() * colors.length)];
        const fakeText = colors[Math.floor(Math.random() * colors.length)];
        
        const wordEl = document.getElementById('color-word');
        wordEl.innerText = userData.lang === 'uz' ? fakeText.name_uz : fakeText.name_kir;
        wordEl.style.color = correctColor.value;
        
        const optionsBox = document.getElementById('color-options');
        optionsBox.innerHTML = "";
        [...colors].sort(() => Math.random() - 0.5).forEach(c => {
            const btn = document.createElement('div');
            btn.className = "color-btn";
            btn.style.backgroundColor = c.value;
            btn.onclick = () => checkColor(c.value, correctColor.value);
            optionsBox.appendChild(btn);
        });
        startTimer();
    }

    function startTimer() {
        if(timerInt) clearInterval(timerInt);
        let limit = Math.max(0.8, 2.5 - (currentRound * 0.04));
        let left = limit;
        const bar = document.getElementById('timer-bar');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { bar.style.transition = `width ${limit}s linear`; bar.style.width = '0%'; }, 50);

        timerInt = setInterval(() => {
            left -= 0.1;
            if(left <= 0) { clearInterval(timerInt); checkColor(null, 'none'); }
        }, 100);
    }

    // Security: Anti-cheat check
    function checkColor(selected, correct) {
        const now = Date.now();
        if(now - lastClickTime < 200) return; // Prevent spam/bot clicks
        lastClickTime = now;
        
        clearInterval(timerInt);
        if(selected === correct) {
            currentScore += 10;
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            tg.HapticFeedback.notificationOccurred('error');
        }
        currentRound++;
        setTimeout(nextColorRound, 150);
    }

    async function finishGame() {
        showScreen('result-screen');
        document.getElementById('final-score').innerText = currentScore;
        // Secure update
        await update(userRef, { totalPoints: currentScore, tourStatus: "done", finishedAt: Date.now() });
    }

    window.navigate = (id) => {
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-link'));
        document.getElementById('nav-' + id.substring(0,4))?.classList.add('active-link');
        if(id==='tournament') { loadTourStatus(); document.getElementById('navbar').style.display='flex'; }
        if(id==='leaderboard') fetchRank();
    };

    async function fetchRank() {
        const snap = await get(ref(db, 'brain_users'));
        let list = []; snap.forEach(u => {
            const data = u.val();
            if(data.tourStatus === 'done') list.push(data);
        });
        list.sort((a,b) => b.totalPoints - a.totalPoints);
        document.getElementById('rank-list').innerHTML = list.map((u, i) => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #111; font-size:14px;">
                <span>${i+1}. ${sanitize(u.name)} ${sanitize(u.surname)}</span>
                <b style="color:var(--gold)">${u.totalPoints}</b>
            </div>`).join('') || "...";
    }

    window.logout = async () => { 
        if(confirm(translations[userData.lang].logout)) { await remove(userRef); location.reload(); }
    };

    function showScreen(id) { 
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
    }

    window.onload = async () => {
        const snap = await get(userRef); 
        document.getElementById('loader').style.display='none';
        if(snap.exists() && snap.val().name) { 
            userData = snap.val(); 
            window.switchLang(userData.lang); 
            navigate('tournament'); 
        } else { 
            window.switchLang('uz'); 
            showScreen('auth'); 
        }
    };
</script>
</body>
</html>
