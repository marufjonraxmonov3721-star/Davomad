<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aql Jangi | Labirint Turniri</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #FFD700; --gold-dark: #B8860B; --bg: #000000; --card: #0a0a0a; --text: #FFD700; --green: #28a745; --red: #ff3b3b; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; user-select: none; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; min-height: 100vh; box-sizing: border-box; }
        #auth, #onboarding, #tournament, #game, #leaderboard, #settings, #result-screen { display: none; text-align: center; }
        .active { display: block !important; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .reg-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--gold-dark); background: #000; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-main { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); border: none; padding: 18px; border-radius: 15px; color: #000; font-weight: bold; width: 100%; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .quiz-card { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid #333; margin-bottom: 15px; position: relative; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-link { font-size: 11px; opacity: 0.5; cursor: pointer; text-align: center; color: var(--gold); flex: 1; }
        .nav-link.active-link { opacity: 1; font-weight: bold; }

        /* Labirint va Tezlik maydoni */
        #maze-container { display: grid; margin: 15px auto; background: #111; border: 2px solid var(--gold); gap: 2px; padding: 2px; position: relative; width: 100%; max-width: 320px; }
        .cell { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .wall { background: #333; }
        .player { background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px var(--gold); z-index: 2; }
        .finish { background: var(--green); box-shadow: 0 0 10px var(--green); z-index: 1; }
        
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 180px; margin: 15px auto; }
        .ctrl-btn { background: #222; border: 1px solid var(--gold); color: var(--gold); padding: 20px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 20px; touch-action: manipulation; }
        .ctrl-btn:active { background: var(--gold); color: #000; }

        .timer-bar-container { background: #222; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: var(--red); transition: linear; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:50px; height:50px; border:5px solid #111; border-top:5px solid var(--gold); border-radius:50%; animation:rotate 1s linear infinite;"></div>
    <p style="color:var(--gold); margin-top:15px; letter-spacing:2px;">AQL JANGI</p>
</div>

<div class="container">
    <div id="auth">
        <h1 style="font-size: 40px; margin-top: 40px;">Aql Jangi</h1>
        <p>Tezkor Labirint Turniri</p>
        <select id="reg-lang" class="reg-input">
            <option value="uz">O'zbekcha üá∫üáø</option>
            <option value="uz_cyr">–é–∑–±–µ–∫—á–∞ üá∫üáø</option>
        </select>
        <input type="text" id="reg-name" class="reg-input" placeholder="Ismingiz">
        <input type="text" id="reg-surname" class="reg-input" placeholder="Familiyangiz">
        <button class="btn-main" onclick="register()">DAVOM ETISH</button>
    </div>

    <div id="onboarding">
        <div class="quiz-card">
            <h2 id="ob-title" style="color:var(--gold)"></h2>
            <p id="ob-desc" style="color:#fff; line-height:1.6;"></p>
            <button class="btn-main" onclick="nextObStep()">KEYINGISI</button>
        </div>
    </div>

    <div id="tournament">
        <h2 style="color:var(--gold)">‚öîÔ∏è TURNIR MARKAZI</h2>
        <div class="quiz-card">
            <p id="tour-status-msg" style="font-weight:bold;"></p>
            <div style="margin:15px 0; background:#111; padding:15px; border-radius:15px; border:1px dashed var(--gold); text-align:left;">
                <p>üí∞ Kirish: <b>5 000 so'm</b></p>
                <p>üí≥ Karta: <code>4073 4200 6816 5541</code></p>
                <p>üë§ Ega: <b>Maruf Raxmonov</b></p>
            </div>
            <div style="margin-bottom:15px;">
                Ishtirokchilar: <b id="p-count">0</b> / 30
            </div>
            <input type="file" id="receipt-input" accept="image/*" style="display:none;" onchange="handleReceipt(this)">
            <button class="btn-main" style="background:#222; color:var(--gold); border:1px solid #444; margin-bottom:10px;" onclick="document.getElementById('receipt-input').click()">CHEKNI YUKLASH</button>
            <button class="btn-main" id="btn-pay" onclick="pay()">TO'LOV QILDIM</button>
            <button class="btn-main" id="btn-start" style="display:none; background:var(--green); color:#fff;" onclick="startTurnir()">TURNIRNI BOSHLASH</button>
        </div>
    </div>

    <div id="game">
        <div class="quiz-card">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
                <span id="lvl-label" style="color:var(--gold)"></span>
                <span>Vaqt: <b id="game-timer">0.0</b>s</span>
                <span><b id="maze-idx">1</b>/10</span>
            </div>
            <div class="timer-bar-container"><div id="timer-bar"></div></div>
            <div id="maze-container"></div>
            <div class="controls">
                <div></div><button class="ctrl-btn" onclick="move('up')">‚ñ≤</button><div></div>
                <button class="ctrl-btn" onclick="move('left')">‚óÄ</button>
                <button class="ctrl-btn" onclick="move('down')">‚ñº</button>
                <button class="ctrl-btn" onclick="move('right')">‚ñ∂</button>
            </div>
        </div>
    </div>

    <div id="result-screen">
        <div class="quiz-card">
            <h2 id="res-title">BOSQICH TUGADI!</h2>
            <p>Jami vaqtingiz: <b id="final-time" style="font-size:24px; color:var(--gold);">0.0</b>s</p>
            <button class="btn-main" onclick="checkNext()">DAVOM ETISH</button>
        </div>
    </div>

    <div id="leaderboard">
        <h2 style="color:var(--gold)">üèÜ REYTING</h2>
        <div id="rank-list" class="quiz-card" style="padding:10px;"></div>
    </div>
</div>

<div class="bottom-nav" id="navbar" style="display:none">
    <div class="nav-link" id="nav-tour" onclick="navigate('tournament')">‚öîÔ∏è<br>Turnir</div>
    <div class="nav-link" id="nav-rank" onclick="navigate('leaderboard')">üèÜ<br>Reyting</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI", authDomain: "gen-lang-client-0228947349.firebaseapp.com", databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com", projectId: "gen-lang-client-0228947349", appId: "1:253793341504:web:709752258000dab44fcfa5" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id || "tester_maruf";
    const userRef = ref(db, 'brain_users/' + uid);

    let userData = null;
    let maze = [], player = {x:0, y:0}, finish = {x:0, y:0}, size = 6;
    let startTime, timerInt, sessionTime = 0, currentIdx = 0, level = "oson";
    let receiptData = null, obStep = 0, timeLimit = 30;

    const texts = {
        uz: { 
            ob: [{t:"Tezkor Labirint", d:"Maqsad: Finishga eng qisqa vaqtda yetib borish. Devorlardan o'tib bo'lmaydi."}, {t:"30 Ta Bosqich", d:"10 ta Oson, 10 ta O'rtacha va 10 ta Qiyin xaritalar sizni kutmoqda."}, {t:"Sovrinlar", d:"1-o'rin: 80k, 2-o'rin: 50k, 3-o'rin: 20k. Jami 30 kishi qatnashadi."}],
            wait: "To'lov tekshirilmoqda...", active: "Tasdiqlandi! 30 kishi to'lishini kuting.", pay: "To'lov qiling va chekni yuklang."
        },
        uz_cyr: { 
            ob: [{t:"–¢–µ–∑–∫–æ—Ä –õ–∞–±–∏—Ä–∏–Ω—Ç", d:"–ú–∞“õ—Å–∞–¥: –§–∏–Ω–∏—à–≥–∞ —ç–Ω–≥ “õ–∏—Å“õ–∞ –≤–∞“õ—Ç–¥–∞ –µ—Ç–∏–± –±–æ—Ä–∏—à. –î–µ–≤–æ—Ä–ª–∞—Ä–¥–∞–Ω —û—Ç–∏–± –±—û–ª–º–∞–π–¥–∏."}, {t:"30 –¢–∞ –ë–æ—Å“õ–∏—á", d:"10 —Ç–∞ –û—Å–æ–Ω, 10 —Ç–∞ –é—Ä—Ç–∞—á–∞ –≤–∞ 10 —Ç–∞ “ö–∏–π–∏–Ω —Ö–∞—Ä–∏—Ç–∞–ª–∞—Ä —Å–∏–∑–Ω–∏ –∫—É—Ç–º–æ“õ–¥–∞."}, {t:"–°–æ–≤—Ä–∏–Ω–ª–∞—Ä", d:"1-—û—Ä–∏–Ω: 80–∫, 2-—û—Ä–∏–Ω: 50–∫, 3-—û—Ä–∏–Ω: 20–∫. –ñ–∞–º–∏ 30 –∫–∏—à–∏ “õ–∞—Ç–Ω–∞—à–∞–¥–∏."}],
            wait: "–¢—û–ª–æ–≤ —Ç–µ–∫—à–∏—Ä–∏–ª–º–æ“õ–¥–∞...", active: "–¢–∞—Å–¥–∏“õ–ª–∞–Ω–¥–∏! 30 –∫–∏—à–∏ —Ç—û–ª–∏—à–∏–Ω–∏ –∫—É—Ç–∏–Ω–≥.", pay: "–¢—û–ª–æ–≤ “õ–∏–ª–∏–Ω–≥ –≤–∞ —á–µ–∫–Ω–∏ —é–∫–ª–∞–Ω–≥."
        }
    };

    window.register = async () => {
        const name = document.getElementById('reg-name').value, surname = document.getElementById('reg-surname').value, lang = document.getElementById('reg-lang').value;
        if(!name) return alert("Ism kerak!");
        userData = { name, surname, lang, tourStatus: "none", totalTime: 0, currentLevel: "oson" };
        await set(userRef, userData);
        showScreen('onboarding'); showObStep();
    };

    function showObStep() {
        const t = texts[userData.lang].ob[obStep];
        document.getElementById('ob-title').innerText = t.t;
        document.getElementById('ob-desc').innerText = t.d;
    }

    window.nextObStep = () => { obStep < 2 ? (obStep++, showObStep()) : (document.getElementById('navbar').style.display='flex', navigate('tournament')); };

    window.handleReceipt = (i) => { const r = new FileReader(); r.onload=(e)=>receiptData=e.target.result; r.readAsDataURL(i.files[0]); };

    window.pay = async () => {
        if(!receiptData) return alert("Avval chekni yuklang!");
        await update(userRef, { tourStatus: "pending", paymentReceipt: receiptData });
        alert("Yuborildi!"); loadTourStatus();
    };

    async function loadTourStatus() {
        const snap = await get(userRef); userData = snap.val();
        const msg = document.getElementById('tour-status-msg');
        onValue(ref(db, 'brain_users'), (s) => {
            let count = 0; s.forEach(u => u.val().tourStatus === 'active' && count++);
            document.getElementById('p-count').innerText = count;
            if(userData.tourStatus === 'active' && count >= 30) document.getElementById('btn-start').style.display='block';
        });
        msg.innerText = texts[userData.lang][userData.tourStatus] || texts[userData.lang].pay;
    }

    window.startTurnir = () => {
        level = userData.currentLevel;
        size = level === "oson" ? 6 : (level === "ortacha" ? 10 : 15);
        timeLimit = level === "oson" ? 30 : (level === "ortacha" ? 45 : 60);
        currentIdx = 0; sessionTime = 0;
        showScreen('game'); document.getElementById('lvl-label').innerText = level.toUpperCase();
        generateMaze();
    };

    function generateMaze() {
        maze = Array(size).fill().map(() => Array(size).fill(1));
        const walk = (x, y) => {
            maze[y][x] = 0;
            const dirs = [{x:0,y:-2},{x:0,y:2},{x:-2,y:0},{x:2,y:0}].sort(() => Math.random()-0.5);
            dirs.forEach(d => {
                let nx=x+d.x, ny=y+d.y;
                if(nx>=0 && nx<size && ny>=0 && ny<size && maze[ny][nx]===1) {
                    maze[y+d.y/2][x+d.x/2] = 0; walk(nx, ny);
                }
            });
        };
        walk(0, 0); player = {x:0, y:0}; finish = {x:size-1, y:size-1}; maze[size-1][size-1] = 0;
        renderMaze();
        startTime = Date.now();
        if(timerInt) clearInterval(timerInt);
        timerInt = setInterval(updateTimer, 100);
    }

    function updateTimer() {
        let diff = (Date.now() - startTime) / 1000;
        document.getElementById('game-timer').innerText = diff.toFixed(1);
        let per = Math.max(0, 100 - (diff / timeLimit * 100));
        document.getElementById('timer-bar').style.width = per + "%";
        if(diff >= timeLimit) { clearInterval(timerInt); alert("Vaqt tugadi!"); startTurnir(); }
    }

    function renderMaze() {
        const con = document.getElementById('maze-container');
        con.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        con.innerHTML = "";
        for(let y=0; y<size; y++) {
            for(let x=0; x<size; x++) {
                const c = document.createElement('div');
                c.className = `cell ${maze[y][x]?'wall':''}`;
                if(x===player.x && y===player.y) c.innerHTML = "üë§";
                if(x===finish.x && y===finish.y) c.innerHTML = "üèÅ";
                con.appendChild(c);
            }
        }
    }

    window.move = (dir) => {
        let nx=player.x, ny=player.y;
        if(dir==='up') ny--; if(dir==='down') ny++; if(dir==='left') nx--; if(dir==='right') nx++;
        if(nx>=0 && nx<size && ny>=0 && ny<size && maze[ny][nx]===0) {
            player = {x:nx, y:ny}; renderMaze();
            if(nx===finish.x && ny===finish.y) {
                clearInterval(timerInt);
                sessionTime += (Date.now()-startTime)/1000;
                if(currentIdx < 9) { currentIdx++; document.getElementById('maze-idx').innerText=currentIdx+1; generateMaze(); }
                else { showScreen('result-screen'); document.getElementById('final-time').innerText=sessionTime.toFixed(1); }
            }
        }
    };

    window.checkNext = async () => {
        let newTime = (userData.totalTime || 0) + sessionTime;
        let nextLvl = level === "oson" ? "ortacha" : (level === "ortacha" ? "qiyin" : "finished");
        if(nextLvl === "finished") {
            await update(userRef, { totalTime: newTime, tourStatus: "done" });
            alert("TABRIKLAYMIZ! Turnirni yakunladingiz."); navigate('tournament');
        } else {
            await update(userRef, { totalTime: newTime, currentLevel: nextLvl });
            userData.currentLevel = nextLvl; startTurnir();
        }
    };

    window.navigate = (id) => {
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='tournament') loadTourStatus();
        if(id==='leaderboard') fetchRank();
    };

    async function fetchRank() {
        const snap = await get(ref(db, 'brain_users'));
        let list = []; snap.forEach(u => u.val().tourStatus === 'done' && list.push(u.val()));
        list.sort((a,b) => a.totalTime - b.totalTime);
        document.getElementById('rank-list').innerHTML = list.map((u, i) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;"><span>${i+1}. ${u.name}</span><b>${u.totalTime.toFixed(1)}s</b></div>`).join('') || "Hali g'oliblar yo'q";
    }

    function showScreen(id) { document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    window.onload = async () => {
        const snap = await get(userRef); document.getElementById('loader').style.display='none';
        if(snap.exists() && snap.val().name) { userData = snap.val(); document.getElementById('navbar').style.display='flex'; navigate('tournament'); }
        else { showScreen('auth'); }
    };
</script>
</body>
</html>
