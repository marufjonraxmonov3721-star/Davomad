<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aql Jangi | Rangli Reaksiya</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #FFD700; --gold-dark: #B8860B; --bg: #000000; --card: #0a0a0a; --text: #FFD700; --green: #28a745; --red: #ff3b3b; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; user-select: none; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; min-height: 100vh; box-sizing: border-box; }
        #auth, #onboarding, #tournament, #game, #leaderboard, #settings, #result-screen { display: none; text-align: center; }
        .active { display: block !important; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .reg-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--gold-dark); background: #000; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-main { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); border: none; padding: 18px; border-radius: 15px; color: #000; font-weight: bold; width: 100%; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .quiz-card { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid #333; margin-bottom: 15px; position: relative; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-link { font-size: 11px; opacity: 0.5; cursor: pointer; text-align: center; color: var(--gold); flex: 1; }
        .nav-link.active-link { opacity: 1; font-weight: bold; }

        /* O'yin maydoni */
        #color-word { font-size: 48px; font-weight: 900; margin: 30px 0; text-transform: uppercase; letter-spacing: 2px; height: 60px; }
        .color-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .color-btn { height: 80px; border-radius: 20px; border: 2px solid #333; cursor: pointer; transition: 0.2s; }
        .color-btn:active { transform: scale(0.95); }

        .timer-bar-container { background: #222; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: var(--gold); transition: linear; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:50px; height:50px; border:5px solid #111; border-top:5px solid var(--gold); border-radius:50%; animation:rotate 1s linear infinite;"></div>
    <p style="color:var(--gold); margin-top:15px; letter-spacing:2px;">AQL JANGI</p>
</div>

<div class="container">
    <div id="auth">
        <h1 id="txt-app-title" style="font-size: 40px; margin-top: 40px;">Aql Jangi</h1>
        <p id="txt-app-slogan">Rangli Reaksiya Turniri</p>
        <select id="reg-lang" class="reg-input" onchange="window.switchLang(this.value)">
            <option value="uz">O'zbekcha üá∫üáø</option>
            <option value="uz_cyr">–é–∑–±–µ–∫—á–∞ üá∫üáø</option>
        </select>
        <input type="text" id="reg-name" class="reg-input" placeholder="Ismingiz">
        <input type="text" id="reg-surname" class="reg-input" placeholder="Familiyangiz">
        <button class="btn-main" id="btn-next" onclick="register()">DAVOM ETISH</button>
    </div>

    <div id="onboarding">
        <div class="quiz-card">
            <h2 id="ob-title" style="color:var(--gold)"></h2>
            <p id="ob-desc" style="color:#fff; line-height:1.6; white-space: pre-line;"></p>
            <button class="btn-main" id="btn-ob-next" onclick="nextObStep()">KEYINGISI</button>
        </div>
    </div>

    <div id="tournament">
        <h2 id="txt-tour-title" style="color:var(--gold)">‚öîÔ∏è TURNIR MARKAZI</h2>
        <div class="quiz-card">
            <p id="tour-status-msg" style="font-weight:bold;"></p>
            <div style="margin:15px 0; background:#111; padding:15px; border-radius:15px; border:1px dashed var(--gold); text-align:left;">
                <p id="txt-pay-info">üí∞ Kirish: <b>5 000 so'm</b></p>
                <p>üí≥ Karta: <code>4073 4200 6816 5541</code></p>
                <p>üë§ Ega: <b>Maruf Raxmonov</b></p>
            </div>
            <div style="margin-bottom:15px;">
                <span id="txt-p-label">Ishtirokchilar:</span> <b id="p-count">0</b>
            </div>
            <input type="file" id="receipt-input" accept="image/*" style="display:none;" onchange="handleReceipt(this)">
            <button class="btn-main" id="btn-upload" style="background:#222; color:var(--gold); border:1px solid #444; margin-bottom:10px;" onclick="document.getElementById('receipt-input').click()">CHEKNI YUKLASH</button>
            <button class="btn-main" id="btn-pay" onclick="pay()">TO'LOV QILDIM</button>
            <button class="btn-main" id="btn-start" style="display:none; background:var(--green); color:#fff;" onclick="startTurnir()">TURNIRNI BOSHLASH</button>
        </div>
    </div>

    <div id="game">
        <div class="quiz-card">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
                <span id="lvl-label" style="color:var(--gold)">RANGNI TANLANG!</span>
                <span>Ball: <b id="game-score">0</b></span>
                <span><b id="round-idx">1</b>/30</span>
            </div>
            <div class="timer-bar-container"><div id="timer-bar"></div></div>
            <div id="color-word">SO'Z</div>
            <div class="color-options" id="color-options"></div>
        </div>
    </div>

    <div id="result-screen">
        <div class="quiz-card">
            <h2 id="res-title">TURNIR YAKUNLANDI!</h2>
            <p id="txt-final-res">To'plagan ballingiz:</p>
            <b id="final-score" style="font-size:48px; color:var(--gold);">0</b>
            <button class="btn-main" id="btn-res-next" onclick="navigate('tournament')">YOPISH</button>
        </div>
    </div>

    <div id="leaderboard">
        <h2 id="txt-rank-title" style="color:var(--gold)">üèÜ REYTING</h2>
        <div id="rank-list" class="quiz-card" style="padding:10px;"></div>
    </div>

    <div id="settings">
        <h2 id="txt-settings-title" style="color:var(--gold)">‚öôÔ∏è SOZLAMALAR</h2>
        <div class="quiz-card">
            <p id="txt-set-lang">Ilova tilini tanlang:</p>
            <select id="set-lang-select" class="reg-input" onchange="window.switchLang(this.value)">
                <option value="uz">O'zbekcha üá∫üáø</option>
                <option value="uz_cyr">–é–∑–±–µ–∫—á–∞ üá∫üáø</option>
            </select>
            <button class="btn-main" style="background:var(--red); color:#fff; border:none;" onclick="logout()">TIZIMDAN CHIQISH</button>
        </div>
    </div>
</div>

<div class="bottom-nav" id="navbar" style="display:none">
    <div class="nav-link" id="nav-tour" onclick="navigate('tournament')">‚öîÔ∏è<br><span id="nav-tour-text">Turnir</span></div>
    <div class="nav-link" id="nav-rank" onclick="navigate('leaderboard')">üèÜ<br><span id="nav-rank-text">Reyting</span></div>
    <div class="nav-link" id="nav-sett" onclick="navigate('settings')">‚öôÔ∏è<br><span id="nav-sett-text">Sozlamalar</span></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI", authDomain: "gen-lang-client-0228947349.firebaseapp.com", databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com", projectId: "gen-lang-client-0228947349", appId: "1:253793341504:web:709752258000dab44fcfa5" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id || "tester_maruf";
    const userRef = ref(db, 'brain_users/' + uid);

    let userData = { lang: 'uz' };
    let currentScore = 0, currentRound = 1, timerInt, startTime;
    let receiptData = null, obStep = 0;
    
    const colors = [
        { name_uz: "QIZIL", name_kir: "“ö–ò–ó–ò–õ", value: "#ff3b3b" },
        { name_uz: "YASHIL", name_kir: "–Ø–®–ò–õ", value: "#28a745" },
        { name_uz: "KO'K", name_kir: "–ö–é–ö", value: "#007bff" },
        { name_uz: "SARIQ", name_kir: "–°–ê–†–ò“ö", value: "#FFD700" },
        { name_uz: "OQ", name_kir: "–û“ö", value: "#ffffff" },
        { name_uz: "BINAFSHA", name_kir: "–ë–ò–ù–ê–§–®–ê", value: "#a333c8" }
    ];

    const translations = {
        uz: {
            title: "Aql Jangi", slogan: "Rangli Reaksiya Turniri", name: "Ismingiz", surname: "Familiyangiz", next: "DAVOM ETISH",
            tour: "Turnir", rank: "Reyting", sett: "Sozlamalar", pLabel: "Ishtirokchilar:", upload: "CHEKNI YUKLASH", pay: "TO'LOV QILDIM",
            final: "To'plagan ballingiz:", resTitle: "TURNIR YAKUNLANDI!", payMsg: "To'lov qiling va chekni yuklang.",
            ob: [
                { t: "Rangli Reaksiya!", d: "Diqqat qiling: Ekranda rang nomi yoziladi, lekin u boshqa rangda bo'ladi. Siz so'zni o'qimasdan, uning RANGINI tanlashingiz kerak!" },
                { t: "Tezlik Muhim!", d: "Har bir bosqichda vaqt kamayib boradi. Qanchalik tez va aniq topsangiz, shunchalik ko'p ball olasiz." },
                { t: "Sovrinlar üèÜ", d: "ü•á 1-o'rin: 80 000 so'm\nü•à 2-o'rin: 50 000 so'm\nü•â 3-o'rin: 20 000 so'm\nTurnirda qatnashish: 5 000 so'm." }
            ],
            confirm: "Tushunarli, boshladik!", wait: "To'lov tekshirilmoqda...", logout: "Chiqasizmi?"
        },
        uz_cyr: {
            title: "–ê“õ–ª –ñ–∞–Ω–≥–∏", slogan: "–†–∞–Ω–≥–ª–∏ –†–µ–∞–∫—Ü–∏—è –¢—É—Ä–Ω–∏—Ä–∏", name: "–ò—Å–º–∏–Ω–≥–∏–∑", surname: "–§–∞–º–∏–ª–∏—è–Ω–≥–∏–∑", next: "–î–ê–í–û–ú –≠–¢–ò–®",
            tour: "–¢—É—Ä–Ω–∏—Ä", rank: "–†–µ–π—Ç–∏–Ω–≥", sett: "–°–æ–∑–ª–∞–º–∞–ª–∞—Ä", pLabel: "–ò—à—Ç–∏—Ä–æ–∫—á–∏–ª–∞—Ä:", upload: "–ß–ï–ö–ù–ò –Æ–ö–õ–ê–®", pay: "–¢–é–õ–û–í “ö–ò–õ–î–ò–ú",
            final: "–¢—û–ø–ª–∞–≥–∞–Ω –±–∞–ª–ª–∏–Ω–≥–∏–∑:", resTitle: "–¢–£–†–ù–ò–† –Ø–ö–£–ù–õ–ê–ù–î–ò!", payMsg: "–¢—û–ª–æ–≤ “õ–∏–ª–∏–Ω–≥ –≤–∞ —á–µ–∫–Ω–∏ —é–∫–ª–∞–Ω–≥.",
            ob: [
                { t: "–†–∞–Ω–≥–ª–∏ –†–µ–∞–∫—Ü–∏—è!", d: "–î–∏“õ“õ–∞—Ç “õ–∏–ª–∏–Ω–≥: –≠–∫—Ä–∞–Ω–¥–∞ —Ä–∞–Ω–≥ –Ω–æ–º–∏ —ë–∑–∏–ª–∞–¥–∏, –ª–µ–∫–∏–Ω —É –±–æ—à“õ–∞ —Ä–∞–Ω–≥–¥–∞ –±—û–ª–∞–¥–∏. –°–∏–∑ —Å—û–∑–Ω–∏ —û“õ–∏–º–∞—Å–¥–∞–Ω, —É–Ω–∏–Ω–≥ –†–ê–ù–ì–ò–ù–ò —Ç–∞–Ω–ª–∞—à–∏–Ω–≥–∏–∑ –∫–µ—Ä–∞–∫!" },
                { t: "–¢–µ–∑–ª–∏–∫ –ú—É“≥–∏–º!", d: "“≤–∞—Ä –±–∏—Ä –±–æ—Å“õ–∏—á–¥–∞ –≤–∞“õ—Ç –∫–∞–º–∞–π–∏–± –±–æ—Ä–∞–¥–∏. “ö–∞–Ω—á–∞–ª–∏–∫ —Ç–µ–∑ –≤–∞ –∞–Ω–∏“õ —Ç–æ–ø—Å–∞–Ω–≥–∏–∑, —à—É–Ω—á–∞–ª–∏–∫ –∫—û–ø –±–∞–ª–ª –æ–ª–∞—Å–∏–∑." },
                { t: "–°–æ–≤—Ä–∏–Ω–ª–∞—Ä üèÜ", d: "ü•á 1-—û—Ä–∏–Ω: 80 000 —Å—û–º\nü•à 2-—û—Ä–∏–Ω: 50 000 —Å—û–º\nü•â 3-—û—Ä–∏–Ω: 20 000 —Å—û–º\n–¢—É—Ä–Ω–∏—Ä–¥–∞ “õ–∞—Ç–Ω–∞—à–∏—à: 5 000 —Å—û–º." }
            ],
            confirm: "–¢—É—à—É–Ω–∞—Ä–ª–∏, –±–æ—à–ª–∞–¥–∏–∫!", wait: "–¢—û–ª–æ–≤ —Ç–µ–∫—à–∏—Ä–∏–ª–º–æ“õ–¥–∞...", logout: "–ß–∏“õ–∞—Å–∏–∑–º–∏?"
        }
    };

    window.switchLang = async (l) => {
        userData.lang = l;
        const t = translations[l];
        document.getElementById('txt-app-title').innerText = t.title;
        document.getElementById('txt-app-slogan').innerText = t.slogan;
        document.getElementById('reg-name').placeholder = t.name;
        document.getElementById('reg-surname').placeholder = t.surname;
        document.getElementById('btn-next').innerText = t.next;
        document.getElementById('txt-tour-title').innerText = "‚öîÔ∏è " + t.tour.toUpperCase() + " MARKAZI";
        document.getElementById('txt-p-label').innerText = t.pLabel;
        document.getElementById('btn-upload').innerText = t.upload;
        document.getElementById('btn-pay').innerText = t.pay;
        document.getElementById('txt-rank-title').innerText = "üèÜ " + t.rank.toUpperCase();
        document.getElementById('txt-settings-title').innerText = "‚öôÔ∏è " + t.sett.toUpperCase();
        document.getElementById('nav-tour-text').innerText = t.tour;
        document.getElementById('nav-rank-text').innerText = t.rank;
        document.getElementById('txt-nav-sett').innerText = t.sett;
        document.getElementById('res-title').innerText = t.resTitle;
        document.getElementById('txt-final-res').innerText = t.final;
        document.getElementById('btn-res-next').innerText = t.next;
        if (userData.name) await update(userRef, { lang: l });
    };

    window.register = async () => {
        const name = document.getElementById('reg-name').value, surname = document.getElementById('reg-surname').value;
        if(!name || !surname) return alert("To'liq to'ldiring!");
        userData.name = name; userData.surname = surname; userData.tourStatus = "none"; userData.totalPoints = 0;
        await set(userRef, userData);
        showScreen('onboarding'); showObStep();
    };

    function showObStep() {
        const t = translations[userData.lang].ob[obStep];
        document.getElementById('ob-title').innerText = t.t;
        document.getElementById('ob-desc').innerText = t.d;
        document.getElementById('btn-ob-next').innerText = obStep === 2 ? translations[userData.lang].confirm : translations[userData.lang].next;
    }

    window.nextObStep = () => { obStep < 2 ? (obStep++, showObStep()) : navigate('tournament'); };

    window.handleReceipt = (i) => { const r = new FileReader(); r.onload=(e)=>receiptData=e.target.result; r.readAsDataURL(i.files[0]); };

    window.pay = async () => {
        if(!receiptData) return alert(translations[userData.lang].payMsg);
        await update(userRef, { tourStatus: "pending", paymentReceipt: receiptData });
        alert("OK!"); loadTourStatus();
    };

    async function loadTourStatus() {
        const snap = await get(userRef); userData = snap.val();
        const msg = document.getElementById('tour-status-msg');
        onValue(ref(db, 'brain_users'), (s) => {
            let count = 0; s.forEach(u => u.val().tourStatus === 'active' && count++);
            document.getElementById('p-count').innerText = count;
            if(userData.tourStatus === 'active') document.getElementById('btn-start').style.display='block';
        });
        msg.innerText = userData.tourStatus === 'pending' ? translations[userData.lang].wait : (userData.tourStatus === 'active' ? "Siz turnirdasiz!" : translations[userData.lang].payMsg);
    }

    /* O'YIN MANTIQLARI */
    window.startTurnir = () => {
        currentScore = 0; currentRound = 1;
        showScreen('game');
        nextColorRound();
    };

    function nextColorRound() {
        if(currentRound > 30) return finishGame();
        
        document.getElementById('round-idx').innerText = currentRound;
        document.getElementById('game-score').innerText = currentScore;
        
        // Tasodifiy rang nomi va uning haqiqiy rangini tanlash
        const displayColor = colors[Math.floor(Math.random() * colors.length)]; // Haqiqiy rangi
        const textContent = colors[Math.floor(Math.random() * colors.length)]; // Yozilgan so'z
        
        const wordEl = document.getElementById('color-word');
        wordEl.innerText = userData.lang === 'uz' ? textContent.name_uz : textContent.name_kir;
        wordEl.style.color = displayColor.value;
        
        // Variantlarni chiqarish
        const optionsBox = document.getElementById('color-options');
        optionsBox.innerHTML = "";
        
        // Variantlarni chalkashtirib ko'rsatish
        [...colors].sort(() => Math.random() - 0.5).forEach(c => {
            const btn = document.createElement('div');
            btn.className = "color-btn";
            btn.style.backgroundColor = c.value;
            btn.onclick = () => checkColor(c.value, displayColor.value);
            optionsBox.appendChild(btn);
        });
        
        startTimer();
    }

    function startTimer() {
        if(timerInt) clearInterval(timerInt);
        let timeLimit = Math.max(1, 3 - (currentRound * 0.05)); // Round oshgan sari vaqt kamayadi
        let left = timeLimit;
        const bar = document.getElementById('timer-bar');
        bar.style.transition = 'none'; bar.style.width = '100%';
        
        setTimeout(() => {
            bar.style.transition = `width ${timeLimit}s linear`;
            bar.style.width = '0%';
        }, 50);

        timerInt = setInterval(() => {
            left -= 0.1;
            if(left <= 0) { clearInterval(timerInt); checkColor(null, 'none'); }
        }, 100);
    }

    function checkColor(selected, correct) {
        clearInterval(timerInt);
        if(selected === correct) {
            currentScore += 10;
            tg.HapticFeedback.notificationOccurred('success');
        } else {
            tg.HapticFeedback.notificationOccurred('error');
        }
        
        currentRound++;
        setTimeout(nextColorRound, 200);
    }

    async function finishGame() {
        showScreen('result-screen');
        document.getElementById('final-score').innerText = currentScore;
        await update(userRef, { totalPoints: currentScore, tourStatus: "done" });
    }

    window.navigate = (id) => {
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-link'));
        document.getElementById('nav-' + id.substring(0,4))?.classList.add('active-link');
        if(id==='tournament') { loadTourStatus(); document.getElementById('navbar').style.display='flex'; }
        if(id==='leaderboard') fetchRank();
    };

    async function fetchRank() {
        const snap = await get(ref(db, 'brain_users'));
        let list = []; snap.forEach(u => u.val().tourStatus === 'done' && list.push(u.val()));
        list.sort((a,b) => b.totalPoints - a.totalPoints);
        document.getElementById('rank-list').innerHTML = list.map((u, i) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;"><span>${i+1}. ${u.name} ${u.surname}</span><b>${u.totalPoints} Ball</b></div>`).join('') || "...";
    }

    window.logout = async () => { 
        if(confirm(translations[userData.lang].logout)) { await remove(userRef); location.reload(); }
    };

    function showScreen(id) { document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    window.onload = async () => {
        const snap = await get(userRef); document.getElementById('loader').style.display='none';
        if(snap.exists() && snap.val().name) { userData = snap.val(); window.switchLang(userData.lang); navigate('tournament'); }
        else { window.switchLang('uz'); showScreen('auth'); }
    };
</script>
</body>
</html>
``` Maruf, barcha o'zgarishlar amalga oshirildi:
1.  **O'yin to'liq almashdi**: Endi foydalanuvchilar so'zning o'zini emas, balki uning haqiqiy **RANGINI** tanlashlari kerak.
2.  **Dinamik vaqt**: Har bir bosqichda vaqt biroz tezlashadi (30 ta raund davomida).
3.  **Tillar**: O'zbekcha va Kirillcha to'liq qo'llab-quvvatlanadi, so'zlar avtomatik o'zgaradi.
4.  **Reyting**: Kim eng ko'p ball to'plasa, o'sha tepaga chiqadi.

Ushbu o'yin foydalanuvchilar orasida juda yuqori hayajon (reaksiya) hosil qiladi. Sinab ko'ring!
