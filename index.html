<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aql Jangi | Labirint Turniri</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #FFD700; --gold-dark: #B8860B; --bg: #000000; --card: #0a0a0a; --text: #FFD700; --green: #28a745; --red: #ff3b3b; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow: hidden; user-select: none; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; height: 100vh; box-sizing: border-box; }
        #auth, #onboarding, #tournament, #game, #leaderboard, #settings, #result-screen { display: none; text-align: center; height: 100%; }
        .active { display: flex !important; flex-direction: column; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .reg-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--gold-dark); background: #000; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-main { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); border: none; padding: 18px; border-radius: 15px; color: #000; font-weight: bold; width: 100%; cursor: pointer; text-transform: uppercase; }
        .quiz-card { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid #333; margin-bottom: 15px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-link { font-size: 11px; opacity: 0.5; cursor: pointer; text-align: center; color: var(--gold); flex: 1; }
        .nav-link.active-link { opacity: 1; font-weight: bold; }

        /* Labirint Dizayni */
        #maze-container { display: grid; margin: 10px auto; background: #111; border: 2px solid var(--gold); gap: 2px; padding: 2px; user-select: none; touch-action: none; }
        .cell { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .wall { background: #333; }
        .player { background: var(--gold-dark); border-radius: 50%; }
        .finish { background: var(--green); }

        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 180px; margin: 20px auto; }
        .ctrl-btn { background: #222; border: 1px solid var(--gold); color: var(--gold); padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:50px; height:50px; border:5px solid #111; border-top:5px solid var(--gold); border-radius:50%; animation:rotate 1s linear infinite;"></div>
    <p style="color:var(--gold); margin-top:15px; letter-spacing:2px;">AQL JANGI</p>
</div>

<div class="container">
    <div id="auth">
        <h1>Aql Jangi</h1>
        <p>Labirint Turniriga xush kelibsiz!</p>
        <select id="reg-lang" class="reg-input" onchange="window.updateUI(this.value)">
            <option value="uz">O'zbekcha üá∫üáø</option>
            <option value="uz_cyr">–é–∑–±–µ–∫—á–∞ üá∫üáø</option>
        </select>
        <input type="text" id="reg-name" class="reg-input" placeholder="Ismingiz">
        <input type="text" id="reg-surname" class="reg-input" placeholder="Familiyangiz">
        <button class="btn-main" onclick="register()">DAVOM ETISH</button>
    </div>

    <div id="onboarding">
        <div class="quiz-card">
            <h2 id="ob-title"></h2>
            <p id="ob-desc"></p>
            <button class="btn-main" onclick="nextObStep()">DAVOM ETISH</button>
        </div>
    </div>

    <div id="tournament">
        <h2 id="tour-title-text">Turnir Markazi</h2>
        <div class="quiz-card">
            <p id="tour-status-msg"></p>
            <div id="participant-counter" style="margin:10px 0; font-weight:bold;">Ishtirokchilar: <span id="p-count">0</span> / 30</div>
            <div id="payment-details" style="background:#111; padding:10px; border-radius:10px; border:1px dashed var(--gold); text-align:left; font-size:14px;">
                <p>üí∞ Kirish: 5 000 so'm | üë§ Maruf Raxmonov</p>
                <p>üí≥ Karta: 4073 4200 6816 5541</p>
            </div>
            <input type="file" id="receipt-input" accept="image/*" style="display:none;" onchange="previewReceipt(this)">
            <button class="btn-main" style="margin:10px 0; font-size:12px;" onclick="document.getElementById('receipt-input').click()">CHEKNI YUKLASH</button>
            <button class="btn-main" id="btn-pay" onclick="pay()">TO'LOV QILDIM</button>
            <button class="btn-main" id="btn-start" style="display:none; background:var(--green);" onclick="startTurnir()">TURNIRNI BOSHLASH</button>
        </div>
    </div>

    <div id="game">
        <div class="quiz-card" style="padding:10px;">
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span id="current-lvl-display">OSON</span>
                <span>Vaqt: <span id="game-timer">0.0</span>s</span>
                <span><span id="q-idx">1</span>/10</span>
            </div>
            <div id="maze-container"></div>
            <div class="controls">
                <div></div><button class="ctrl-btn" onclick="move('up')">‚ñ≤</button><div></div>
                <button class="ctrl-btn" onclick="move('left')">‚óÄ</button>
                <button class="ctrl-btn" onclick="move('down')">‚ñº</button>
                <button class="ctrl-btn" onclick="move('right')">‚ñ∂</button>
            </div>
        </div>
    </div>

    <div id="result-screen">
        <div class="quiz-card">
            <h2 id="res-finished-text">BOSQICH YAKUNLANDI!</h2>
            <p>Sizning vaqtingiz: <b id="final-score">0</b>s</p>
            <button class="btn-main" onclick="checkNextLevel()">KEYINGI BOSQICH</button>
        </div>
    </div>

    <div id="leaderboard">
        <h2 id="rank-title-text">üèÜ REYTING (Eng tezlar)</h2>
        <div id="rank-list" class="quiz-card" style="padding:5px;"></div>
    </div>
</div>

<div class="bottom-nav" id="navbar" style="display:none">
    <div class="nav-link" id="nav-tour" onclick="navigate('tournament')">‚öîÔ∏è<br><span id="nav-tour-text">Turnir</span></div>
    <div class="nav-link" id="nav-rank" onclick="navigate('leaderboard')">üèÜ<br><span id="nav-rank-text">Reyting</span></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI", authDomain: "gen-lang-client-0228947349.firebaseapp.com", databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com", projectId: "gen-lang-client-0228947349", appId: "1:253793341504:web:709752258000dab44fcfa5" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id || "tester_maruf_lab";
    const userRef = ref(db, 'brain_users/' + uid);

    let userData = null;
    let maze = [], playerPos = {x:0, y:0}, finishPos = {x:0, y:0}, size = 5;
    let startTime, timerInterval, totalTime = 0, currentIdx = 0, level = "oson";
    let receiptBase64 = null;
    let obStep = 0;

    const texts = {
        uz: { tour: "Turnir", rank: "Reyting", ob: [{ t: "Labirint!", d: "Finishga eng tez yetib borgan g'olib bo'ladi." }, { t: "Sovrinlar", d: "1-o'rin: 80k, 2-o'rin: 50k, 3-o'rin: 20k" }, { t: "Start", d: "30 ta joy to'lgach turnir boshlanadi." }] },
        uz_cyr: { tour: "–¢—É—Ä–Ω–∏—Ä", rank: "–†–µ–π—Ç–∏–Ω–≥", ob: [{ t: "–õ–∞–±–∏—Ä–∏–Ω—Ç!", d: "–§–∏–Ω–∏—à–≥–∞ —ç–Ω–≥ —Ç–µ–∑ –µ—Ç–∏–± –±–æ—Ä–≥–∞–Ω “ì–æ–ª–∏–± –±—û–ª–∞–¥–∏." }, { t: "–°–æ–≤—Ä–∏–Ω–ª–∞—Ä", d: "1-—û—Ä–∏–Ω: 80–∫, 2-—û—Ä–∏–Ω: 50–∫, 3-—û—Ä–∏–Ω: 20–∫" }, { t: "–°—Ç–∞—Ä—Ç", d: "30 —Ç–∞ –∂–æ–π —Ç—û–ª–≥–∞—á —Ç—É—Ä–Ω–∏—Ä –±–æ—à–ª–∞–Ω–∞–¥–∏." }] }
    };

    window.register = async () => {
        const name = document.getElementById('reg-name').value, surname = document.getElementById('reg-surname').value, lang = document.getElementById('reg-lang').value;
        if(!name) return alert("Ismni kiriting!");
        userData = { name, surname, lang, tourStatus: "none", totalTime: 0, currentLevel: "oson" };
        await set(userRef, userData);
        showScreen('onboarding');
        showObStep();
    };

    function showObStep() {
        const t = texts[userData.lang].ob[obStep];
        document.getElementById('ob-title').innerText = t.t;
        document.getElementById('ob-desc').innerText = t.d;
    }

    window.nextObStep = () => { obStep < 2 ? (obStep++, showObStep()) : (document.getElementById('navbar').style.display='flex', navigate('tournament')); };

    window.previewReceipt = (i) => { const r = new FileReader(); r.onload=(e)=>receiptBase64=e.target.result; r.readAsDataURL(i.files[0]); };

    window.pay = async () => {
        if(!receiptBase64) return alert("Chekni yuklang!");
        await update(userRef, { tourStatus: "pending", paymentReceipt: receiptBase64 });
        alert("Yuborildi!");
        loadTourStatus();
    };

    async function loadTourStatus() {
        const snap = await get(userRef); userData = snap.val();
        const msg = document.getElementById('tour-status-msg');
        onValue(ref(db, 'brain_users'), (s) => {
            let count = 0; s.forEach(u => u.val().tourStatus === 'active' && count++);
            document.getElementById('p-count').innerText = count;
            if(userData.tourStatus === 'active' && count >= 30) document.getElementById('btn-start').style.display='block';
        });
        msg.innerText = userData.tourStatus === 'pending' ? "Tasdiq kutilmoqda..." : (userData.tourStatus === 'active' ? "Siz turnirdasiz!" : "To'lov qiling.");
    }

    window.startTurnir = () => {
        level = userData.currentLevel || "oson";
        size = level === "oson" ? 6 : (level === "ortacha" ? 10 : 14);
        currentIdx = 0; totalTime = 0;
        showScreen('game');
        generateMaze();
    };

    function generateMaze() {
        maze = Array(size).fill().map(() => Array(size).fill(1)); // 1 is wall
        const stack = [{x:0, y:0}]; maze[0][0] = 0;
        while(stack.length) {
            let curr = stack[stack.length-1], neighbors = [];
            [{x:0,y:-2},{x:0,y:2},{x:-2,y:0},{x:2,y:0}].forEach(d => {
                let nx=curr.x+d.x, ny=curr.y+d.y;
                if(nx>=0 && nx<size && ny>=0 && ny<size && maze[ny][nx]===1) neighbors.push({x:nx, y:ny, dx:d.x/2, dy:d.y/2});
            });
            if(neighbors.length) {
                let next = neighbors[Math.floor(Math.random()*neighbors.length)];
                maze[curr.y+next.dy][curr.x+next.dx] = 0; maze[next.y][next.x] = 0; stack.push(next);
            } else stack.pop();
        }
        playerPos = {x:0, y:0}; finishPos = {x:size-1, y:size-1}; maze[size-1][size-1] = 0;
        drawMaze();
        startTime = Date.now();
        timerInterval = setInterval(() => { document.getElementById('game-timer').innerText = ((Date.now()-startTime)/1000).toFixed(1); }, 100);
    }

    function drawMaze() {
        const container = document.getElementById('maze-container');
        container.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        container.innerHTML = "";
        for(let y=0; y<size; y++) {
            for(let x=0; x<size; x++) {
                const cell = document.createElement('div');
                cell.className = `cell ${maze[y][x] ? 'wall' : ''}`;
                if(x===playerPos.x && y===playerPos.y) cell.innerHTML = "üòä";
                if(x===finishPos.x && y===finishPos.y) cell.innerHTML = "üèÅ";
                container.appendChild(cell);
            }
        }
    }

    window.move = (dir) => {
        let nx=playerPos.x, ny=playerPos.y;
        if(dir==='up') ny--; if(dir==='down') ny++; if(dir==='left') nx--; if(dir==='right') nx++;
        if(nx>=0 && nx<size && ny>=0 && ny<size && maze[ny][nx]===0) {
            playerPos = {x:nx, y:ny}; drawMaze();
            if(nx===finishPos.x && ny===finishPos.y) {
                clearInterval(timerInterval);
                totalTime += (Date.now()-startTime)/1000;
                if(currentIdx < 9) { currentIdx++; document.getElementById('q-idx').innerText=currentIdx+1; generateMaze(); }
                else { showScreen('result-screen'); document.getElementById('final-score').innerText=totalTime.toFixed(1); }
            }
        }
    };

    window.checkNextLevel = async () => {
        const snap = await get(userRef);
        let newTotal = (snap.val().totalTime || 0) + totalTime;
        if(level === "oson") level = "ortacha";
        else if(level === "ortacha") level = "qiyin";
        else { level = "oson"; alert("Tabriklaymiz!"); return navigate('tournament'); }
        await update(userRef, { totalTime: newTotal, currentLevel: level });
        startTurnir();
    };

    window.navigate = (id) => {
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='tournament') loadTourStatus();
        if(id==='leaderboard') fetchRank();
    };

    async function fetchRank() {
        const snap = await get(ref(db, 'brain_users'));
        let list = []; snap.forEach(u => u.val().totalTime > 0 && list.push(u.val()));
        list.sort((a,b) => a.totalTime - b.totalTime);
        document.getElementById('rank-list').innerHTML = list.slice(0,10).map((u, i) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;"><span>${i+1}. ${u.name}</span><b>${u.totalTime.toFixed(1)}s</b></div>`).join('');
    }

    window.onload = () => { setTimeout(()=>document.getElementById('loader').style.display='none', 1000); navigate('auth'); };
</script>
</body>
</html>
