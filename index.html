<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aql Jangi | Maruf Raxmonov</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --gold: #FFD700; 
            --gold-dark: #B8860B; 
            --bg: #000000; 
            --card: #0a0a0a; 
            --text: #FFD700;
            --green: #28a745; 
            --red: #ff3b3b; 
        }
        
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; user-select: none; transition: 0.3s; }
        .container { padding: 20px; max-width: 500px; margin: 0 auto; }
        
        #auth, #onboarding, #tournament, #game, #leaderboard, #profile, #settings, #result-screen { display: none; text-align: center; }
        .active { display: block !important; animation: fadeIn 0.6s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #111; border-top: 5px solid var(--gold); border-radius: 50%; animation: rotate 1s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .reg-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--gold-dark); background: #000; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-main { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); border: none; padding: 18px; border-radius: 15px; color: #000; font-weight: bold; width: 100%; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        
        .quiz-card { background: var(--card); padding: 25px; border-radius: 25px; border: 1px solid #333; min-height: 200px; margin-bottom: 20px; }
        .option-btn { background: #111; padding: 15px; border-radius: 15px; border: 1px solid #444; text-align: left; cursor: pointer; margin-bottom: 10px; color: #fff; }
        .correct { background: var(--green) !important; color: #fff; }
        .wrong { background: var(--red) !important; color: #fff; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-link { font-size: 11px; opacity: 0.5; cursor: pointer; text-align: center; color: var(--gold); flex: 1; text-decoration: none; }
        .nav-link.active-link { opacity: 1; font-weight: bold; }

        .timer-bar-container { background: #222; height: 5px; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: var(--gold); transition: linear; }
        
        #receipt-preview { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; display: none; border-radius: 10px; border: 1px solid var(--gold); }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top: 15px; font-weight: bold; letter-spacing: 3px;">AQL JANGI</p>
</div>

<div class="container">
    <div id="auth">
        <h1 id="app-title-auth" style="font-size: 40px;">Aql Jangi</h1>
        <p id="app-slogan-auth" style="color: #888;">Turnirda ishtirok eting!</p>
        <select id="reg-lang" class="reg-input" onchange="window.updateUI(this.value)">
            <option value="uz">O'zbekcha üá∫üáø</option>
            <option value="uz_cyr">–é–∑–±–µ–∫—á–∞ üá∫üáø</option>
        </select>
        <input type="text" id="reg-name" class="reg-input" placeholder="Ismingiz">
        <input type="text" id="reg-surname" class="reg-input" placeholder="Familiyangiz">
        <button class="btn-main" id="btn-reg-text" onclick="register()">DAVOM ETISH</button>
    </div>

    <div id="onboarding">
        <div class="quiz-card" id="ob-card">
            <h2 id="ob-title" style="color: var(--gold);"></h2>
            <p id="ob-desc" style="line-height: 1.6; color: #fff;"></p>
            <button class="btn-main" id="ob-next-btn" onclick="nextObStep()">KEYINGISI</button>
        </div>
    </div>

    <div id="tournament">
        <h2 id="tour-title-text">Turnir Markazi</h2>
        <div class="quiz-card" id="tour-box">
            <p id="tour-status-msg">Turnirda qatnashish uchun 5 000 so'm to'lov qiling.</p>
            <div id="payment-details" style="background:#111; padding:15px; border-radius:15px; border:1px dashed var(--gold); margin:15px 0; text-align:left;">
                <p id="pay-price">üí∞ Kirish: <b>5 000 so'm</b></p>
                <p id="pay-card">üí≥ Karta: <b style="color:#fff;">4073 4200 6816 5541</b></p>
                <p id="pay-owner">üë§ Ega: <b>Maruf Raxmonov</b></p>
            </div>
            
            <div id="receipt-upload-section" style="margin-top: 15px;">
                <label id="receipt-label" style="display:block; margin-bottom:10px; font-size:14px; color:#888;">To'lov chekini yuklang:</label>
                <input type="file" id="receipt-input" accept="image/*" style="display:none;" onchange="previewReceipt(this)">
                <button class="btn-main" style="background:#222; color:var(--gold); border:1px solid var(--gold-dark);" onclick="document.getElementById('receipt-input').click()" id="btn-choose-file">RASM TANLASH</button>
                <img id="receipt-preview">
            </div>

            <button class="btn-main" id="btn-pay" onclick="pay()">TO'LOV QILDIM</button>
            <button class="btn-main" id="btn-start" style="display:none; background:var(--green);" onclick="startTurnir()">O'YINNI BOSHLASH</button>
        </div>
    </div>

    <div id="game">
        <div class="level-header">
            <h3 id="current-level-name" style="margin:0;">OSON</h3>
            <p id="q-counter-label">Savol: <span id="q-idx">1</span>/10</p>
            <div class="timer-bar-container"><div id="timer-bar"></div></div>
        </div>
        <div class="quiz-card">
            <h3 id="q-text" style="color:#fff;">Savol yuklanmoqda...</h3>
            <div id="options" class="options-grid"></div>
        </div>
    </div>

    <div id="result-screen">
        <div class="quiz-card">
            <h2 id="res-finished-text">RAUND TUGADI!</h2>
            <p style="font-size: 24px;"><span id="res-score-label">To'g'ri javoblar:</span> <b id="final-score">0</b>/10</p>
            <button class="btn-main" id="res-btn" onclick="checkNextLevel()">DAVOM ETISH</button>
        </div>
    </div>

    <div id="leaderboard">
        <h2 id="rank-title-text">üèÜ REYTING</h2>
        <div id="rank-list" class="quiz-card" style="padding:10px;"></div>
    </div>

    <div id="settings">
        <h2 id="set-title-text">‚öôÔ∏è SOZLAMALAR</h2>
        <div class="quiz-card">
            <p id="set-user-info"></p>
            <select id="set-lang" class="reg-input" onchange="changeLang(this.value)">
                <option value="uz">O'zbekcha</option>
                <option value="uz_cyr">–é–∑–±–µ–∫—á–∞</option>
            </select>
            <button class="btn-main" id="btn-logout-text" style="background:var(--red); color:#fff;" onclick="logout()">TIZIMDAN CHIQISH</button>
        </div>
    </div>
</div>

<div class="bottom-nav" id="navbar" style="display:none">
    <div class="nav-link" id="nav-tour" onclick="navigate('tournament')">‚öîÔ∏è<br><span id="nav-tour-text">Turnir</span></div>
    <div class="nav-link" id="nav-rank" onclick="navigate('leaderboard')">üèÜ<br><span id="nav-rank-text">Reyting</span></div>
    <div class="nav-link" id="nav-set" onclick="navigate('settings')">‚öôÔ∏è<br><span id="nav-set-text">Sozlamalar</span></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id || "tester_maruf";
    const userRef = ref(db, 'brain_users/' + uid);

    let userData = null;
    let currentQuestions = [];
    let qIndex = 0;
    let score = 0;
    let currentLevel = "oson";
    let timer = null;
    let obStep = 0;
    let receiptBase64 = null;

    const texts = {
        uz: {
            appTitle: "Aql Jangi", slogan: "Turnirda ishtirok eting!",
            tour: "Turnir", rank: "Reyting", set: "Sozlamalar",
            regBtn: "DAVOM ETISH", namePh: "Ismingiz", surnamePh: "Familiyangiz",
            obNext: "KEYINGISI", tourTitle: "Turnir Markazi", payBtn: "TO'LOV QILDIM", startBtn: "O'YINNI BOSHLASH",
            payInfo: "Turnirda qatnashish uchun 5 000 so'm to'lov qiling.", payPrice: "üí∞ Kirish: <b>5 000 so'm</b>", payCard: "üí≥ Karta:", payOwner: "üë§ Ega:",
            resFinish: "RAUND TUGADI!", resScore: "To'g'ri javoblar:", qLabel: "Savol:", logout: "TIZIMDAN CHIQISH",
            receiptLab: "To'lov chekini yuklang:", chooseFile: "RASM TANLASH",
            ob: [
                { t: "Xush kelibsiz!", d: "Aql Jangi ‚Äî bu mantiqiy savollar orqali bilimingizni sinaydigan turnir ilovasi." },
                { t: "Maqsadimiz", d: "Sizga qiziqarli va mantiqiy jumboqlar berish orqali intellektual salohiyatingizni oshirish." },
                { t: "Turnir qoidalari", d: "Turnirda qatnashish 5 000 so'm. To'lov tasdiqlangach, 30 ta savol (3 bosqich) ochiladi." }
            ],
            wait: "To'lov tekshirilmoqda...", active: "To'lov tasdiqlandi! Turnirni boshlang."
        },
        uz_cyr: {
            appTitle: "–ê“õ–ª –ñ–∞–Ω–≥–∏", slogan: "–¢—É—Ä–Ω–∏—Ä–¥–∞ –∏—à—Ç–∏—Ä–æ–∫ —ç—Ç–∏–Ω–≥!",
            tour: "–¢—É—Ä–Ω–∏—Ä", rank: "–†–µ–π—Ç–∏–Ω–≥", set: "–°–æ–∑–ª–∞–º–∞–ª–∞—Ä",
            regBtn: "–î–ê–í–û–ú –≠–¢–ò–®", namePh: "–ò—Å–º–∏–Ω–≥–∏–∑", surnamePh: "–§–∞–º–∏–ª–∏—è–Ω–≥–∏–∑",
            obNext: "–ö–ï–ô–ò–ù–ì–ò–°–ò", tourTitle: "–¢—É—Ä–Ω–∏—Ä –ú–∞—Ä–∫–∞–∑–∏", payBtn: "–¢–é–õ–û–í “ö–ò–õ–î–ò–ú", startBtn: "–é–ô–ò–ù–ù–ò –ë–û–®–õ–ê–®",
            payInfo: "–¢—É—Ä–Ω–∏—Ä–¥–∞ “õ–∞—Ç–Ω–∞—à–∏—à —É—á—É–Ω 5 000 —Å—û–º —Ç—û–ª–æ–≤ “õ–∏–ª–∏–Ω–≥.", payPrice: "üí∞ –ö–∏—Ä–∏—à: <b>5 000 —Å—û–º</b>", payCard: "üí≥ –ö–∞—Ä—Ç–∞:", payOwner: "üë§ –≠–≥–∞:",
            resFinish: "–†–ê–£–ù–î –¢–£–ì–ê–î–ò!", resScore: "–¢—û“ì—Ä–∏ –∂–∞–≤–æ–±–ª–∞—Ä:", qLabel: "–°–∞–≤–æ–ª:", logout: "–¢–ò–ó–ò–ú–î–ê–ù –ß–ò“ö–ò–®",
            receiptLab: "–¢—û–ª–æ–≤ —á–µ–∫–∏–Ω–∏ —é–∫–ª–∞–Ω–≥:", chooseFile: "–†–ê–°–ú –¢–ê–ù–õ–ê–®",
            ob: [
                { t: "–•—É—à –∫–µ–ª–∏–±—Å–∏–∑!", d: "–ê“õ–ª –ñ–∞–Ω–≥–∏ ‚Äî –±—É –º–∞–Ω—Ç–∏“õ–∏–π —Å–∞–≤–æ–ª–ª–∞—Ä –æ—Ä“õ–∞–ª–∏ –±–∏–ª–∏–º–∏–Ω–≥–∏–∑–Ω–∏ —Å–∏–Ω–∞–π–¥–∏–≥–∞–Ω —Ç—É—Ä–Ω–∏—Ä –∏–ª–æ–≤–∞—Å–∏." },
                { t: "–ú–∞“õ—Å–∞–¥–∏–º–∏–∑", d: "–°–∏–∑–≥–∞ “õ–∏–∑–∏“õ–∞—Ä–ª–∏ –≤–∞ –º–∞–Ω—Ç–∏“õ–∏–π –∂—É–º–±–æ“õ–ª–∞—Ä –±–µ—Ä–∏—à –æ—Ä“õ–∞–ª–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª —Å–∞–ª–æ“≥–∏—è—Ç–∏–Ω–≥–∏–∑–Ω–∏ –æ—à–∏—Ä–∏—à." },
                { t: "–¢—É—Ä–Ω–∏—Ä “õ–æ–∏–¥–∞–ª–∞—Ä–∏", d: "–¢—É—Ä–Ω–∏—Ä–¥–∞ “õ–∞—Ç–Ω–∞—à–∏—à 5 000 —Å—û–º. –¢—û–ª–æ–≤ —Ç–∞—Å–¥–∏“õ–ª–∞–Ω–≥–∞—á, 30 —Ç–∞ —Å–∞–≤–æ–ª (3 –±–æ—Å“õ–∏—á) –æ—á–∏–ª–∞–¥–∏." }
            ],
            wait: "–¢—û–ª–æ–≤ —Ç–µ–∫—à–∏—Ä–∏–ª–º–æ“õ–¥–∞...", active: "–¢—û–ª–æ–≤ —Ç–∞—Å–¥–∏“õ–ª–∞–Ω–¥–∏! –¢—É—Ä–Ω–∏—Ä–Ω–∏ –±–æ—à–ª–∞–Ω–≥."
        }
    };

    window.updateUI = (lang) => {
        const t = texts[lang];
        document.getElementById('app-title-auth').innerText = t.appTitle;
        document.getElementById('app-slogan-auth').innerText = t.slogan;
        document.getElementById('btn-reg-text').innerText = t.regBtn;
        document.getElementById('reg-name').placeholder = t.namePh;
        document.getElementById('reg-surname').placeholder = t.surnamePh;
        document.getElementById('ob-next-btn').innerText = t.obNext;
        document.getElementById('tour-title-text').innerText = t.tourTitle;
        document.getElementById('btn-pay').innerText = t.payBtn;
        document.getElementById('btn-start').innerText = t.startBtn;
        document.getElementById('pay-price').innerHTML = t.payPrice;
        document.getElementById('receipt-label').innerText = t.receiptLab;
        document.getElementById('btn-choose-file').innerText = t.chooseFile;
        document.getElementById('pay-card').innerHTML = `${t.payCard} <b style="color:#fff;">4073 4200 6816 5541</b>`;
        document.getElementById('pay-owner').innerHTML = `${t.payOwner} <b>Maruf Raxmonov</b>`;
        document.getElementById('res-finished-text').innerText = t.resFinish;
        document.getElementById('res-score-label').innerText = t.resScore;
        document.getElementById('q-counter-label').innerHTML = `${t.qLabel} <span id="q-idx">${qIndex + 1}</span>/10`;
        document.getElementById('rank-title-text').innerText = t.rank;
        document.getElementById('set-title-text').innerText = t.set;
        document.getElementById('btn-logout-text').innerText = t.logout;
        document.getElementById('nav-tour-text').innerText = t.tour;
        document.getElementById('nav-rank-text').innerText = t.rank;
        document.getElementById('nav-set-text').innerText = t.set;
        
        if (userData) {
            const msg = document.getElementById('tour-status-msg');
            if(userData.tourStatus === "pending") msg.innerText = t.wait;
            else if(userData.tourStatus === "active") msg.innerText = t.active;
            else msg.innerText = t.payInfo;
        }
    };

    window.previewReceipt = (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                receiptBase64 = e.target.result;
                const img = document.getElementById('receipt-preview');
                img.src = receiptBase64;
                img.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.onload = async () => {
        const snap = await get(userRef);
        document.getElementById('loader').style.display = 'none';
        if (snap.exists()) {
            userData = snap.val();
            window.updateUI(userData.lang);
            if(userData.name) {
                document.getElementById('navbar').style.display = 'flex';
                navigate('tournament');
            } else { showScreen('auth'); }
        } else { 
            window.updateUI('uz');
            showScreen('auth'); 
        }
    };

    window.register = async () => {
        const name = document.getElementById('reg-name').value;
        const surname = document.getElementById('reg-surname').value;
        const lang = document.getElementById('reg-lang').value;
        if(!name || !surname) return alert("To'ldiring!");
        
        userData = { name, surname, lang, tourStatus: "none", totalPoints: 0, currentLevel: "oson" };
        await set(userRef, userData);
        window.updateUI(lang);
        showScreen('onboarding');
        showObStep();
    };

    function showObStep() {
        const t = texts[userData.lang].ob[obStep];
        document.getElementById('ob-title').innerText = t.t;
        document.getElementById('ob-desc').innerText = t.d;
    }

    window.nextObStep = () => {
        if(obStep < 2) { obStep++; showObStep(); }
        else { 
            const confirmTxt = userData.lang === 'uz' ? "Shartlarga rozimisiz?" : "–®–∞—Ä—Ç–ª–∞—Ä–≥–∞ —Ä–æ–∑–∏–º–∏—Å–∏–∑?";
            if(confirm(confirmTxt)) {
                document.getElementById('navbar').style.display = 'flex';
                navigate('tournament');
            }
        }
    };

    window.pay = async () => {
        if(!receiptBase64) {
            const errTxt = userData.lang === 'uz' ? "Iltimos, avval to'lov chekini yuklang!" : "–ò–ª—Ç–∏–º–æ—Å, –∞–≤–≤–∞–ª —Ç—û–ª–æ–≤ —á–µ–∫–∏–Ω–∏ —é–∫–ª–∞–Ω–≥!";
            return alert(errTxt);
        }
        
        await update(userRef, { 
            tourStatus: "pending", 
            tourAppliedAt: new Date().toISOString(),
            paymentReceipt: receiptBase64 
        });
        
        const alertTxt = userData.lang === 'uz' ? "To'lov va chek yuborildi. Admin tasdiqlashini kuting." : "–¢—û–ª–æ–≤ –≤–∞ —á–µ–∫ —é–±–æ—Ä–∏–ª–¥–∏. –ê–¥–º–∏–Ω —Ç–∞—Å–¥–∏“õ–ª–∞—à–∏–Ω–∏ –∫—É—Ç–∏–Ω–≥.";
        alert(alertTxt);
        loadTourStatus();
    };

    async function loadTourStatus() {
        const snap = await get(userRef);
        userData = snap.val();
        window.updateUI(userData.lang);
        const btnPay = document.getElementById('btn-pay');
        const btnStart = document.getElementById('btn-start');
        const payBox = document.getElementById('payment-details');
        const uploadBox = document.getElementById('receipt-upload-section');

        if(userData.tourStatus === "pending") {
            btnPay.style.display = "none";
            payBox.style.display = "none";
            uploadBox.style.display = "none";
        } else if(userData.tourStatus === "active") {
            btnPay.style.display = "none";
            payBox.style.display = "none";
            uploadBox.style.display = "none";
            btnStart.style.display = "block";
        }
    }

    window.startTurnir = async () => {
        currentLevel = userData.currentLevel || "oson";
        const qSnap = await get(ref(db, `brain_questions/${userData.lang}/${currentLevel}`));
        currentQuestions = (qSnap.val() || []).sort(() => 0.5 - Math.random()).slice(0, 10);
        
        if(currentQuestions.length < 10) return alert("Savollar yetarli emas!");
        
        qIndex = 0; score = 0;
        showScreen('game');
        loadQuestion();
    };

    function loadQuestion() {
        const q = currentQuestions[qIndex];
        document.getElementById('current-level-name').innerText = currentLevel.toUpperCase();
        document.getElementById('q-idx').innerText = qIndex + 1;
        document.getElementById('q-text').innerText = q.q;
        const optBox = document.getElementById('options');
        optBox.innerHTML = "";
        q.a.forEach((a, i) => {
            const b = document.createElement('div');
            b.className = "option-btn";
            b.innerText = a;
            b.onclick = () => checkAns(i, q.c, b);
            optBox.appendChild(b);
        });
        startTimer();
    }

    function startTimer() {
        if(timer) clearInterval(timer);
        let left = 20;
        const bar = document.getElementById('timer-bar');
        bar.style.transition = 'none'; bar.style.width = '100%';
        setTimeout(() => { bar.style.transition = 'width 20s linear'; bar.style.width = '0%'; }, 50);
        timer = setInterval(() => {
            left--;
            if(left <= 0) { clearInterval(timer); checkAns(-1, 0, null); }
        }, 1000);
    }

    function checkAns(idx, correct, el) {
        clearInterval(timer);
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.onclick = null);

        if(idx === correct) {
            if(el) el.classList.add('correct');
            score++;
        } else {
            if(el) el.classList.add('wrong');
            btns[correct].classList.add('correct');
        }

        setTimeout(() => {
            if(qIndex < 9) { qIndex++; loadQuestion(); }
            else { finishLevel(); }
        }, 1200);
    }

    async function finishLevel() {
        showScreen('result-screen');
        document.getElementById('final-score').innerText = score;
        const total = (userData.totalPoints || 0) + score;
        await update(userRef, { totalPoints: total });
    }

    window.checkNextLevel = async () => {
        if(currentLevel === "oson") { currentLevel = "ortacha"; startTurnir(); }
        else if(currentLevel === "ortacha") { currentLevel = "qiyin"; startTurnir(); }
        else {
            await update(userRef, { tourStatus: "finished", currentLevel: "oson" });
            const finishTxt = userData.lang === 'uz' ? "Tabriklaymiz! Turnirni yakunladingiz." : "–¢–∞–±—Ä–∏–∫–ª–∞–π–º–∏–∑! –¢—É—Ä–Ω–∏—Ä–Ω–∏ —è–∫—É–Ω–ª–∞–¥–∏–Ω–≥–∏–∑.";
            alert(finishTxt);
            navigate('tournament');
        }
        await update(userRef, { currentLevel: currentLevel });
    };

    window.navigate = (id) => {
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-link'));
        document.getElementById('nav-' + id.substring(0,3)).classList.add('active-link');
        
        if(id === 'tournament') loadTourStatus();
        if(id === 'leaderboard') fetchRank();
        if(id === 'settings') loadSettings();
    };

    async function fetchRank() {
        const snap = await get(ref(db, 'brain_users'));
        let list = [];
        snap.forEach(c => list.push(c.val()));
        list.sort((a,b) => (b.totalPoints || 0) - (a.totalPoints || 0));
        document.getElementById('rank-list').innerHTML = list.slice(0, 10).map((u, i) => `
            <div class="rank-item">
                <span><b>${i+1}.</b> ${u.name} ${u.surname}</span>
                <b>${u.totalPoints || 0}</b>
            </div>
        `).join('');
    }

    function loadSettings() {
        document.getElementById('set-user-info').innerText = `${userData.name} ${userData.surname}`;
        document.getElementById('set-lang').value = userData.lang;
    }

    window.changeLang = async (l) => { 
        userData.lang = l;
        window.updateUI(l);
        await update(userRef, { lang: l }); 
    };

    window.logout = async () => { 
        const confirmTxt = userData.lang === 'uz' ? "Chiqasizmi?" : "–ß–∏“õ–∞—Å–∏–∑–º–∏?";
        if(confirm(confirmTxt)) { await remove(userRef); location.reload(); } 
    };

    function showScreen(id) {
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
</script>
</body>
</html>
