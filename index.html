<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Davomad.uz | Dual Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg: #248b65; --blue: #007AFF; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; padding-bottom: 90px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 15px; }
        
        .step-box { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .step { width: 30%; height: 5px; background: #ddd; border-radius: 5px; }
        .step.active { background: var(--blue); }
        .step.complete { background: var(--tg); }

        button { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 600; font-size: 16px; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-main { background: var(--tg); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        
        #video-container { width: 100%; max-width: 300px; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 4px solid var(--blue); display: none; height: 300px; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="view-reg" class="card">
        <h2>Ro'yxatdan o'tish</h2>
        <input type="text" id="reg-name" placeholder="Ism Familiya" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:10px;">
        <select id="reg-role" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px;">
            <option value="student">Talaba</option>
            <option value="teacher">O'qituvchi</option>
        </select>
        <button class="btn-blue" onclick="register()">Saqlash</button>
    </div>

    <div id="view-student" class="card hidden">
        <h2 id="welcome-txt">Salom!</h2>
        <div class="step-box">
            <div id="step-1" class="step active"></div>
            <div id="step-2" class="step"></div>
            <div id="step-3" class="step"></div>
        </div>

        <div id="status-text" style="margin-bottom:15px; font-weight:500;">1-bosqich: Yuzni tasdiqlang</div>
        
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
        </div>
        <canvas id="canvas"></canvas>
        <img id="photo-preview" style="width:150px; border-radius:15px; display:none; margin: 10px auto;">

        <button id="main-btn" class="btn-main" onclick="startStep1()">Kamerani ochish</button>
    </div>

    <div id="view-teacher" class="card hidden">
        <h2>Darsdagi talabalar</h2>
        <div id="list" style="text-align:left;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe.user?.id || "dev_user";
    let userData = null;
    let userPhotoBase64 = "";

    // Yuklash
    get(ref(db, `users/${userId}`)).then(s => {
        if(s.exists()){
            userData = s.val();
            showView();
        }
    });

    window.register = () => {
        const name = document.getElementById('reg-name').value;
        const role = document.getElementById('reg-role').value;
        if(!name) return alert("Ismni yozing");
        userData = {name, role};
        set(ref(db, `users/${userId}`), userData).then(showView);
    };

    function showView(){
        document.getElementById('view-reg').classList.add('hidden');
        if(userData.role === 'teacher'){
            document.getElementById('view-teacher').classList.remove('hidden');
            loadList();
        } else {
            document.getElementById('view-student').classList.remove('hidden');
            document.getElementById('welcome-txt').innerText = userData.name;
        }
    }

    // 1-BOSQICH: YUZ (KAMERA)
    window.startStep1 = async () => {
        const video = document.getElementById('video');
        const container = document.getElementById('video-container');
        const btn = document.getElementById('main-btn');

        if(btn.innerText === "Kamerani ochish"){
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
                container.style.display = "block";
                btn.innerText = "Suratga tushish";
            } catch (err) {
                tg.showAlert("Kameraga ruxsat berilmadi!");
            }
        } else {
            // Suratga olish
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            userPhotoBase64 = canvas.toDataURL('image/jpeg', 0.5); // Base64 rasm
            
            // Kamerani yopish
            video.srcObject.getTracks().forEach(track => track.stop());
            container.style.display = "none";
            document.getElementById('photo-preview').src = userPhotoBase64;
            document.getElementById('photo-preview').style.display = "block";
            
            updateStep(1);
            document.getElementById('status-text').innerText = "2-bosqich: Barmoq izini tasdiqlang";
            btn.innerText = "Barmoq izini bosish";
            btn.onclick = startStep2;
        }
    };

    // 2-BOSQICH: BARMOQ IZI (BIOMETRIC)
    window.startStep2 = () => {
        tg.BiometricManager.init(() => {
            tg.BiometricManager.authenticate({ reason: "Barmoq izi kerak" }, (ok) => {
                if(ok){
                    updateStep(2);
                    document.getElementById('status-text').innerText = "3-bosqich: QR-kodni skanerlang";
                    const btn = document.getElementById('main-btn');
                    btn.innerText = "QR Skaner";
                    btn.onclick = startStep3;
                } else {
                    tg.showAlert("Barmoq izi xato!");
                }
            });
        });
    };

    // 3-BOSQICH: QR SKANER
    window.startStep3 = () => {
        tg.showScanQrPopup({ text: "Guvohnoma QR kodini ko'rsating" }, (data) => {
            if(data){
                tg.closeScanQrPopup();
                finish(data);
            }
            return true;
        });
    };

    async function finish(qrData){
        updateStep(3);
        const today = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString();
        
        await set(ref(db, `attendance/${today}/${userId}`), {
            name: userData.name,
            time: time,
            photo: userPhotoBase64,
            qr: qrData
        });

        document.getElementById('status-text').innerHTML = "<span style='color:green'>Davomat qilindi! âœ…</span>";
        document.getElementById('main-btn').classList.add('hidden');
    }

    function updateStep(n){
        document.getElementById(`step-${n}`).classList.add('complete');
        if(n<3) document.getElementById(`step-${n+1}`).classList.add('active');
    }

    function loadList(){
        const today = new Date().toISOString().split('T')[0];
        onValue(ref(db, `attendance/${today}`), s => {
            const list = document.getElementById('list');
            list.innerHTML = "";
            s.forEach(child => {
                const v = child.val();
                list.innerHTML += `
                    <div style="border-bottom:1px solid #eee; padding:10px; display:flex; align-items:center;">
                        <img src="${v.photo}" style="width:50px; height:50px; border-radius:50%; margin-right:10px;">
                        <div>
                            <b>${v.name}</b> <br>
                            <small>${v.time} | QR: ${v.qr}</small>
                        </div>
                    </div>`;
            });
        });
    }
</script>

</body>
</html>
