<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miya Jangi Turniri</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .active-tab { color: #fbbf24; border-bottom: 2px solid #fbbf24; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans overflow-hidden">

    <div id="reg-screen" class="min-h-screen flex flex-col items-center justify-center p-6">
        <h1 class="text-3xl font-bold text-yellow-500 mb-8">Ro'yxatdan o'tish</h1>
        <div class="w-full max-w-sm space-y-4">
            <input id="fname" type="text" placeholder="Ism" class="w-full p-4 bg-slate-800 rounded-xl outline-none border border-slate-700 focus:border-yellow-500">
            <input id="lname" type="text" placeholder="Familiya" class="w-full p-4 bg-slate-800 rounded-xl outline-none border border-slate-700 focus:border-yellow-500">
            <button onclick="register()" class="w-full bg-yellow-500 text-slate-900 font-black py-4 rounded-xl shadow-lg active:scale-95 transition">DAVOM ETISH</button>
        </div>
    </div>

    <div id="intro-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-2xl font-bold text-yellow-500 mb-6">Turnir Qoidalari</h2>
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 space-y-4 text-slate-300">
            <p>1Ô∏è‚É£ <b>Color Rush:</b> Ranglarni tez toping.</p>
            <p>2Ô∏è‚É£ <b>Math Ninja:</b> 10 ta matematik misol.</p>
            <p>3Ô∏è‚É£ <b>IQ-Test:</b> 10 ta mantiqiy savol.</p>
        </div>
        <button onclick="showMain()" class="mt-10 bg-blue-600 px-12 py-4 rounded-full font-bold shadow-lg">TUSHUNDIM</button>
    </div>

    <div id="main-app" class="hidden min-h-screen">
        <div id="page-game" class="p-6">
            <h2 class="text-xl font-bold mb-6">Turnir Bo'limi</h2>
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl">
                <h3 class="text-lg font-bold text-yellow-500 mb-2">Asosiy Turnir</h3>
                <p class="text-sm text-slate-400 mb-6">Uchala bosqichda maksimal ball to'plang!</p>
                <button onclick="startTournament()" class="w-full bg-yellow-500 text-slate-900 py-3 rounded-xl font-black">O'YINNI BOSHLASH</button>
            </div>
        </div>

        <div id="page-rating" class="hidden p-6">
            <h2 class="text-xl font-bold mb-6 text-yellow-500">üèÜ Kuchli o'nlik</h2>
            <div id="rating-list" class="space-y-3"></div>
        </div>

        <div id="page-settings" class="hidden p-6 flex flex-col items-center justify-center h-[70vh]">
            <button onclick="window.location.reload()" class="bg-red-600/20 text-red-500 border border-red-600 px-10 py-3 rounded-xl font-bold">Tizimdan chiqish</button>
        </div>

        <div id="game-overlay" class="hidden fixed inset-0 bg-slate-900 z-50 flex flex-col p-6">
            <div class="flex justify-between items-center mb-10">
                <span id="phase-name" class="text-yellow-500 font-bold uppercase tracking-widest text-sm">Bosqich</span>
                <span id="game-timer" class="text-xl font-mono bg-slate-800 px-4 py-1 rounded-lg">00</span>
            </div>
            <div id="game-container" class="flex-1 flex flex-col items-center justify-center text-center">
                </div>
        </div>

        <nav class="fixed bottom-0 w-full bg-slate-800/80 backdrop-blur-md border-t border-slate-700 flex justify-around py-4">
            <button onclick="switchTab('game')" id="tab-game" class="active-tab flex flex-col items-center"><span class="text-xs font-bold uppercase">O'yin</span></button>
            <button onclick="switchTab('rating')" id="tab-rating" class="flex flex-col items-center"><span class="text-xs font-bold uppercase">Reyting</span></button>
            <button onclick="switchTab('settings')" id="tab-settings" class="flex flex-col items-center"><span class="text-xs font-bold uppercase">Sozlamalar</span></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
            authDomain: "gen-lang-client-0228947349.firebaseapp.com",
            databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
            projectId: "gen-lang-client-0228947349",
            appId: "1:253793341504:web:709752258000dab44fcfa5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userData = { id: tg.initDataUnsafe?.user?.id || "dev_user", fullName: "", totalScore: 0 };
        let allQuestions = { math: [], iq: [] };
        let currentPhase = 1;
        let currentQuestionIdx = 0;
        let phaseScore = 0;

        // 1. RO'YXATDAN O'TISH
        window.register = () => {
            const f = document.getElementById('fname').value;
            const l = document.getElementById('lname').value;
            if(!f || !l) return tg.showAlert("Iltimos, ma'lumotlarni to'ldiring!");
            userData.fullName = `${f} ${l}`;
            document.getElementById('reg-screen').classList.add('hidden');
            document.getElementById('intro-screen').classList.remove('hidden');
        };

        window.showMain = () => {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            loadQuestions();
        };

        async function loadQuestions() {
            const snapshot = await get(ref(db, 'questions'));
            if (snapshot.exists()) {
                allQuestions.math = snapshot.val().math_ninja.list;
                allQuestions.iq = snapshot.val().iq_test.list;
            }
        }

        // 2. TURNIRNI BOSHLASH
        window.startTournament = () => {
            currentPhase = 1;
            phaseScore = 0;
            currentQuestionIdx = 0;
            document.getElementById('game-overlay').classList.remove('hidden');
            runPhase1();
        };

        // PHASE 1: COLOR RUSH (REAKSIYA)
        function runPhase1() {
            document.getElementById('phase-name').innerText = "1-bosqich: Color Rush";
            if(currentQuestionIdx >= 10) {
                currentQuestionIdx = 0;
                currentPhase = 2;
                return runPhase2();
            }

            const colors = [
                {n: "QIZIL", c: "#ef4444"}, {n: "KO'K", c: "#3b82f6"}, 
                {n: "YASHIL", c: "#22c55e"}, {n: "SARIQ", c: "#eab308"}
            ];
            const target = colors[Math.floor(Math.random()*colors.length)];
            const displayColor = colors[Math.floor(Math.random()*colors.length)];

            const cont = document.getElementById('game-container');
            cont.innerHTML = `
                <h1 class="text-5xl font-black mb-12" style="color: ${displayColor.c}">${target.n}</h1>
                <p class="mb-8 text-slate-400">Yozuv rangini tanlang!</p>
                <div class="grid grid-cols-2 gap-4 w-full">
                    ${colors.map(col => `<button onclick="checkColor('${col.c}', '${displayColor.c}')" class="h-20 rounded-2xl" style="background: ${col.c}"></button>`).join('')}
                </div>
            `;
        }

        window.checkColor = (picked, actual) => {
            if(picked === actual) phaseScore += 10;
            currentQuestionIdx++;
            runPhase1();
        };

        // PHASE 2: MATH NINJA
        function runPhase2() {
            document.getElementById('phase-name').innerText = "2-bosqich: Math Ninja";
            if(currentQuestionIdx >= 10) {
                currentQuestionIdx = 0;
                currentPhase = 3;
                return runPhase3();
            }

            const q = allQuestions.math[currentQuestionIdx];
            renderQuiz(q, 'math');
        }

        // PHASE 3: IQ TEST
        function runPhase3() {
            document.getElementById('phase-name').innerText = "3-bosqich: IQ Test";
            if(currentQuestionIdx >= 10) return finishTournament();

            const q = allQuestions.iq[currentQuestionIdx];
            renderQuiz(q, 'iq');
        }

        function renderQuiz(q, type) {
            const cont = document.getElementById('game-container');
            cont.innerHTML = `
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 w-full mb-8">
                    <h2 class="text-xl font-bold">${q.q}</h2>
                </div>
                <div class="grid grid-cols-1 gap-3 w-full">
                    ${q.a.map((opt, i) => `
                        <button onclick="checkQuiz(${i}, ${q.c}, '${type}')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded-xl border border-slate-700 text-left transition">
                            ${opt}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        window.checkQuiz = (picked, correct, type) => {
            if(picked === correct) phaseScore += 10;
            currentQuestionIdx++;
            if(type === 'math') runPhase2(); else runPhase3();
        };

        async function finishTournament() {
            document.getElementById('game-overlay').classList.add('hidden');
            tg.showConfirm(`Tabriklaymiz! Umumiy ball: ${phaseScore}. Natijani saqlaymiz-mi?`, async (ok) => {
                if(ok) {
                    await set(ref(db, 'results/' + userData.id), {
                        fullName: userData.fullName,
                        totalScore: phaseScore,
                        timestamp: Date.now()
                    });
                    tg.showAlert("Natija saqlandi!");
                    switchTab('rating');
                }
            });
        }

        // NAVIGATSIYA FUNKSIYALARI
        window.switchTab = async (tab) => {
            ['game', 'rating', 'settings'].forEach(t => {
                document.getElementById(`page-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active-tab');
            });
            document.getElementById(`page-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active-tab');
            
            if(tab === 'rating') {
                const snap = await get(ref(db, 'results'));
                const list = document.getElementById('rating-list');
                if(snap.exists()){
                    const sorted = Object.values(snap.val()).sort((a,b) => b.totalScore - a.totalScore).slice(0, 10);
                    list.innerHTML = sorted.map((u, i) => `
                        <div class="flex justify-between p-4 bg-slate-800 rounded-xl border border-slate-700">
                            <span>${i+1}. ${u.fullName}</span>
                            <span class="text-yellow-500 font-bold">${u.totalScore}</span>
                        </div>
                    `).join('');
                }
            }
        };
    </script>
</body>
</html>
