<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TURNIR: KIBER PROTOKOL</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        body { font-family: 'Orbitron', sans-serif; background-color: #050505; color: #fff; }
        .hidden { display: none; }
        .neon-border { border: 2px solid #00f2ff; box-shadow: 0 0 15px #00f2ff; }
        .blocked { filter: blur(5px); pointer-events: none; opacity: 0.5; }
        .loader { border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="overflow-hidden">

    <div id="reg-screen" class="min-h-screen flex flex-col items-center justify-center p-6">
        <h1 class="text-3xl font-black text-cyan-400 mb-10 tracking-widest uppercase">Ro'yxatdan o'tish</h1>
        <div class="w-full max-w-sm space-y-6">
            <input id="fname" type="text" placeholder="ISM" class="w-full p-4 bg-black/50 border-b-2 border-cyan-500 outline-none">
            <input id="lname" type="text" placeholder="FAMILIYA" class="w-full p-4 bg-black/50 border-b-2 border-cyan-500 outline-none">
            <button onclick="register()" class="w-full neon-border bg-transparent text-cyan-400 font-bold py-4 uppercase">Davom etish</button>
        </div>
    </div>

    <div id="intro-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-2xl font-bold text-yellow-500 mb-6 uppercase">Turnir Qoidalari</h2>
        <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-700 space-y-3 text-sm text-left mb-6">
            <p>üèÜ 1-o'rin: 100 000 so'm</p>
            <p>ü•à 2-o'rin: 30 000 so'm</p>
            <p>ü•â 3-o'rin: 20 000 so'm</p>
            <p class="text-cyan-400">üéüÔ∏è Qatnashish: 5 000 so'm (Jami 30 ta joy)</p>
            <hr class="border-zinc-700 my-4">
            <p class="text-xs text-zinc-400">To'lov uchun karta:</p>
            <p class="text-lg font-mono text-white">4073 4200 6816 5541</p>
            <p class="text-xs text-zinc-400 italic">Ega: Maruf Raxmonov</p>
        </div>
        <p class="text-[10px] text-red-500 mb-6 uppercase">To'lov qilib, chekni botga yuboring!</p>
        <button onclick="checkPaymentStatus()" class="w-full neon-border py-4 font-bold text-cyan-400">TO'LOVNI TEKSHIRISH</button>
    </div>

    <div id="main-app" class="hidden min-h-screen">
        <div id="game-lock-overlay" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-black/40 hidden">
            <h2 class="text-xl font-bold text-red-500 mb-2 uppercase">Kutish rejimi</h2>
            <p class="text-[10px] text-zinc-400">To'lov tasdiqlanishini kuting...</p>
        </div>

        <div id="content-to-blur" class="p-6 flex flex-col items-center justify-center h-screen">
            <div class="w-full max-w-sm p-8 bg-zinc-900/80 border-t-4 border-cyan-500 shadow-2xl text-center">
                <h3 class="text-xl font-bold text-cyan-400 mb-8 uppercase italic">Turnir Faol</h3>
                <button onclick="startTournament()" class="w-full bg-cyan-500 text-black py-4 font-black uppercase shadow-lg">Boshlash</button>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full bg-black border-t border-cyan-900 flex justify-around py-4">
            <button onclick="switchTab('game')" class="text-cyan-400 text-[10px] font-bold uppercase">Asosiy</button>
            <button onclick="switchTab('rating')" class="text-zinc-600 text-[10px] font-bold uppercase">Reyting</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
            authDomain: "gen-lang-client-0228947349.firebaseapp.com",
            databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
            projectId: "gen-lang-client-0228947349",
            appId: "1:253793341504:web:709752258000dab44fcfa5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userData = { id: tg.initDataUnsafe?.user?.id || "dev_" + Date.now(), fullName: "", isPaid: false };

        window.register = async () => {
            const f = document.getElementById('fname').value.trim();
            const l = document.getElementById('lname').value.trim();
            if(!f || !l) return tg.showAlert("ISM VA FAMILIYA SHART!");
            
            userData.fullName = `${f} ${l}`;
            
            // Foydalanuvchini bazaga yozish (to'lovsiz holatda)
            const userRef = ref(db, 'users/' + userData.id);
            const snap = await get(userRef);
            
            if(!snap.exists()) {
                await set(userRef, { 
                    fullName: userData.fullName, 
                    isPaid: false,
                    registeredAt: Date.now()
                });
            } else {
                userData.isPaid = snap.val().isPaid;
            }

            document.getElementById('reg-screen').classList.add('hidden');
            document.getElementById('intro-screen').classList.remove('hidden');
        };

        window.checkPaymentStatus = () => {
            // To'lov holatini Realtime tekshirishni boshlash
            const userRef = ref(db, 'users/' + userData.id);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if(data && data.isPaid) {
                    userData.isPaid = true;
                    showMainApp(true);
                } else {
                    showMainApp(false);
                }
            });
        };

        function showMainApp(isUnlocked) {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            const content = document.getElementById('content-to-blur');
            const overlay = document.getElementById('game-lock-overlay');

            if(isUnlocked) {
                content.classList.remove('blocked');
                overlay.classList.add('hidden');
            } else {
                content.classList.add('blocked');
                overlay.classList.remove('hidden');
                tg.showAlert("To'lov hali tasdiqlanmadi. Maruf Raxmonovga chekni yuborganingizga ishonch hosil qiling.");
            }
        }
    </script>
</body>
</html>
