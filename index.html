<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro: Triple Check</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #000; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        
        .main-container { height: 100vh; display: flex; flex-direction: column; }
        video { width: 100%; flex-grow: 1; background: #000; }

        /* Tasdiqlash oynasi */
        #check-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
            text-align: center;
        }

        .check-card {
            background: linear-gradient(135deg, var(--p), #4b0082);
            padding: 30px; border-radius: 25px; width: 80%;
            box-shadow: 0 0 30px rgba(123, 66, 245, 0.5);
        }

        .btn-yes { 
            background: #fff; color: #000; border: none; padding: 15px; 
            border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 20px;
            font-size: 18px;
        }

        .info-bar { background: #111; padding: 10px; font-size: 12px; border-top: 1px solid var(--p); }
    </style>
</head>
<body>

<div id="setup-view" style="display: flex; height: 100vh; justify-content: center; align-items: center; flex-direction: column; padding: 20px; text-align: center;">
    <h1 style="color: var(--p);">ðŸŽ¬ KINO PRO</h1>
    <p>Kino vaqti 3 ga bo'lib tekshiriladi</p>
    <button style="background: var(--p); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold;" onclick="document.getElementById('f').click()">KINO TANLASH</button>
    <input type="file" id="f" hidden accept="video/*" onchange="initApp(event)">
</div>

<div id="player-view" class="main-container" style="display: none;">
    <video id="v" controls playsinline></video>
    
    <div id="check-modal">
        <div class="check-card">
            <h2 style="margin: 0;">UXLADINGIZMI? ðŸ˜´</h2>
            <p style="opacity: 0.9;">Kino davom etishi uchun tugmani bosing</p>
            <div id="countdown" style="font-size: 30px; font-weight: bold; margin: 10px 0;">30</div>
            <button class="btn-yes" onclick="confirmWake()">HA, UYG'OQMAN!</button>
        </div>
    </div>

    <div class="info-bar">
        <div style="display: flex; justify-content: space-between;">
            <span id="check-points">Tekshiruv nuqtalari: hisoblanmoqda...</span>
            <span id="save-status">Vaqt saqlanmoqda...</span>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const v = document.getElementById('v');
    const modal = document.getElementById('check-modal');
    const countdownEl = document.getElementById('countdown');
    
    let checkPoints = [];
    let currentPointIdx = 0;
    let autoCloseTimer;
    let movieName = "";

    function initApp(e) {
        const file = e.target.files[0];
        if(!file) return;

        movieName = file.name;
        v.src = URL.createObjectURL(file);
        
        v.onloadedmetadata = function() {
            calculatePoints(v.duration);
            
            document.getElementById('setup-view').style.display = 'none';
            document.getElementById('player-view').style.display = 'flex';
            
            // Saqlangan joyidan davom etish
            const saved = localStorage.getItem("time_" + movieName);
            if(saved) v.currentTime = saved;
            
            v.play();
        };
    }

    function calculatePoints(duration) {
        const part = duration / 3;
        checkPoints = [part, part * 2, duration - 10]; // 33%, 66% va deyarli oxiri
        document.getElementById('check-points').innerText = "3 bosqichli nazorat faol âœ…";
    }

    // Videoni doimiy kuzatib borish
    v.ontimeupdate = function() {
        // Vaqtni saqlash
        localStorage.setItem("time_" + movieName, v.currentTime);

        // Tekshiruv nuqtasiga yetganini aniqlash
        if (currentPointIdx < checkPoints.length) {
            if (v.currentTime >= checkPoints[currentPointIdx]) {
                triggerCheck();
                currentPointIdx++; 
            }
        }
    };

    function triggerCheck() {
        v.pause();
        modal.style.display = 'flex';
        
        let timeLeft = 30;
        countdownEl.innerText = timeLeft;
        
        autoCloseTimer = setInterval(() => {
            timeLeft--;
            countdownEl.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(autoCloseTimer);
                tg.close(); // Javob bo'lmasa Telegram Web App yopiladi
            }
        }, 1000);
    }

    function confirmWake() {
        clearInterval(autoCloseTimer);
        modal.style.display = 'none';
        v.play();
    }

    // Xatolik bo'lsa (masalan, kinoni orqaga qaytarsa) nuqtani qayta tekshirish uchun
    v.onseeked = function() {
        for (let i = 0; i < checkPoints.length; i++) {
            if (v.currentTime < checkPoints[i]) {
                currentPointIdx = i;
                break;
            }
        }
    };
</script>
</body>
</html>
