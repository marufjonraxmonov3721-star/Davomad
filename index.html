<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGate: Secure Bio-System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root { --tg-color: #248b65; --error: #e74c3c; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .container { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        .step-box { border: 2px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 15px; text-align: left; }
        .step-box.active { border-color: var(--tg-color); background: #f0f9f4; }
        .step-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; }

        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-top: 5px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-main { background: var(--tg-color); color: white; }
        .btn-sec { background: #0088cc; color: white; }

        #camera-feed { width: 100%; border-radius: 15px; transform: scaleX(-1); display: none; }
        .hidden { display: none; }
        .loader { display: none; margin: 10px auto; border: 3px solid #f3f3f3; border-top: 3px solid var(--tg-color); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div id="loader" class="loader"></div>

    <div id="view-registration" class="card hidden">
        <h2 style="color: var(--tg-color);">Xavfsiz Ro'yxatdan o'tish</h2>
        
        <div class="step-box active" id="step1">
            <div class="step-title">1. Pasport QR-skaner <span>üìÑ</span></div>
            <input type="file" id="pass-file" accept="image/*" onchange="secureScan(this)">
            <p id="pass-res" style="font-size: 11px; margin: 5px 0;"></p>
        </div>

        <div class="step-box" id="step2">
            <div class="step-title">2. Jonli Selfie (Face-ID) <span>ü§≥</span></div>
            <video id="camera-feed" autoplay playsinline></video>
            <button class="btn-sec" id="btn-snap" onclick="takeSelfie()">Rasmga tushish</button>
            <canvas id="photo-canvas" class="hidden"></canvas>
        </div>

        <div class="step-box" id="step3">
            <div class="step-title">3. Shaxsiy ma'lumotlar <span>‚úèÔ∏è</span></div>
            <input type="text" id="reg-name" placeholder="F.I.SH (Avto)" readonly>
            <input type="tel" id="reg-phone" placeholder="Telefon raqamingiz">
            <select id="reg-role">
                <option value="student">Talaba</option>
                <option value="teacher">O'qituvchi</option>
            </select>
        </div>

        <button class="btn-main" onclick="finalRegister()">Tizimni faollashtirish</button>
    </div>

    <div id="view-main" class="card hidden">
        <h3 id="user-display">Xush kelibsiz</h3>
        <div id="status-area"></div>
        <button class="btn-main" id="btn-action" onclick="secureCheckIn()">Biometrik Davomat</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const bm = tg.BiometricManager;
    tg.ready(); tg.expand();

    const telegramId = tg.initDataUnsafe.user?.id || "test_user";
    const UNI_COORDS = { lat: 39.800911, lon: 64.426838 }; // Osiyo Xalqaro Universiteti

    // Tizimga kirishni tekshirish
    get(ref(db, `users/${telegramId}`)).then(snap => {
        if (!snap.exists()) {
            document.getElementById('view-registration').classList.remove('hidden');
            startCamera();
        } else {
            loadDashboard(snap.val());
        }
    });

    // 1. Xavfsiz Skaner (Pasport + QR)
    window.secureScan = function(input) {
        const file = input.files[0];
        document.getElementById('loader').style.display = 'block';
        
        const reader = new FileReader();
        reader.onload = function() {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const qr = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
                
                if(qr) {
                    const data = qr.data.split('|');
                    document.getElementById('reg-name').value = data[0] + " " + (data[1] || "");
                    document.getElementById('pass-res').innerText = "‚úÖ Pasport tasdiqlandi";
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                } else {
                    tg.showAlert("QR-kod topilmadi. Iltimos, pasportni orqa tarafini aniqroq oling.");
                }
                document.getElementById('loader').style.display = 'none';
            };
            img.src = reader.result;
        };
        reader.readAsDataURL(file);
    };

    // 2. Jonli Selfie (Face-ID tahlili uchun poydevor)
    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        const video = document.getElementById('camera-feed');
        video.srcObject = stream;
        video.style.display = 'block';
    }

    window.takeSelfie = function() {
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('photo-canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        tg.HapticFeedback.notificationOccurred('success');
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step3').classList.add('active');
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        document.getElementById('btn-snap').innerText = "‚úÖ Selfie olindi";
    };

    // 3. Yakuniy ro'yxatdan o'tish
    window.finalRegister = function() {
        const name = document.getElementById('reg-name').value;
        const phone = document.getElementById('reg-phone').value;
        if(!name || !phone) return tg.showAlert("Ma'lumotlar to'liq emas!");

        set(ref(db, `users/${telegramId}`), {
            fullName: name,
            phone: phone,
            role: document.getElementById('reg-role').value,
            verified: true,
            regDate: new Date().toLocaleString()
        }).then(() => location.reload());
    };

    // 4. Davomat (GPS + Biometrika)
    window.secureCheckIn = function() {
        navigator.geolocation.getCurrentPosition(pos => {
            const R = 6371;
            const dLat = (pos.coords.latitude - UNI_COORDS.lat) * Math.PI / 180;
            const dLon = (pos.coords.longitude - UNI_COORDS.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(pos.coords.latitude*Math.PI/180)*Math.cos(UNI_COORDS.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            if(dist <= 0.3) {
                bm.authenticate({ reason: "Davomatni tasdiqlang" }, ok => {
                    if(ok) {
                        const today = new Date().toISOString().split('T')[0];
                        set(ref(db, `attendance/${today}/${telegramId}`), { name: document.getElementById('user-display').innerText, time: new Date().toLocaleTimeString() })
                        .then(() => { tg.showAlert("Qabul qilindi! ‚úÖ"); location.reload(); });
                    }
                });
            } else tg.showAlert("Siz universitetda emassiz!");
        }, null, {enableHighAccuracy: true});
    };

    function loadDashboard(data) {
        document.getElementById('view-main').classList.remove('hidden');
        document.getElementById('user-display').innerText = data.fullName;
        if(data.role === 'teacher') loadTeacherLive();
    }

    function loadTeacherLive() {
        const today = new Date().toISOString().split('T')[0];
        onValue(ref(db, `attendance/${today}`), snap => {
            const area = document.getElementById('status-area');
            area.innerHTML = "<h4>Bugungi ro'yxat:</h4>";
            snap.forEach(c => { area.innerHTML += `<p>‚úÖ ${c.val().name}</p>`; });
        });
    }
</script>
</body>
</html>
