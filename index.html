<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro: Link Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #0a0a0a; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        
        .main-container { height: 100vh; display: flex; flex-direction: column; }
        video { width: 100%; flex-grow: 1; background: #000; }

        /* Link kiritish oynasi */
        .setup-area { 
            display: flex; height: 100vh; justify-content: center; align-items: center; 
            flex-direction: column; padding: 25px; text-align: center; 
        }
        
        input[type="text"] {
            width: 100%; padding: 15px; border-radius: 12px; border: 2px solid var(--p);
            background: #1a1a1a; color: white; margin-bottom: 15px; outline: none;
        }

        /* Tasdiqlash oynasi */
        #check-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.96); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
        }

        .check-card {
            background: linear-gradient(135deg, var(--p), #4b0082);
            padding: 30px; border-radius: 25px; width: 85%; text-align: center;
        }

        .btn-yes { 
            background: #fff; color: #000; border: none; padding: 15px; 
            border-radius: 15px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 15px;
        }

        .p-footer { background: #111; padding: 12px; font-size: 11px; border-top: 1px solid var(--p); }
    </style>
</head>
<body>

<div id="setup-view" class="setup-area">
    <h2 style="color: var(--p); margin-bottom: 5px;">ðŸŽ¬ KINO PRO</h2>
    <p style="font-size: 14px; opacity: 0.7;">Kino linkini joylashtiring</p>
    
    <input type="text" id="videoLink" placeholder="https://site.com/video.mp4" autocomplete="off">
    
    <button style="background: var(--p); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold;" onclick="startWithLink()">KO'RISHNI BOSHLASH</button>
    
    <p style="font-size: 11px; margin-top: 20px; color: #666;">Eslatma: Video formati .mp4 bo'lishi kerak</p>
</div>

<div id="player-view" class="main-container" style="display: none;">
    <video id="v" controls playsinline></video>
    
    <div id="check-modal">
        <div class="check-card">
            <h2 style="margin: 0;">UXLADINGIZMI? ðŸ˜´</h2>
            <p>Video 30 soniyadan keyin yopiladi</p>
            <div id="countdown" style="font-size: 35px; font-weight: bold; margin: 15px 0;">30</div>
            <button class="btn-yes" onclick="confirmWake()">HA, UYG'OQMAN!</button>
        </div>
    </div>

    <div class="p-footer">
        <div style="display: flex; justify-content: space-between;">
            <span id="p-info">Smart-Check: Faol âœ…</span>
            <span id="save-info">Vaqt saqlanmoqda...</span>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const v = document.getElementById('v');
    const modal = document.getElementById('check-modal');
    
    let checkPoints = [];
    let currentPointIdx = 0;
    let timer;

    function startWithLink() {
        const link = document.getElementById('videoLink').value.trim();
        if (!link) { alert("Iltimos, linkni kiriting!"); return; }

        v.src = link;
        
        v.onloadedmetadata = function() {
            // Vaqtni 3 ga bo'lish
            const part = v.duration / 3;
            checkPoints = [part, part * 2, v.duration - 15];
            
            document.getElementById('setup-view').style.display = 'none';
            document.getElementById('player-view').style.display = 'flex';
            
            // LocalStorage orqali vaqtni eslab qolish
            const saved = localStorage.getItem("link_time_" + link);
            if(saved) v.currentTime = saved;
            
            v.play();
        };

        v.onerror = function() {
            alert("Xatolik! Link noto'g'ri yoki video ochilmadi.");
        };
    }

    v.ontimeupdate = function() {
        // Avto-saqlash
        localStorage.setItem("link_time_" + v.src, v.currentTime);

        // 3 bosqichli tekshiruv nuqtasi
        if (currentPointIdx < checkPoints.length) {
            if (v.currentTime >= checkPoints[currentPointIdx]) {
                triggerCheck();
                currentPointIdx++;
            }
        }
    };

    function triggerCheck() {
        v.pause();
        modal.style.display = 'flex';
        let left = 30;
        document.getElementById('countdown').innerText = left;
        
        timer = setInterval(() => {
            left--;
            document.getElementById('countdown').innerText = left;
            if (left <= 0) {
                clearInterval(timer);
                tg.close();
            }
        }, 1000);
    }

    function confirmWake() {
        clearInterval(timer);
        modal.style.display = 'none';
        v.play();
    }
</script>
</body>
</html>
