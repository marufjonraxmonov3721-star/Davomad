<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OXU | Live Ecosystem</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --oxu-blue: #0047AB; --gold: #D4AF37; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f0f2f5; overflow: hidden; }
        .header { background: linear-gradient(135deg, #002147, #0047AB); color: white; padding: 12px; text-align: center; border-bottom: 3px solid var(--gold); font-size: 18px; font-weight: bold; }
        #map { height: calc(100vh - 160px); width: 100%; }
        
        /* Markerlar */
        .pfp-marker { border-radius: 50%; border: 3px solid var(--gold); background-size: cover; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .my-pfp { border-color: #007AFF; }
        .uni-marker { filter: drop-shadow(0 0 5px gold); }

        /* Chat Oynasi */
        #chat-box { position: fixed; bottom: 80px; right: 10px; width: 280px; height: 350px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 2000; border: 1px solid var(--oxu-blue); }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
        .msg { margin-bottom: 8px; padding: 6px 10px; border-radius: 10px; background: #f1f0f0; width: fit-content; max-width: 80%; }
        .my-msg { background: var(--oxu-blue); color: white; align-self: flex-end; margin-left: auto; }
        #chat-input-area { display: flex; padding: 10px; border-top: 1px solid #eee; }
        #chat-input-area input { flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 20px; outline: none; }

        /* Pastki Panel */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; height: 75px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-btn { text-align: center; font-size: 12px; color: #666; cursor: pointer; border: none; background: none; }
        .nav-btn.active { color: var(--oxu-blue); font-weight: bold; }
        .btn-attendance { background: var(--oxu-blue); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; }

        .location-label { font-size: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 5px; margin-top: 45px; display: block; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="header">OXU ECOSYSTEM üéì</div>

<div id="view-reg" class="hidden" style="padding: 50px 20px; text-align: center;">
    <input type="text" id="reg-name" placeholder="Ismingiz" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:10px;">
    <button onclick="saveUser()" style="width:100%; padding:15px; background: var(--oxu-blue); color:white; border:none; border-radius:12px; font-weight:bold;">KIRISH</button>
</div>

<div id="tab-map">
    <div id="map"></div>
</div>

<div id="chat-box">
    <div style="background: var(--oxu-blue); color: white; padding: 10px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between;">
        <span>Guruh Chati</span>
        <span onclick="toggleChat()" style="cursor:pointer;">‚úñ</span>
    </div>
    <div id="chat-msgs" style="display: flex; flex-direction: column;"></div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Xabar yozing...">
        <button onclick="sendMsg()" style="border:none; background:none; color:var(--oxu-blue); font-weight:bold; margin-left:5px;">Yuborish</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-btn active">üìç Xarita</div>
    <div class="nav-btn btn-attendance" onclick="doAttendance()">DAVOMAT</div>
    <div class="nav-btn" onclick="toggleChat()">üí¨ Chat</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const userId = tg.initDataUnsafe.user?.id || "u_" + Math.floor(Math.random()*1000);
    const photoUrl = tg.initDataUnsafe.user?.photo_url || "https://ui-avatars.com/api/?name=User";

    const UNI = { lat: 39.800911, lon: 64.426838, name: "OXU Universiteti" };
    let user = null, map, myMarker, firstLoad = true;
    let peerMarkers = {};

    async function init() {
        const snap = await get(ref(db, `users/${userId}`));
        if (snap.exists()) { user = snap.val(); startApp(); }
        else { document.getElementById('view-reg').classList.remove('hidden'); }
    }
    init();

    window.saveUser = async () => {
        const name = document.getElementById('reg-name').value;
        if(!name) return;
        user = { name, id: userId, photo: photoUrl };
        await set(ref(db, `users/${userId}`), user);
        startApp();
    };

    async function getAddress(lat, lon) {
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await res.json();
            return data.address.suburb || data.address.village || data.address.city || "Noma'lum hudud";
        } catch { return "Qidirilmoqda..."; }
    }

    function startApp() {
        document.getElementById('view-reg').classList.add('hidden');
        map = L.map('map', { zoomControl: false }).setView([UNI.lat, UNI.lon], 15);
        
        L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        // Universitet Markeri
        const uniIcon = L.divIcon({
            html: `<div class="uni-marker" style="font-size:30px;">üè´</div>`,
            className: 'none', iconSize: [40, 40]
        });
        L.marker([UNI.lat, UNI.lon], {icon: uniIcon}).addTo(map).bindPopup("<b>OXU UNIVERSITETI</b>").openPopup();

        // LIVE LOCATION
        navigator.geolocation.watchPosition(async pos => {
            const { latitude: lat, longitude: lon } = pos.coords;
            const address = await getAddress(lat, lon);
            
            await set(ref(db, `live_locations/${userId}`), { lat, lon, name: user.name, photo: photoUrl, addr: address });
            onDisconnect(ref(db, `live_locations/${userId}`)).remove();

            if(myMarker) map.removeLayer(myMarker);
            const myIcon = L.divIcon({
                className: 'pfp-marker my-pfp',
                html: `<div style="background-image:url(${photoUrl}); width:40px; height:40px; background-size:cover; border-radius:50%;"></div><span class="location-label">Siz: ${address}</span>`,
                iconSize: [46, 46]
            });
            myMarker = L.marker([lat, lon], {icon: myIcon}).addTo(map);

            if(firstLoad) { map.panTo([lat, lon]); firstLoad = false; }
        }, null, { enableHighAccuracy: true });

        // PEERS LOCATION
        onValue(ref(db, `live_locations`), snap => {
            snap.forEach(child => {
                if(child.key !== userId.toString()) {
                    const data = child.val();
                    if(peerMarkers[child.key]) map.removeLayer(peerMarkers[child.key]);
                    const peerIcon = L.divIcon({
                        className: 'pfp-marker',
                        html: `<div style="background-image:url(${data.photo}); width:36px; height:36px; background-size:cover; border-radius:50%;"></div><span class="location-label">${data.name}: ${data.addr}</span>`,
                        iconSize: [42, 42]
                    });
                    peerMarkers[child.key] = L.marker([data.lat, data.lon], {icon: peerIcon}).addTo(map).bindPopup(data.name);
                }
            });
        });

        // CHAT SYNC
        onValue(ref(db, `chat`), snap => {
            const container = document.getElementById('chat-msgs');
            container.innerHTML = "";
            snap.forEach(msg => {
                const d = msg.val();
                const cls = d.uid === userId ? "msg my-msg" : "msg";
                container.innerHTML += `<div class="${cls}"><b>${d.name}:</b><br>${d.txt}</div>`;
            });
            container.scrollTop = container.scrollHeight;
        });
    }

    window.toggleChat = () => {
        const box = document.getElementById('chat-box');
        box.style.display = box.style.display === "flex" ? "none" : "flex";
    };

    window.sendMsg = () => {
        const inp = document.getElementById('chat-input');
        if(!inp.value) return;
        push(ref(db, `chat`), { uid: userId, name: user.name, txt: inp.value });
        inp.value = "";
    };

    window.doAttendance = () => {
        tg.showAlert("Davomat tasdiqlandi! ‚úÖ");
    };
</script>
</body>
</html>
