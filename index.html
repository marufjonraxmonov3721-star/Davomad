<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testlar.uz - Bilimlar Cho'qqisi</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --gold: #FFD700; 
            --gold-dark: #B8860B;
            --bg: #ffffff; 
            --text: #1a1a1a; 
            --card: #f3f4f6;
        }
        .dark-mode { 
            --bg: #000000; 
            --text: #FFD700; 
            --card: #111111;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            transition: background 0.3s ease, color 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-user-select: none;
        }

        .premium-card {
            background-color: var(--card);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .gold-button {
            background: linear-gradient(45deg, var(--gold-dark), var(--gold));
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s;
        }
        
        .gold-button:active { transform: scale(0.95); }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            font-weight: 600;
            color: gray;
        }
        .active-nav { color: var(--gold); }

        .hidden { display: none; }

        input, select {
            background: rgba(128, 128, 128, 0.1) !important;
            border: 1px solid rgba(255, 215, 0, 0.3) !important;
            color: var(--text) !important;
            padding: 14px !important;
            border-radius: 12px !important;
            width: 100%;
            outline: none;
        }

        .option-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        .rank-badge {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--gold-dark), var(--gold));
            color: black;
            font-weight: 900;
            font-size: 14px;
        }

        .rank-1 { border: 2px solid #FFD700; position: relative; }
        .crown { position: absolute; top: -12px; left: -5px; font-size: 20px; transform: rotate(-20deg); }

        .progress-container { width: 100%; height: 6px; background: rgba(128,128,128,0.2); border-radius: 10px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background: var(--gold); transition: width 0.3s ease; }

        .profile-img-container {
            width: 110px; height: 110px; border-radius: 50%; border: 3px solid var(--gold);
            margin: 0 auto 15px; overflow: hidden; background: #333;
            display: flex; align-items: center; justify-content: center;
        }
        .profile-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .rank-img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; }

        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide { animation: fadeInRight 0.5s ease-out forwards; }

        .bday-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        .result-circle {
            width: 150px; height: 150px; border-radius: 50%; border: 8px solid var(--gold);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 20px; background: rgba(255, 215, 0, 0.1);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .rank-notify {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 3000; width: 90%; max-width: 350px;
            background: #111; border: 2px solid var(--gold); border-radius: 15px;
            padding: 15px; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 12px;
            animation: slideDown 0.5s ease forwards;
        }
        @keyframes slideDown { from { top: -100px; } to { top: 20px; } }

        .searching-loader {
            width: 80px; height: 80px; border: 5px solid rgba(255, 215, 0, 0.2);
            border-top: 5px solid var(--gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .duel-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; }
        .vs-badge { font-size: 24px; font-weight: 900; color: var(--gold); font-style: italic; }
        
        .room-code-display {
            font-size: 32px; font-weight: 900; letter-spacing: 8px; color: var(--gold);
            background: rgba(255,215,0,0.1); padding: 15px; border-radius: 15px; border: 2px dashed var(--gold);
        }
    </style>
</head>
<body class="pb-24">

    <div id="bday-overlay" class="bday-modal hidden">
        <div class="premium-card p-8 text-center shadow-2xl animate-slide border-2 border-gold">
            <div class="text-6xl mb-4">üéÇ</div>
            <h2 class="text-2xl font-black text-gold uppercase mb-2">Tug'ilgan kuningiz bilan!</h2>
            <p class="text-sm opacity-90 mb-6">Hurmatli <span id="bday-user-name" class="font-bold"></span>, sizga sihat-salomatlik va barcha testlardan eng yuqori ballarni tilaymiz! üéâ</p>
            <button onclick="closeBday()" class="gold-button w-full p-4 rounded-xl text-black">Rahmat!</button>
        </div>
    </div>

    <div id="auth-screen" class="p-8 flex flex-col justify-center min-h-screen text-center relative">
        <button onclick="toggleTheme()" class="absolute top-6 right-6 text-2xl p-2 premium-card">
            <span id="theme-icon-auth">üåô</span>
        </button>
        <div class="text-6xl mb-4 text-yellow-500">üéì</div>
        <h1 class="text-3xl font-black uppercase italic mb-10 tracking-tighter">Testlar Rasmiy</h1>
        <div class="space-y-4 text-left">
            <div>
                <label class="text-[10px] uppercase font-bold opacity-50 ml-2">Ismingiz</label>
                <input type="text" id="firstName" placeholder="Ismingizni kiriting">
            </div>
            <div>
                <label class="text-[10px] uppercase font-bold opacity-50 ml-2">Familiyangiz</label>
                <input type="text" id="lastName" placeholder="Familiyangizni kiriting">
            </div>
            <div>
                <label class="text-[10px] uppercase font-bold opacity-50 ml-2">Tug'ilgan sana</label>
                <input type="date" id="birthDay">
            </div>
            <button onclick="register()" class="gold-button w-full p-4 rounded-xl shadow-lg mt-4 text-black">Ro'yxatdan o'tish</button>
        </div>
    </div>

    <div id="intro-screen" class="hidden p-6 flex flex-col justify-center min-h-screen">
        <div id="intro-step-1" class="animate-slide">
            <div class="premium-card p-8 shadow-2xl text-center">
                <div class="text-5xl mb-6">üéØ</div>
                <h2 class="text-2xl font-black mb-4 text-yellow-500 uppercase">Maqsadimiz</h2>
                <p class="opacity-80 leading-relaxed text-sm">Foydalanuvchilarning bilim darajasini testlar orqali oshirish, intellektual salohiyatni charxlash.</p>
                <button onclick="nextIntro(2)" class="gold-button w-full p-4 rounded-xl text-black mt-8">Davom etish</button>
            </div>
        </div>
        <div id="intro-step-2" class="hidden animate-slide">
            <div class="premium-card p-8 shadow-2xl text-center text-sm">
                <div class="text-5xl mb-6">üìö</div>
                <h2 class="text-2xl font-black mb-4 text-yellow-500 uppercase">Fanlar</h2>
                <div class="grid grid-cols-2 gap-2 text-left text-[11px] opacity-90 mb-8 font-bold">
                    <span>‚Ä¢ Matematika</span><span>‚Ä¢ Fizika</span>
                    <span>‚Ä¢ Ona tili</span><span>‚Ä¢ Ingliz tili</span>
                </div>
                <button onclick="nextIntro(3)" class="gold-button w-full p-4 rounded-xl text-black">Davom etish</button>
            </div>
        </div>
        <div id="intro-step-3" class="hidden animate-slide">
            <div class="premium-card p-8 shadow-2xl text-center">
                <div class="text-5xl mb-6">üöÄ</div>
                <h2 class="text-2xl font-black mb-4 text-yellow-500 uppercase">Tayyormisiz?</h2>
                <button onclick="showMenu('subjects')" class="gold-button w-full p-4 rounded-xl text-black">Boshlaymiz!</button>
            </div>
        </div>
    </div>

    <div id="subjects-screen" class="hidden p-6">
        <h2 class="text-2xl font-black mb-6 border-l-4 border-yellow-500 pl-3 uppercase text-yellow-500 tracking-tighter">Testlar</h2>
        <div class="premium-card p-6 space-y-6">
            <div>
                <select id="selectedSubject">
                    <option value="Matematika">Matematika</option>
                    <option value="Fizika">Fizika</option>
                    <option value="Kimyo">Kimyo</option>
                    <option value="Ona tili">Ona tili</option>
                    <option value="Adabiyot">Adabiyot</option>
                    <option value="Geografiya">Geografiya</option>
                    <option value="Uzbekiston_tarixi">O‚Äòzbekiston tarixi</option>
                    <option value="Jahon_tarixi">Jahon tarixi</option>
                    <option value="Ingliz_tili">Ingliz tili</option>
                    <option value="Rus_tili">Rus tili</option>
                    <option value="Biologiya">Biologiya</option>
                    <option value="IQ_testlar">IQ testlar</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <select id="qAmount">
                    <option value="10">10 ta</option>
                    <option value="20" selected>20 ta</option>
                </select>
                <select id="qTime">
                    <option value="10">10 min</option>
                    <option value="15" selected>15 min</option>
                </select>
            </div>
            <button onclick="startTest()" class="gold-button w-full p-5 rounded-2xl text-lg shadow-xl text-black">üöÄ Testni Boshlash</button>
        </div>
    </div>

    <div id="duel-menu-screen" class="hidden p-6 flex flex-col justify-center min-h-screen text-center">
        <h2 class="text-2xl font-black mb-6 uppercase tracking-widest text-yellow-500">Duel Rejimi</h2>
        <div class="premium-card p-6 space-y-4">
            <button onclick="showDuelCreate()" class="gold-button w-full p-5 rounded-xl text-black">Xona yaratish</button>
            <button onclick="showDuelJoin()" class="w-full p-5 rounded-xl border-2 border-gold text-gold font-bold uppercase italic">Xonaga qo'shilish</button>
        </div>
    </div>

    <div id="duel-create-screen" class="hidden p-6 flex flex-col justify-center min-h-screen text-center">
        <h2 class="text-2xl font-black mb-6 uppercase tracking-widest text-yellow-500">Xona yaratish</h2>
        <div class="premium-card p-6 space-y-6">
            <select id="duelSubject">
                <option value="Matematika">Matematika</option>
                <option value="Fizika">Fizika</option>
                <option value="Ona tili">Ona tili</option>
                <option value="Tarix">Tarix</option>
            </select>
            <button onclick="generateDuelRoom()" class="gold-button w-full p-5 rounded-xl text-black">Kodni olish</button>
            <div id="room-code-area" class="hidden space-y-4 animate-slide">
                <div id="generated-code" class="room-code-display" onclick="copyRoomCode()">000000</div>
                <p class="text-[10px] opacity-60">Kod ustiga bosib nusxalash</p>
                <p class="text-xs text-yellow-500 animate-pulse">Raqib kutilmoqda...</p>
            </div>
        </div>
        <button onclick="showMenu('duel-menu')" class="mt-8 text-xs font-bold uppercase opacity-40">Orqaga</button>
    </div>

    <div id="duel-join-screen" class="hidden p-6 flex flex-col justify-center min-h-screen text-center">
        <h2 class="text-2xl font-black mb-6 uppercase tracking-widest text-yellow-500">Kirish</h2>
        <div class="premium-card p-6 space-y-6">
            <input type="number" id="join-code-input" placeholder="KOD" class="text-center text-2xl tracking-[10px] font-black">
            <button onclick="joinDuelRoom()" class="gold-button w-full p-5 rounded-xl text-black">Jangga kirish</button>
        </div>
        <button onclick="showMenu('duel-menu')" class="mt-8 text-xs font-bold uppercase opacity-40">Orqaga</button>
    </div>

    <div id="duel-vs-screen" class="hidden p-6 flex flex-col justify-center min-h-screen text-center">
        <div class="premium-card p-8 shadow-2xl animate-slide">
            <div class="flex justify-around items-center mb-8">
                <div class="text-center">
                    <img src="" id="duel-my-img" class="duel-avatar mb-2">
                    <p class="text-xs font-bold">Siz</p>
                </div>
                <div class="vs-badge">VS</div>
                <div class="text-center">
                    <img src="" id="duel-opp-img" class="duel-avatar mb-2">
                    <p class="text-xs font-bold" id="duel-opp-name">Raqib</p>
                </div>
            </div>
            <p id="duel-countdown" class="text-sm italic">3...</p>
        </div>
    </div>

    <div id="duel-result-screen" class="hidden p-6 flex flex-col justify-center min-h-screen text-center">
        <div class="premium-card p-8 shadow-2xl">
            <h2 id="duel-winner-text" class="text-3xl font-black mb-8 text-yellow-500 uppercase tracking-tighter"></h2>
            <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-gold/20 mb-4">
                <div class="text-left">
                    <p class="text-[10px] opacity-60">SIZ</p>
                    <p class="text-2xl font-black" id="duel-my-final-score">0</p>
                </div>
                <div class="vs-badge text-sm">VS</div>
                <div class="text-right">
                    <p class="text-[10px] opacity-60">RAQIB</p>
                    <p class="text-2xl font-black" id="duel-opp-final-score">0</p>
                </div>
            </div>
            <button onclick="showMenu('subjects')" class="gold-button w-full p-4 rounded-xl text-black">Chiqish</button>
        </div>
    </div>

    <div id="quiz-screen" class="hidden p-6 min-h-screen">
        <div class="mb-4"><div class="progress-container"><div id="progress-fill"></div></div></div>
        <div class="flex justify-between items-center mb-6">
            <span id="timer" class="text-xl font-black text-yellow-500">00:00</span>
            <span id="qProgress" class="text-sm opacity-60 font-bold uppercase">1/10</span>
        </div>
        <div class="premium-card p-6 mb-6"><h3 id="questionText" class="text-lg font-bold italic"></h3></div>
        <div id="optionsList" class="space-y-2 mb-8"></div>
    </div>

    <div id="result-screen" class="hidden p-6 flex flex-col justify-center min-h-screen text-center">
        <div class="premium-card p-8 shadow-2xl">
            <h2 class="text-2xl font-black mb-6 uppercase text-yellow-500">Natija</h2>
            <div class="result-circle">
                <span id="resPercent" class="text-4xl font-black text-yellow-500">0%</span>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="p-3 bg-green-500/10 rounded-xl"><p id="resCorrect" class="text-xl font-black text-green-500">0</p></div>
                <div class="p-3 bg-red-500/10 rounded-xl"><p id="resWrong" class="text-xl font-black text-red-500">0</p></div>
            </div>
            <button onclick="showMenu('subjects')" class="gold-button w-full p-4 rounded-xl text-black">Asosiy Menyu</button>
        </div>
    </div>

    <div id="rating-screen" class="hidden p-6">
        <h2 class="text-2xl font-black mb-4 border-l-4 border-yellow-500 pl-3 uppercase text-yellow-500">Reyting</h2>
        <div id="ratingList" class="space-y-4"></div>
    </div>

    <div id="profile-screen" class="hidden p-6 text-center">
        <div class="premium-card p-8 mb-6 shadow-xl">
            <div class="profile-img-container"><img src="" id="userProfileImg"></div>
            <h3 id="profName" class="text-2xl font-black mb-4"></h3>
            <div id="myStatsList" class="text-left space-y-2"></div>
        </div>
    </div>

    <nav id="main-nav" class="hidden fixed bottom-0 left-0 right-0 bg-inherit border-t border-yellow-500/20 px-4 py-4 flex justify-around z-50">
        <button onclick="showMenu('subjects')" id="nav-subjects" class="nav-btn active-nav">üìö<span>TESTLAR</span></button>
        <button onclick="showMenu('duel-menu')" id="nav-duel-menu" class="nav-btn">‚öîÔ∏è<span>DUEL</span></button>
        <button onclick="showMenu('rating')" id="nav-rating" class="nav-btn">üèÜ<span>REYTING</span></button>
        <button onclick="showMenu('profile')" id="nav-profile" class="nav-btn">üë§<span>PROFIL</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, remove, update, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
            authDomain: "gen-lang-client-0228947349.firebaseapp.com",
            databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
            projectId: "gen-lang-client-0228947349",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let currentUser = JSON.parse(localStorage.getItem('quizUser'));
        let timerInterval, testQuestions = [], currentQIndex = 0, score = 0, isDuelMode = false, currentDuelRoom = null;
        const tg = window.Telegram.WebApp;
        const tgUser = tg.initDataUnsafe?.user;

        window.onload = () => {
            tg.ready(); tg.expand();
            if(currentUser) { document.getElementById('auth-screen').classList.add('hidden'); showMenu('subjects'); }
        };

        // --- DUEL TIZIMI (PES USLUBI) ---
        window.copyRoomCode = () => {
            const code = document.getElementById('generated-code').innerText;
            navigator.clipboard.writeText(code);
            tg.showScanQrPopup({ text: "Kod nusxalandi!" });
            setTimeout(() => tg.closeScanQrPopup(), 1000);
        };

        window.generateDuelRoom = async () => {
            const subj = document.getElementById('duelSubject').value;
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('generated-code').innerText = code;
            document.getElementById('room-code-area').classList.remove('hidden');

            const questions = await getRandomQuestions(subj, 10);
            const roomData = { code, subj, p1: currentUser, status: 'waiting', questions, p1Score: -1, p2Score: -1 };
            await set(ref(db, `duel_rooms/${code}`), roomData);
            onDisconnect(ref(db, `duel_rooms/${code}`)).remove();

            onValue(ref(db, `duel_rooms/${code}`), (snap) => {
                const data = snap.val();
                if (data && data.status === 'starting') { currentDuelRoom = code; startDuelUI(data); }
                if (data && data.p1Score !== -1 && data.p2Score !== -1) showDuelFinalResult(data);
            });
        };

        window.joinDuelRoom = async () => {
            const code = document.getElementById('join-code-input').value.trim();
            const roomRef = ref(db, `duel_rooms/${code}`);
            const snap = await get(roomRef);
            if (snap.exists() && snap.val().status === 'waiting') {
                await update(roomRef, { p2: currentUser, status: 'starting' });
                currentDuelRoom = code;
                onValue(roomRef, (s) => { if(s.val().p1Score !== -1 && s.val().p2Score !== -1) showDuelFinalResult(s.val()); });
                startDuelUI(snap.val());
            } else alert("Xona topilmadi!");
        };

        function startDuelUI(room) {
            showMenu('duel-vs');
            const opp = room.p1.userId === currentUser.userId ? room.p2 : room.p1;
            document.getElementById('duel-my-img').src = currentUser.photo;
            document.getElementById('duel-opp-img').src = opp?.photo || "";
            document.getElementById('duel-opp-name').innerText = opp?.fName || "Raqib";
            let c = 3;
            const i = setInterval(() => {
                c--; document.getElementById('duel-countdown').innerText = c;
                if(c<=0) { 
                    clearInterval(i); testQuestions = room.questions; 
                    window.currentMeta = { subj: room.subj, amount: 10 };
                    isDuelMode = true; currentQIndex = 0; score = 0;
                    showMenu('quiz'); startTimer(60); loadQuestion();
                }
            }, 1000);
        }

        async function showDuelFinalResult(room) {
            showMenu('duel-result');
            const myScore = room.p1.userId === currentUser.userId ? room.p1Score : room.p2Score;
            const oppScore = room.p1.userId === currentUser.userId ? room.p2Score : room.p1Score;
            document.getElementById('duel-my-final-score').innerText = myScore;
            document.getElementById('duel-opp-final-score').innerText = oppScore;
            const winText = document.getElementById('duel-winner-text');
            if(myScore > oppScore) { winText.innerText = "G'ALABA!"; winText.style.color = "#FFD700"; confetti(); }
            else if(myScore < oppScore) { winText.innerText = "MAG'LUBIYAT"; winText.style.color = "#ef4444"; }
            else winText.innerText = "DURANG";
        }

        async function getRandomQuestions(subj, amount) {
            const snap = await get(ref(db, 'fanlar/' + subj));
            return snap.val()?.sort(() => 0.5 - Math.random()).slice(0, amount) || [];
        }

        // --- ASOSIY ---
        function register() {
            const f = document.getElementById('firstName').value, l = document.getElementById('lastName').value, b = document.getElementById('birthDay').value;
            if(!f || !l || !b) return;
            const userId = "user_" + Date.now();
            const userData = { userId, fName: f, lName: l, birth: b, photo: `https://ui-avatars.com/api/?name=${f}+${l}&background=random` };
            set(ref(db, 'users/' + userId), userData).then(() => {
                localStorage.setItem('quizUser', JSON.stringify(userData)); currentUser = userData;
                showMenu('subjects');
            });
        }

        function showMenu(s) {
            const screens = ['auth', 'intro', 'subjects', 'rating', 'profile', 'quiz', 'duel-menu', 'duel-create', 'duel-join', 'duel-vs', 'duel-result'];
            screens.forEach(id => document.getElementById(id + '-screen')?.classList.add('hidden'));
            document.getElementById(s + '-screen')?.classList.remove('hidden');
            document.getElementById('main-nav').classList.toggle('hidden', ['quiz','duel-vs','duel-result','auth'].includes(s));
            if(s === 'rating') loadRating(); if(s === 'profile') loadProfile();
        }

        function loadQuestion() {
            if(currentQIndex >= testQuestions.length) return finishTest(true);
            const q = testQuestions[currentQIndex];
            document.getElementById('qProgress').innerText = `${currentQIndex + 1}/${testQuestions.length}`;
            document.getElementById('questionText').innerText = q.q;
            const ol = document.getElementById('optionsList'); ol.innerHTML = "";
            q.a.forEach((text, idx) => {
                const btn = document.createElement('button'); btn.className = "option-btn bg-white/5"; btn.innerText = text;
                btn.onclick = () => {
                    if(idx === q.c) score++;
                    currentQIndex++; loadQuestion();
                };
                ol.appendChild(btn);
            });
        }

        async function finishTest(comp) {
            clearInterval(timerInterval);
            if(isDuelMode) {
                const scoreField = currentUser.userId === (await get(ref(db, `duel_rooms/${currentDuelRoom}/p1`))).val().userId ? 'p1Score' : 'p2Score';
                await update(ref(db, `duel_rooms/${currentDuelRoom}`), { [scoreField]: score });
            } else {
                document.getElementById('resPercent').innerText = Math.round((score/window.currentMeta.amount)*100) + "%";
                document.getElementById('resCorrect').innerText = score;
                document.getElementById('resWrong').innerText = window.currentMeta.amount - score;
                showMenu('result');
            }
        }

        function startTimer(s) {
            let t = s; timerInterval = setInterval(() => {
                let m = Math.floor(t/60), sc = t%60;
                document.getElementById('timer').innerText = `${m}:${sc<10?'0'+sc:sc}`;
                if(t-- <= 0) finishTest(true);
            }, 1000);
        }

        window.showMenu = showMenu; window.register = register; window.startTest = () => { isDuelMode = false; startTest(); };
    </script>
</body>
</html>
