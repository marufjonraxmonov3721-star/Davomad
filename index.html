<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aql Jangi | Labirint Turniri</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #FFD700; --gold-dark: #B8860B; --bg: #000000; --card: #0a0a0a; --text: #FFD700; --green: #28a745; --red: #ff3b3b; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; user-select: none; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; min-height: 100vh; box-sizing: border-box; }
        #auth, #onboarding, #tournament, #game, #leaderboard, #settings, #result-screen { display: none; text-align: center; }
        .active { display: block !important; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .reg-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid var(--gold-dark); background: #000; color: #fff; font-size: 16px; box-sizing: border-box; }
        .btn-main { background: linear-gradient(135deg, var(--gold-dark), var(--gold)); border: none; padding: 18px; border-radius: 15px; color: #000; font-weight: bold; width: 100%; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .quiz-card { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid #333; margin-bottom: 15px; position: relative; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-link { font-size: 11px; opacity: 0.5; cursor: pointer; text-align: center; color: var(--gold); flex: 1; }
        .nav-link.active-link { opacity: 1; font-weight: bold; }

        #maze-container { display: grid; margin: 15px auto; background: #111; border: 2px solid var(--gold); gap: 2px; padding: 2px; width: 100%; max-width: 320px; }
        .cell { width: 100%; aspect-ratio: 1/1; background: #000; display: flex; align-items: center; justify-content: center; }
        .wall { background: #333; }
        .player { background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px var(--gold); }
        .finish { background: var(--green); box-shadow: 0 0 10px var(--green); }
        
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 180px; margin: 15px auto; }
        .ctrl-btn { background: #222; border: 1px solid var(--gold); color: var(--gold); padding: 20px; border-radius: 15px; cursor: pointer; font-size: 20px; touch-action: manipulation; }

        .timer-bar-container { background: #222; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: var(--red); transition: linear; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:50px; height:50px; border:5px solid #111; border-top:5px solid var(--gold); border-radius:50%; animation:rotate 1s linear infinite;"></div>
    <p style="color:var(--gold); margin-top:15px; letter-spacing:2px;">AQL JANGI</p>
</div>

<div class="container">
    <div id="auth">
        <h1 id="txt-app-title" style="font-size: 40px; margin-top: 40px;">Aql Jangi</h1>
        <p id="txt-app-slogan">Tezkor Labirint Turniri</p>
        <select id="reg-lang" class="reg-input" onchange="window.switchLang(this.value)">
            <option value="uz">O'zbekcha üá∫üáø</option>
            <option value="uz_cyr">–é–∑–±–µ–∫—á–∞ üá∫üáø</option>
        </select>
        <input type="text" id="reg-name" class="reg-input" placeholder="Ismingiz">
        <input type="text" id="reg-surname" class="reg-input" placeholder="Familiyangiz">
        <button class="btn-main" id="btn-next" onclick="register()">DAVOM ETISH</button>
    </div>

    <div id="onboarding">
        <div class="quiz-card">
            <h2 id="ob-title" style="color:var(--gold)"></h2>
            <p id="ob-desc" style="color:#fff; line-height:1.6; white-space: pre-line;"></p>
            <button class="btn-main" id="btn-ob-next" onclick="nextObStep()">KEYINGISI</button>
        </div>
    </div>

    <div id="tournament">
        <h2 id="txt-tour-title" style="color:var(--gold)">‚öîÔ∏è TURNIR MARKAZI</h2>
        <div class="quiz-card">
            <p id="tour-status-msg" style="font-weight:bold;"></p>
            <div style="margin:15px 0; background:#111; padding:15px; border-radius:15px; border:1px dashed var(--gold); text-align:left;">
                <p id="txt-pay-info">üí∞ Kirish: <b>5 000 so'm</b></p>
                <p>üí≥ Karta: <code>4073 4200 6816 5541</code></p>
                <p>üë§ Ega: <b>Maruf Raxmonov</b></p>
            </div>
            <div style="margin-bottom:15px;">
                <span id="txt-p-label">Ishtirokchilar:</span> <b id="p-count">0</b> / 30
            </div>
            <input type="file" id="receipt-input" accept="image/*" style="display:none;" onchange="handleReceipt(this)">
            <button class="btn-main" id="btn-upload" style="background:#222; color:var(--gold); border:1px solid #444; margin-bottom:10px;" onclick="document.getElementById('receipt-input').click()">CHEKNI YUKLASH</button>
            <button class="btn-main" id="btn-pay" onclick="pay()">TO'LOV QILDIM</button>
            <button class="btn-main" id="btn-start" style="display:none; background:var(--green); color:#fff;" onclick="startTurnir()">TURNIRNI BOSHLASH</button>
        </div>
    </div>

    <div id="game">
        <div class="quiz-card">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
                <span id="lvl-label" style="color:var(--gold)"></span>
                <span>Vaqt: <b id="game-timer">0.0</b>s</span>
                <span><b id="maze-idx">1</b>/10</span>
            </div>
            <div class="timer-bar-container"><div id="timer-bar"></div></div>
            <div id="maze-container"></div>
            <div class="controls">
                <div></div><button class="ctrl-btn" onclick="move('up')">‚ñ≤</button><div></div>
                <button class="ctrl-btn" onclick="move('left')">‚óÄ</button>
                <button class="ctrl-btn" onclick="move('down')">‚ñº</button>
                <button class="ctrl-btn" onclick="move('right')">‚ñ∂</button>
            </div>
        </div>
    </div>

    <div id="result-screen">
        <div class="quiz-card">
            <h2 id="res-title">BOSQICH TUGADI!</h2>
            <p id="txt-final-res">Jami vaqtingiz:</p>
            <b id="final-time" style="font-size:24px; color:var(--gold);">0.0</b>s
            <button class="btn-main" id="btn-res-next" onclick="checkNext()">DAVOM ETISH</button>
        </div>
    </div>

    <div id="leaderboard">
        <h2 id="txt-rank-title" style="color:var(--gold)">üèÜ REYTING</h2>
        <div id="rank-list" class="quiz-card" style="padding:10px;"></div>
    </div>
</div>

<div class="bottom-nav" id="navbar" style="display:none">
    <div class="nav-link" id="nav-tour" onclick="navigate('tournament')">‚öîÔ∏è<br><span id="txt-nav-tour">Turnir</span></div>
    <div class="nav-link" id="nav-rank" onclick="navigate('leaderboard')">üèÜ<br><span id="txt-nav-rank">Reyting</span></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI", authDomain: "gen-lang-client-0228947349.firebaseapp.com", databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com", projectId: "gen-lang-client-0228947349", appId: "1:253793341504:web:709752258000dab44fcfa5" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id || "tester_maruf";
    const userRef = ref(db, 'brain_users/' + uid);

    let userData = { lang: 'uz' };
    let maze = [], player = {x:0, y:0}, finish = {x:0, y:0}, size = 6;
    let startTime, timerInt, sessionTime = 0, currentIdx = 0, level = "oson";
    let receiptData = null, obStep = 0, timeLimit = 30;

    const translations = {
        uz: {
            title: "Aql Jangi", slogan: "Tezkor Labirint Turniri", name: "Ismingiz", surname: "Familiyangiz", next: "DAVOM ETISH",
            tour: "Turnir", rank: "Reyting", pLabel: "Ishtirokchilar:", upload: "CHEKNI YUKLASH", pay: "TO'LOV QILDIM",
            final: "Jami vaqtingiz:", resTitle: "BOSQICH TUGADI!", payMsg: "To'lov qiling va chekni yuklang.",
            ob: [
                { t: "Ilova maqsadi", d: "Aql Jangi ‚Äî bu sizning tezkorligingiz va diqqatingizni sinovdan o'tkazuvchi intellektual turnir platformasidir." },
                { t: "Turnir qoidalari", d: "1. Labirintdan eng tez chiqqan g'olib bo'ladi.\n2. Jami 30 ta bosqich (10 oson, 10 o'rta, 10 qiyin).\n3. Devorlarga tegish mumkin emas." },
                { t: "Sovrinlar üèÜ", d: "ü•á 1-o'rin: 80 000 so'm\nü•à 2-o'rin: 50 000 so'm\nü•â 3-o'rin: 20 000 so'm\nJami 30 ta joy bor!" }
            ],
            confirm: "Shartlarga roziman va to'lov qilishga o'taman", wait: "To'lov tekshirilmoqda..."
        },
        uz_cyr: {
            title: "–ê“õ–ª –ñ–∞–Ω–≥–∏", slogan: "–¢–µ–∑–∫–æ—Ä –õ–∞–±–∏—Ä–∏–Ω—Ç –¢—É—Ä–Ω–∏—Ä–∏", name: "–ò—Å–º–∏–Ω–≥–∏–∑", surname: "–§–∞–º–∏–ª–∏—è–Ω–≥–∏–∑", next: "–î–ê–í–û–ú –≠–¢–ò–®",
            tour: "–¢—É—Ä–Ω–∏—Ä", rank: "–†–µ–π—Ç–∏–Ω–≥", pLabel: "–ò—à—Ç–∏—Ä–æ–∫—á–∏–ª–∞—Ä:", upload: "–ß–ï–ö–ù–ò –Æ–ö–õ–ê–®", pay: "–¢–é–õ–û–í “ö–ò–õ–î–ò–ú",
            final: "–ñ–∞–º–∏ –≤–∞“õ—Ç–∏–Ω–≥–∏–∑:", resTitle: "–ë–û–°“ö–ò–ß –¢–£–ì–ê–î–ò!", payMsg: "–¢—û–ª–æ–≤ “õ–∏–ª–∏–Ω–≥ –≤–∞ —á–µ–∫–Ω–∏ —é–∫–ª–∞–Ω–≥.",
            ob: [
                { t: "–ò–ª–æ–≤–∞ –º–∞“õ—Å–∞–¥–∏", d: "–ê“õ–ª –ñ–∞–Ω–≥–∏ ‚Äî –±—É —Å–∏–∑–Ω–∏–Ω–≥ —Ç–µ–∑–∫–æ—Ä–ª–∏–≥–∏–Ω–≥–∏–∑ –≤–∞ –¥–∏“õ“õ–∞—Ç–∏–Ω–≥–∏–∑–Ω–∏ —Å–∏–Ω–æ–≤–¥–∞–Ω —û—Ç–∫–∞–∑—É–≤—á–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª —Ç—É—Ä–Ω–∏—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å–∏–¥–∏—Ä." },
                { t: "–¢—É—Ä–Ω–∏—Ä “õ–æ–∏–¥–∞–ª–∞—Ä–∏", d: "1. –õ–∞–±–∏—Ä–∏–Ω—Ç–¥–∞–Ω —ç–Ω–≥ —Ç–µ–∑ —á–∏“õ“õ–∞–Ω “ì–æ–ª–∏–± –±—û–ª–∞–¥–∏.\n2. –ñ–∞–º–∏ 30 —Ç–∞ –±–æ—Å“õ–∏—á (10 –æ—Å–æ–Ω, 10 —û—Ä—Ç–∞, 10 “õ–∏–π–∏–Ω).\n3. –î–µ–≤–æ—Ä–ª–∞—Ä–≥–∞ —Ç–µ–≥–∏—à –º—É–º–∫–∏–Ω —ç–º–∞—Å." },
                { t: "–°–æ–≤—Ä–∏–Ω–ª–∞—Ä üèÜ", d: "ü•á 1-—û—Ä–∏–Ω: 80 000 —Å—û–º\nü•à 2-—û—Ä–∏–Ω: 50 000 —Å—û–º\nü•â 3-—û—Ä–∏–Ω: 20 000 —Å—û–º\n–ñ–∞–º–∏ 30 —Ç–∞ –∂–æ–π –±–æ—Ä!" }
            ],
            confirm: "–®–∞—Ä—Ç–ª–∞—Ä–≥–∞ —Ä–æ–∑–∏–º–∞–Ω –≤–∞ —Ç—û–ª–æ–≤ “õ–∏–ª–∏—à–≥–∞ —û—Ç–∞–º–∞–Ω", wait: "–¢—û–ª–æ–≤ —Ç–µ–∫—à–∏—Ä–∏–ª–º–æ“õ–¥–∞..."
        }
    };

    window.switchLang = (l) => {
        userData.lang = l;
        const t = translations[l];
        document.getElementById('txt-app-title').innerText = t.title;
        document.getElementById('txt-app-slogan').innerText = t.slogan;
        document.getElementById('reg-name').placeholder = t.name;
        document.getElementById('reg-surname').placeholder = t.surname;
        document.getElementById('btn-next').innerText = t.next;
        document.getElementById('txt-tour-title').innerText = "‚öîÔ∏è " + t.tour.toUpperCase() + " MARKAZI";
        document.getElementById('txt-p-label').innerText = t.pLabel;
        document.getElementById('btn-upload').innerText = t.upload;
        document.getElementById('btn-pay').innerText = t.pay;
        document.getElementById('txt-rank-title').innerText = "üèÜ " + t.rank.toUpperCase();
        document.getElementById('txt-nav-tour').innerText = t.tour;
        document.getElementById('txt-nav-rank').innerText = t.rank;
        document.getElementById('res-title').innerText = t.resTitle;
        document.getElementById('txt-final-res').innerText = t.final;
        document.getElementById('btn-res-next').innerText = t.next;
    };

    window.register = async () => {
        const name = document.getElementById('reg-name').value, surname = document.getElementById('reg-surname').value;
        if(!name || !surname) return alert("To'liq to'ldiring!");
        userData.name = name; userData.surname = surname;
        userData.tourStatus = "none"; userData.totalTime = 0; userData.currentLevel = "oson";
        await set(userRef, userData);
        showScreen('onboarding'); showObStep();
    };

    function showObStep() {
        const t = translations[userData.lang].ob[obStep];
        document.getElementById('ob-title').innerText = t.t;
        document.getElementById('ob-desc').innerText = t.d;
        document.getElementById('btn-ob-next').innerText = obStep === 2 ? translations[userData.lang].confirm : translations[userData.lang].next;
    }

    window.nextObStep = () => { obStep < 2 ? (obStep++, showObStep()) : navigate('tournament'); };

    window.handleReceipt = (i) => { const r = new FileReader(); r.onload=(e)=>receiptData=e.target.result; r.readAsDataURL(i.files[0]); };

    window.pay = async () => {
        if(!receiptData) return alert(translations[userData.lang].payMsg);
        await update(userRef, { tourStatus: "pending", paymentReceipt: receiptData });
        alert("OK!"); loadTourStatus();
    };

    async function loadTourStatus() {
        const snap = await get(userRef); userData = snap.val();
        const msg = document.getElementById('tour-status-msg');
        onValue(ref(db, 'brain_users'), (s) => {
            let count = 0; s.forEach(u => u.val().tourStatus === 'active' && count++);
            document.getElementById('p-count').innerText = count;
            if(userData.tourStatus === 'active' && count >= 30) document.getElementById('btn-start').style.display='block';
        });
        msg.innerText = userData.tourStatus === 'pending' ? translations[userData.lang].wait : (userData.tourStatus === 'active' ? "Siz turnirdasiz!" : translations[userData.lang].payMsg);
    }

    // O'yin mantiqi (Maze generation va move o'zgarmadi, lekin UI tillari qo'shildi)
    window.startTurnir = () => {
        level = userData.currentLevel;
        size = level === "oson" ? 6 : (level === "ortacha" ? 10 : 15);
        timeLimit = level === "oson" ? 30 : (level === "ortacha" ? 45 : 60);
        currentIdx = 0; sessionTime = 0;
        showScreen('game'); document.getElementById('lvl-label').innerText = level.toUpperCase();
        generateMaze();
    };

    function generateMaze() {
        maze = Array(size).fill().map(() => Array(size).fill(1));
        const walk = (x, y) => {
            maze[y][x] = 0;
            const dirs = [{x:0,y:-2},{x:0,y:2},{x:-2,y:0},{x:2,y:0}].sort(() => Math.random()-0.5);
            dirs.forEach(d => {
                let nx=x+d.x, ny=y+d.y;
                if(nx>=0 && nx<size && ny>=0 && ny<size && maze[ny][nx]===1) { maze[y+d.y/2][x+d.x/2] = 0; walk(nx, ny); }
            });
        };
        walk(0, 0); player = {x:0, y:0}; finish = {x:size-1, y:size-1}; maze[size-1][size-1] = 0;
        renderMaze();
        startTime = Date.now();
        if(timerInt) clearInterval(timerInt);
        timerInt = setInterval(updateTimer, 100);
    }

    function updateTimer() {
        let diff = (Date.now() - startTime) / 1000;
        document.getElementById('game-timer').innerText = diff.toFixed(1);
        let per = Math.max(0, 100 - (diff / timeLimit * 100));
        document.getElementById('timer-bar').style.width = per + "%";
        if(diff >= timeLimit) { clearInterval(timerInt); alert("Vaqt tugadi!"); startTurnir(); }
    }

    function renderMaze() {
        const con = document.getElementById('maze-container');
        con.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        con.innerHTML = "";
        for(let y=0; y<size; y++) {
            for(let x=0; x<size; x++) {
                const c = document.createElement('div');
                c.className = `cell ${maze[y][x]?'wall':''}`;
                if(x===player.x && y===player.y) c.classList.add('player');
                if(x===finish.x && y===finish.y) c.classList.add('finish');
                con.appendChild(c);
            }
        }
    }

    window.move = (dir) => {
        let nx=player.x, ny=player.y;
        if(dir==='up') ny--; if(dir==='down') ny++; if(dir==='left') nx--; if(dir==='right') nx++;
        if(nx>=0 && nx<size && ny>=0 && ny<size && maze[ny][nx]===0) {
            player = {x:nx, y:ny}; renderMaze();
            if(nx===finish.x && ny===finish.y) {
                clearInterval(timerInt);
                sessionTime += (Date.now()-startTime)/1000;
                if(currentIdx < 9) { currentIdx++; document.getElementById('maze-idx').innerText=currentIdx+1; generateMaze(); }
                else { showScreen('result-screen'); document.getElementById('final-time').innerText=sessionTime.toFixed(1); }
            }
        }
    };

    window.checkNext = async () => {
        let newTime = (userData.totalTime || 0) + sessionTime;
        let nextLvl = level === "oson" ? "ortacha" : (level === "ortacha" ? "qiyin" : "finished");
        if(nextLvl === "finished") { await update(userRef, { totalTime: newTime, tourStatus: "done" }); alert("OK!"); navigate('tournament'); }
        else { await update(userRef, { totalTime: newTime, currentLevel: nextLvl }); userData.currentLevel = nextLvl; startTurnir(); }
    };

    window.navigate = (id) => {
        document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id==='tournament') { loadTourStatus(); document.getElementById('navbar').style.display='flex'; }
        if(id==='leaderboard') fetchRank();
    };

    async function fetchRank() {
        const snap = await get(ref(db, 'brain_users'));
        let list = []; snap.forEach(u => u.val().tourStatus === 'done' && list.push(u.val()));
        list.sort((a,b) => a.totalTime - b.totalTime);
        document.getElementById('rank-list').innerHTML = list.map((u, i) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;"><span>${i+1}. ${u.name} ${u.surname}</span><b>${u.totalTime.toFixed(1)}s</b></div>`).join('') || "...";
    }

    function showScreen(id) { document.querySelectorAll('.container > div').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    window.onload = async () => {
        window.switchLang('uz'); // Default
        const snap = await get(userRef); document.getElementById('loader').style.display='none';
        if(snap.exists() && snap.val().name) { userData = snap.val(); window.switchLang(userData.lang); navigate('tournament'); }
        else { showScreen('auth'); }
    };
</script>
</body>
</html>
