<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGate: OneID Secure System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <style>
        :root { --tg-color: #248b65; --gold: #d4af37; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .container { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        
        .mrz-zone { border: 2px solid var(--gold); background: #fffdf2; padding: 15px; border-radius: 12px; margin-bottom: 20px; position: relative; }
        .mrz-line { font-family: 'Courier New', Courier, monospace; font-size: 11px; letter-spacing: 2px; color: #333; }
        
        .form-group { text-align: left; margin-bottom: 12px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
        input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9; font-weight: 500; }
        
        button { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-scan { background: var(--gold); color: #fff; margin-bottom: 15px; }
        .btn-save { background: var(--tg-color); color: #fff; }
        
        .loader { display: none; margin: 10px auto; border: 3px solid #f3f3f3; border-top: 3px solid var(--gold); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="loader" class="loader"></div>

    <div id="view-reg" class="card hidden">
        <h2 style="color: var(--tg-color); margin-bottom: 5px;">Shaxsni tasdiqlash</h2>
        <p style="font-size: 12px; color: #666; margin-bottom: 20px;">Pasportning pastki (MRZ) qismini skanerlang</p>
        
        <div class="mrz-zone" onclick="document.getElementById('pass-input').click()">
            <div id="mrz-status">üì∏ Pasport rasmini yuklash</div>
            <input type="file" id="pass-input" accept="image/*" class="hidden" onchange="readPassport(event)">
        </div>

        <div id="profile-fields">
            <div class="form-group"><label>To'liq ism-sharif</label><input type="text" id="p-name" readonly></div>
            <div class="form-group"><label>Pasport seriyasi va raqami</label><input type="text" id="p-ser" readonly></div>
            <div class="form-group"><label>Tug'ilgan sana</label><input type="text" id="p-dob" readonly></div>
            <div class="form-group"><label>Jinsi</label><input type="text" id="p-sex" readonly></div>
            <div class="form-group"><label>Telefon raqami</label><input type="tel" id="p-phone" placeholder="+998901234567"></div>
            <div class="form-group">
                <label>Rolni tanlang</label>
                <select id="p-role" style="width:100%; padding:12px; border-radius:8px; border:1px solid #eee;">
                    <option value="student">Talaba</option>
                    <option value="teacher">O'qituvchi</option>
                </select>
            </div>
        </div>

        <button class="btn-save" onclick="finishReg()">Tizimni faollashtirish</button>
    </div>

    <div id="view-main" class="card hidden">
        <h3 id="u-display">Xush kelibsiz</h3>
        <p id="u-role" style="font-size: 13px; color: var(--tg-color);"></p>
        <div style="font-size: 50px; margin: 20px 0;">üè¢</div>
        <button class="btn-save" id="btn-check" onclick="doSecureCheck()">Davomatni tasdiqlash (GPS+Bio)</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    const bm = tg.BiometricManager;
    tg.ready(); tg.expand();

    const tid = tg.initDataUnsafe.user?.id || "test_id";
    const UNI = { lat: 39.800911, lon: 64.426838 };

    // Tizimga kirishni tekshirish
    get(ref(db, `users/${tid}`)).then(snap => {
        if (!snap.exists()) {
            document.getElementById('view-reg').classList.remove('hidden');
        } else {
            loadApp(snap.val());
        }
    });

    // Pasport MRZ skanerlash
    window.readPassport = function(e) {
        const file = e.target.files[0];
        document.getElementById('loader').style.display = 'block';
        document.getElementById('mrz-status').innerText = "Ma'lumotlar o'qilmoqda...";

        Tesseract.recognize(file, 'eng', { logger: m => console.log(m) })
        .then(({ data: { text } }) => {
            document.getElementById('loader').style.display = 'none';
            const mrzLines = text.toUpperCase().split('\n').filter(l => l.includes('<<'));
            
            if (mrzLines.length >= 2) {
                // MRZ Line 1: P<UZBNAME<<SURNAME<<<<<<<<
                const line1 = mrzLines[0];
                const names = line1.substring(5).split('<<');
                document.getElementById('p-name').value = names[1] + " " + names[0].replace(/</g, '');

                // MRZ Line 2: PASSPORT#<CHECKDIGIT<UZB<DOB<SEX...
                const line2 = mrzLines[1];
                document.getElementById('p-ser').value = line2.substring(0, 9);
                document.getElementById('p-dob').value = line2.substring(13, 19);
                document.getElementById('p-sex').value = line2.substring(20, 21) === 'M' ? 'Erkak' : 'Ayol';
                
                document.getElementById('mrz-status').innerText = "‚úÖ Ma'lumotlar olindi";
            } else {
                tg.showAlert("Pasport MRZ qismi o'qilmadi. Iltimos, pastki qismini aniqroq oling.");
            }
        });
    };

    window.finishReg = function() {
        const d = {
            fullName: document.getElementById('p-name').value,
            passport: document.getElementById('p-ser').value,
            dob: document.getElementById('p-dob').value,
            sex: document.getElementById('p-sex').value,
            phone: document.getElementById('p-phone').value,
            role: document.getElementById('p-role').value,
            isVerified: true
        };
        if(!d.fullName || !d.phone) return tg.showAlert("Ma'lumotlar to'liq emas!");
        set(ref(db, `users/${tid}`), d).then(() => location.reload());
    };

    function loadApp(data) {
        document.getElementById('view-main').classList.remove('hidden');
        document.getElementById('u-display').innerText = data.fullName;
        document.getElementById('u-role').innerText = data.role === 'teacher' ? "O'qituvchi" : "Talaba";
    }

    window.doSecureCheck = function() {
        navigator.geolocation.getCurrentPosition(pos => {
            const dist = Math.sqrt((pos.coords.latitude - UNI.lat)**2 + (pos.coords.longitude - UNI.lon)**2);
            if (dist <= 0.003) { // Taxminan 300 metr
                bm.authenticate({ reason: "Shaxsingizni tasdiqlang" }, ok => {
                    if (ok) tg.showAlert("Davomat muvaffaqiyatli! ‚úÖ");
                });
            } else tg.showAlert("Siz universitetda emassiz!");
        }, null, {enableHighAccuracy: true});
    };
</script>
</body>
</html>
