<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Platform Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #0a0a0b; --card: #16161e; --gold: #f0b90b; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; margin: 0; padding-bottom: 80px; user-select: none; }
        #auth, #app { display: none; padding: 25px; text-align: center; }
        input, select { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #333; background: var(--card); color: #fff; margin-bottom: 15px; outline: none; box-sizing: border-box; }
        .btn { border: none; padding: 18px; border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.2s; }
        .btn-p { background: var(--p); color: #fff; }
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { font-size: 10px; opacity: 0.5; cursor: pointer; text-align: center; }
        .nav-item.active { opacity: 1; color: var(--p); }
        .panel { display: none; }
        .active-p { display: block; }

        /* Game Selection */
        .game-menu { display: flex; gap: 10px; margin-bottom: 20px; }
        .g-tab { flex: 1; padding: 10px; background: var(--card); border-radius: 10px; font-size: 12px; border: 1px solid #333; }
        .g-tab.active { border-color: var(--p); background: #251b3d; }

        /* Crash UI */
        canvas { width: 100%; height: 180px; background: #000; border-radius: 15px; margin: 10px 0; border: 1px solid #222; }
        #mult { font-size: 50px; font-weight: 800; color: var(--p); margin: 10px 0; }

        /* 21 Achka UI */
        .bj-area { background: #07470e; border-radius: 15px; padding: 15px; min-height: 200px; border: 4px solid #0a310e; position: relative; }
        .cards-row { display: flex; justify-content: center; gap: 5px; min-height: 80px; margin: 10px 0; }
        .card-img { width: 50px; height: 75px; background: #fff; border-radius: 5px; color: #000; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .score { font-size: 14px; background: rgba(0,0,0,0.5); padding: 2px 10px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="auth">
    <h2 style="color: var(--p);">Ro'yxatdan o'tish</h2>
    <input type="text" id="r-name" placeholder="Ism">
    <input type="text" id="r-surname" placeholder="Familiya">
    <select id="r-region"><option value="Toshkent">Toshkent</option><option value="Samarqand">Samarqand</option></select>
    <select id="r-currency"><option value="UZS">UZS</option><option value="USD">USD</option></select>
    <button class="btn btn-p" id="regBtn">BARMOQ IZI BILAN TASDIQLASH</button>
</div>

<div id="app">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span id="u-name" style="font-weight: bold;">...</span>
        <div style="background: var(--p); padding: 6px 14px; border-radius: 20px; font-size: 14px;">
            <span id="u-bal">0</span> <span id="u-unit">UZS</span>
        </div>
    </div>

    <div id="p-games" class="panel active-p">
        <div class="game-menu">
            <div class="g-tab active" onclick="switchGame('crash', this)">üöÄ Crash</div>
            <div class="g-tab" onclick="switchGame('21', this)">üÉè 21 Achka</div>
        </div>

        <div id="game-crash">
            <canvas id="gameCanvas"></canvas>
            <div id="mult">1.00x</div>
            <input type="number" id="bet-crash" placeholder="Tikish miqdori">
            <button id="crashBtn" class="btn btn-p">TIKISH</button>
        </div>

        <div id="game-21" style="display: none;">
            <div class="bj-area">
                <div class="score">Diler: <span id="d-score">0</span></div>
                <div id="d-cards" class="cards-row"></div>
                <hr style="opacity: 0.2;">
                <div id="p-cards" class="cards-row"></div>
                <div class="score">Siz: <span id="p-score">0</span></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <input type="number" id="bet-21" placeholder="Tikish">
                <button id="dealBtn" class="btn btn-p" style="width: 50%;">START</button>
            </div>
            <div id="bj-controls" style="display: none; gap: 10px; margin-top: 10px;">
                <button class="btn" style="background: #28a745; color:#fff;" onclick="hit()">+ KARTA</button>
                <button class="btn" style="background: #dc3545; color:#fff;" onclick="stand()">STOP</button>
            </div>
        </div>
    </div>

    <div id="p-dep" class="panel"><h3>üí≥ To'ldirish</h3><input type="number" id="dep-val" placeholder="Summa"><button class="btn btn-p" onclick="sendReq('dep')">TO'LADIM</button></div>
    <div id="p-wit" class="panel"><h3>üì§ Pul yechish</h3><input type="number" id="wit-val" placeholder="Summa"><button class="btn btn-p" onclick="sendReq('wit')">CHIQARISH</button></div>

    <div class="nav">
        <div class="nav-item active" onclick="nav('games', this)">üéÆ<br>O'yinlar</div>
        <div class="nav-item" onclick="nav('dep', this)">üí≥<br>Hamyon</div>
        <div class="nav-item" onclick="nav('wit', this)">üì§<br>Chiqarish</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const bio = tg.BiometricManager;
    bio.init();

    const uid = tg.initDataUnsafe?.user?.id || "user_8363919942";
    const userRef = ref(db, 'users/' + uid);
    let userData = { balance: 0 };

    // --- INITIALIZATION ---
    window.onload = async () => {
        const s = await get(userRef);
        if(s.exists()) loadApp(s.val());
        else document.getElementById('auth').style.display = 'block';
    };

    function loadApp(data) {
        userData = data;
        document.getElementById('auth').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('u-name').innerText = data.name;
        document.getElementById('u-unit').innerText = data.cur;
        onValue(ref(db, `users/${uid}/balance`), (s) => {
            userData.balance = s.val() || 0;
            document.getElementById('u-bal').innerText = Math.floor(userData.balance).toLocaleString();
        });
    }

    // --- REGISTRATION ---
    document.getElementById('regBtn').onclick = () => {
        bio.requestAccess({ reason: "Skaner" }, (a) => {
            if(a) bio.authenticate({ reason: "Tasdiqlang" }, async (s) => {
                if(s) {
                    const data = { name: document.getElementById('r-name').value, cur: document.getElementById('r-currency').value, balance: 0 };
                    await set(userRef, data); loadApp(data);
                }
            });
        });
    };

    // --- CRASH LOGIC ---
    let isRunning = false; let currentMult = 1.0; let gameLoop;
    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
    document.getElementById('crashBtn').onclick = () => {
        if(!isRunning) startCrash(); else cashOut();
    };

    function startCrash() {
        const bet = parseFloat(document.getElementById('bet-crash').value);
        if(!bet || bet > userData.balance) return alert("Balans kam!");
        isRunning = true; currentMult = 1.0; let crashPoint = (Math.random() * 4 + 1.1).toFixed(2);
        set(ref(db, `users/${uid}/balance`), userData.balance - bet);
        document.getElementById('crashBtn').innerText = "CASH OUT";
        let start = Date.now();
        gameLoop = setInterval(() => {
            currentMult = Math.pow(1.07, (Date.now() - start)/100);
            document.getElementById('mult').innerText = currentMult.toFixed(2) + "x";
            draw( (Date.now() - start)/1000 );
            if(currentMult >= crashPoint) { clearInterval(gameLoop); isRunning = false; document.getElementById('mult').innerText = "BOOM!"; document.getElementById('crashBtn').innerText = "TIKISH"; }
        }, 60);
    }
    function draw(t) { ctx.clearRect(0,0,300,200); ctx.strokeStyle="#7b42f5"; ctx.lineWidth=5; ctx.beginPath(); ctx.moveTo(0,180); ctx.lineTo(t*20, 180-Math.pow(1.07, t*10)*5); ctx.stroke(); }
    function cashOut() { clearInterval(gameLoop); isRunning = false; let win = parseFloat(document.getElementById('bet-crash').value) * currentMult; set(ref(db, `users/${uid}/balance`), userData.balance + win); alert("Yutdingiz!"); document.getElementById('crashBtn').innerText = "TIKISH"; }

    // --- 21 ACHKA LOGIC ---
    let pCards = []; let dCards = [];
    document.getElementById('dealBtn').onclick = () => {
        const bet = parseFloat(document.getElementById('bet-21').value);
        if(!bet || bet > userData.balance) return alert("Balans kam!");
        set(ref(db, `users/${uid}/balance`), userData.balance - bet);
        pCards = [randCard(), randCard()]; dCards = [randCard()];
        updateBJ(); document.getElementById('bj-controls').style.display = 'flex';
    };

    window.hit = () => { pCards.push(randCard()); updateBJ(); if(calc(pCards) > 21) finishBJ("YUTQAZDINGIZ!"); };
    window.stand = () => { while(calc(dCards) < 17) dCards.push(randCard()); updateBJ(); 
        let ps = calc(pCards), ds = calc(dCards);
        if(ds > 21 || ps > ds) { finishBJ("YUTDINGIZ!"); set(ref(db, `users/${uid}/balance`), userData.balance + (document.getElementById('bet-21').value * 2)); }
        else finishBJ("DILER YUTDI!");
    };

    function randCard() { return Math.floor(Math.random() * 9) + 2; }
    function calc(arr) { return arr.reduce((a,b) => a+b, 0); }
    function updateBJ() {
        document.getElementById('p-cards').innerHTML = pCards.map(c => `<div class="card-img">${c}</div>`).join('');
        document.getElementById('d-cards').innerHTML = dCards.map(c => `<div class="card-img">${c}</div>`).join('');
        document.getElementById('p-score').innerText = calc(pCards);
        document.getElementById('d-score').innerText = calc(dCards);
    }
    function finishBJ(m) { alert(m); document.getElementById('bj-controls').style.display = 'none'; }

    // --- UI HELPERS ---
    window.switchGame = (g, el) => {
        document.getElementById('game-crash').style.display = g === 'crash' ? 'block' : 'none';
        document.getElementById('game-21').style.display = g === '21' ? 'block' : 'none';
        document.querySelectorAll('.g-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    };
    window.nav = (p, el) => {
        document.querySelectorAll('.panel').forEach(x => x.style.display = 'none');
        document.getElementById('p-' + p).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
    };
    window.sendReq = async (t) => {
        const amt = parseFloat(document.getElementById(t === 'dep' ? 'dep-val' : 'wit-val').value);
        await set(ref(db, 'requests/' + uid), { name: userData.name, amount: amt, type: t, currency: userData.cur });
        alert("So'rov yuborildi!");
    };
</script>
</body>
</html>
