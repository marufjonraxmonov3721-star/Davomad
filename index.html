<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro: Smart Focus</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #000; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .app-box { height: 100vh; display: flex; flex-direction: column; }
        video#v { width: 100%; flex-grow: 1; background: #000; }
        .p-panel { background: linear-gradient(135deg, var(--p), #4b0082); padding: 15px; text-align: center; }
        #cam-view { position: absolute; top: 10px; right: 10px; width: 70px; border-radius: 8px; border: 1px solid #fff; opacity: 0.5; transform: scaleX(-1); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div id="loader" style="padding: 50px; text-align: center;">
    <h2 style="color: var(--p);">ðŸŽ¬ KINO PRO</h2>
    <p>Nigohingizni aniqlash tizimi ishga tushmoqda...</p>
    <button style="padding: 15px 30px; border-radius: 10px; border: none; font-weight: bold;" onclick="document.getElementById('file').click()">KINO TANLASH</button>
    <input type="file" id="file" hidden accept="video/*" onchange="startSmartApp(event)">
</div>

<div id="player" class="app-box" style="display: none;">
    <video id="cam-view" autoplay muted playsinline></video>
    <video id="v" controls playsinline></video>
    <div class="p-panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span><span id="dot" class="status-dot" style="background: grey;"></span> <b id="s-text">Tayyorlanmoqda...</b></span>
            <span id="vol-text">Ovoz: 100%</span>
        </div>
        <button onclick="Telegram.WebApp.close()" style="margin-top: 10px; width: 100%; background: #000; color: white; border: none; padding: 10px; border-radius: 8px;">YOPISH</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const v = document.getElementById('v');
    const sText = document.getElementById('s-text');
    const dot = document.getElementById('dot');
    let volume = 1.0;
    let failCount = 0;

    async function startSmartApp(e) {
        const file = e.target.files[0];
        if(!file) return;

        // Modellar (faqat eng keraklisi)
        const URL_MODEL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
        await faceapi.nets.tinyFaceDetector.loadFromUri(URL_MODEL);

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        document.getElementById('cam-view').srcObject = stream;

        v.src = URL.createObjectURL(file);
        document.getElementById('loader').style.display = 'none';
        document.getElementById('player').style.display = 'flex';
        v.play();
        
        trackPresence();
    }

    function trackPresence() {
        setInterval(async () => {
            if (v.paused) return;

            const detection = await faceapi.detectSingleFace(
                document.getElementById('cam-view'), 
                new faceapi.TinyFaceDetectorOptions()
            );

            if (detection) {
                // Yuz aniqlandi - Uyg'oq
                failCount = 0;
                volume = 1.0;
                v.volume = 1.0;
                sText.innerText = "Nigohingiz ekranda âœ…";
                dot.style.background = "#00ff00";
            } else {
                // Yuz yo'qoldi (Ko'z yumildi yoki bosh egildi)
                failCount++;
                if (failCount > 3) { // 3 soniyadan keyin jazo boshlanadi
                    volume -= 0.2;
                    if (volume < 0) volume = 0;
                    v.volume = volume;
                    sText.innerText = `Uxladingizmi? (${Math.round(volume*100)}%)`;
                    dot.style.background = "red";
                }
            }

            document.getElementById('vol-text').innerText = `Ovoz: ${Math.round(v.volume*100)}%`;

            if (v.volume <= 0) {
                v.pause();
                alert("Siz uxlab qoldingiz. Telegram yopiladi.");
                tg.close();
            }
        }, 1000); // Har soniyada tekshiradi
    }
</script>
</body>
</html>
