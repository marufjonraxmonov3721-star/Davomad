<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro TWA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #000; }
        body { 
            background: var(--bg); color: white; font-family: sans-serif; 
            margin: 0; padding: 0; overflow: hidden;
            -webkit-touch-callout: none; -webkit-user-select: none;
        }
        
        .tg-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .player-card { width: 100%; max-width: 500px; background: #111; position: relative; }
        video#v { width: 100%; display: block; aspect-ratio: 16/9; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(123, 66, 245, 0.95); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }

        .controls { background: linear-gradient(135deg, var(--p), #4b0082); padding: 15px; }
        
        #debug-cam { 
            position: absolute; top: 5px; right: 5px; width: 50px; height: 38px; 
            border-radius: 4px; opacity: 0.5; border: 1px solid #fff; 
            transform: scaleX(-1); pointer-events: none;
        }

        .btn-tg { 
            background: #fff; color: #000; border: none; padding: 12px; 
            border-radius: 8px; font-weight: bold; width: 90%; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="tg-container" id="loader-view">
    <div style="text-align: center; padding: 20px;">
        <h2 style="color: var(--p);">üé¨ KINO PRO</h2>
        <p>Telegram uchun maxsus tayyorlandi</p>
        <button class="btn-tg" onclick="document.getElementById('f').click()">KINO TANLASH</button>
        <input type="file" id="f" hidden accept="video/*" onchange="initTelegramApp(event)">
    </div>
</div>

<div class="tg-container" id="player-view" style="display: none;">
    <div class="player-card">
        <video id="debug-cam" autoplay muted playsinline></video>
        <video id="v" playsinline controls></video>
        
        <div id="sleep-overlay" class="overlay">
            <h2>UYQU REJIMI üò¥</h2>
            <p>Ko'zlar yopildi, video to'xtatildi.</p>
            <button class="btn-tg" onclick="wakeUp()">DAVOM ETTIRISH</button>
        </div>

        <div class="controls">
            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 8px;">
                <span>üëÅÔ∏è <b id="e-status">Aniqlanmoqda...</b></span>
                <span id="save-msg">AVTO-SAQLASH ‚úÖ</span>
            </div>
            <button class="btn-tg" onclick="Telegram.WebApp.close()" style="background: #000; color: #fff;">ILOVANI YOPISH</button>
        </div>
    </div>
</div>

<script>
    // Telegram Web App sozlamalari
    const tg = window.Telegram.WebApp;
    tg.expand(); // Ilovani to'liq ekranga yoyish
    tg.ready();

    const v = document.getElementById('v');
    const eStatus = document.getElementById('e-status');
    let eyeTimer = null;

    async function initTelegramApp(e) {
        const file = e.target.files[0];
        if(!file) return;

        eStatus.innerText = "Datchiklar yoqilmoqda...";
        
        // Modellar va Kamera (TWA uchun optimallashgan)
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
            ]);

            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user", width: 200 } 
            });
            document.getElementById('debug-cam').srcObject = stream;
        } catch (err) {
            alert("Kamera ruxsati berilmadi! Aqlli rejim ishlamaydi.");
        }

        v.src = URL.createObjectURL(file);
        document.getElementById('loader-view').style.display = 'none';
        document.getElementById('player-view').style.display = 'flex';
        
        // Eslab qolish
        const savedTime = localStorage.getItem(file.name);
        if(savedTime) v.currentTime = savedTime;

        v.play();
        startTracking();
    }

    function startTracking() {
        setInterval(async () => {
            if (v.paused) return;

            const detection = await faceapi.detectSingleFace(
                document.getElementById('debug-cam'), 
                new faceapi.TinyFaceDetectorOptions()
            ).withFaceLandmarks();

            if (detection) {
                const landmarks = detection.landmarks;
                const left = landmarks.getLeftEye();
                const right = landmarks.getRightEye();
                const eyeHeight = (left[4].y - left[1].y + right[4].y - right[1].y) / 2;
                
                if (eyeHeight < 2.3) { 
                    if (!eyeTimer) eyeTimer = Date.now();
                    let diff = Math.floor((Date.now() - eyeTimer) / 1000);
                    eStatus.innerText = `UYQU (${10 - diff}s)`;
                    eStatus.style.color = "red";
                    if (diff >= 10) { v.pause(); document.getElementById('sleep-overlay').style.display = 'flex'; }
                } else {
                    eyeTimer = null;
                    eStatus.innerText = "OCHIQ üëÄ";
                    eStatus.style.color = "#00ff00";
                }
            } else {
                eStatus.innerText = "YUZ YO'Q ‚ö†Ô∏è";
                eStatus.style.color = "orange";
            }
        }, 600);
    }

    function wakeUp() {
        document.getElementById('sleep-overlay').style.display = 'none';
        eyeTimer = null;
        v.play();
    }

    // Saqlash
    setInterval(() => {
        if(!v.paused) localStorage.setItem(v.src, v.currentTime);
    }, 5000);
</script>
</body>
</html>
