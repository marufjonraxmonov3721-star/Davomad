<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro: Smart Pulse</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #000; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        
        .main-container { height: 100vh; display: flex; flex-direction: column; }
        video { width: 100%; flex-grow: 1; background: #000; }

        /* Pulsatsiyalanuvchi doira */
        #pulse-dot {
            position: absolute; top: 20px; right: 20px;
            width: 15px; height: 15px; background: var(--p);
            border-radius: 50%; opacity: 0.4;
            box-shadow: 0 0 10px var(--p);
            animation: pulse-anim 2s infinite;
            pointer-events: none;
        }

        @keyframes pulse-anim {
            0% { transform: scale(1); opacity: 0.4; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0.4; }
        }

        .p-footer { background: linear-gradient(135deg, var(--p), #4b0082); padding: 15px; text-align: center; }
        
        .btn-action { background: #fff; color: #000; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; }
    </style>
</head>
<body onclick="resetInactivity()">

<div id="setup-view" style="display: flex; height: 100vh; justify-content: center; align-items: center; flex-direction: column; padding: 20px; text-align: center;">
    <h2 style="color: var(--p);">ðŸŽ¬ KINO PRO: PULSE</h2>
    <p>Har 10 soniyada harakatingizni kuzatadi</p>
    <button class="btn-action" onclick="document.getElementById('f').click()">KINO TANLASH</button>
    <input type="file" id="f" hidden accept="video/*" onchange="startApp(event)">
</div>

<div id="player-view" class="main-container" style="display: none;">
    <div id="pulse-dot"></div>
    <video id="v" controls playsinline onplay="startTracking()" onpause="stopTracking()"></video>
    
    <div class="p-footer">
        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px;">
            <span id="stat">Holat: Uyg'oq âœ…</span>
            <span id="timer">Qoldi: 10s</span>
        </div>
        <button onclick="Telegram.WebApp.close()" style="background: #000; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 5px; width: 100%;">ILOVANI YOPISH</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const v = document.getElementById('v');
    let timeLeft = 10; // Test uchun 10 soniya
    let pulseIdx;

    function startApp(e) {
        const file = e.target.files[0];
        if(!file) return;

        v.src = URL.createObjectURL(file);
        document.getElementById('setup-view').style.display = 'none';
        document.getElementById('player-view').style.display = 'flex';
        
        // Eslab qolish (LocalStorage)
        const savedTime = localStorage.getItem("kino_" + file.name);
        if(savedTime) v.currentTime = savedTime;

        v.play();
    }

    function startTracking() {
        clearInterval(pulseIdx);
        pulseIdx = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = `Qoldi: ${timeLeft}s`;

            if (timeLeft <= 0) {
                v.pause();
                document.getElementById('stat').innerText = "UYQU SEZILDI! ðŸ˜´";
                document.getElementById('stat').style.color = "yellow";
                
                // Agar 20 soniya ichida uyg'onmasa yopiladi
                setTimeout(() => {
                    if(v.paused) tg.close();
                }, 20000);
            }
        }, 1000);
    }

    function stopTracking() {
        clearInterval(pulseIdx);
    }

    function resetInactivity() {
        timeLeft = 10;
        document.getElementById('stat').innerText = "Holat: Uyg'oq âœ…";
        document.getElementById('stat').style.color = "white";
        if (v.paused && document.getElementById('player-view').style.display === 'flex') {
            v.play();
        }
    }

    // Progresni saqlash
    setInterval(() => {
        if(!v.paused) localStorage.setItem("kino_" + v.src, v.currentTime);
    }, 5000);
</script>
</body>
</html>
