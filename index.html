<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yakuniyga tayyorlovchi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        /* RANG REJIMLARI */
        :root { --bg: #ffffff; --text: #000000; --card: #ffffff; --nav-bg: #ffffff; --accent: #000000; }
        [data-theme="dark"] { --bg: #000000; --text: #ffffff; --card: #000000; --nav-bg: #000000; --accent: #ffffff; }
        
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; transition: 0.3s; overflow-x: hidden; }
        .container { padding: 20px; max-width: 600px; margin: auto; position: relative; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--nav-bg); display: flex; justify-content: space-around; padding: 15px 0; border-top: 2px solid var(--accent); z-index: 1000; }
        .nav-item { text-align: center; font-size: 10px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: var(--accent); }
        .header { text-align: center; font-weight: 800; font-size: 22px; padding: 35px 0 20px 0; text-transform: uppercase; }
        .card { background: var(--card); border: 2px solid var(--accent); padding: 20px; margin-bottom: 15px; border-radius: 12px; cursor: pointer; text-align: center; font-weight: 800; }
        #quiz-screen, #errors-screen, #settings-screen, #mode-screen, #result-screen, #payment-screen, #checking-screen, #welcome-screen, #registration-screen, #profile-screen { display: none; position: relative; }
        .timer-display { text-align: center; font-size: 42px; font-weight: 900; margin-bottom: 15px; color: var(--accent); display: block; text-shadow: 0 0 10px rgba(128, 128, 128, 0.3); }
        .mode-title { text-align: center; font-size: 20px; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; opacity: 0.8; }
        .question-text { font-size: 19px; font-weight: 600; margin-bottom: 20px; line-height: 1.5; }
        .option { border: 2px solid var(--accent); padding: 16px; margin: 12px 0; border-radius: 14px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .correct { background: #22c55e !important; color: white !important; border-color: #22c55e; }
        .wrong { background: #ef4444 !important; color: white !important; border-color: #ef4444; }
        .selected-exam { background: var(--accent) !important; color: var(--bg) !important; border-color: var(--accent); }
        .mode-btn { width: 100%; padding: 20px; margin: 10px 0; border: 2px solid var(--accent); background: transparent; color: var(--text); font-weight: 800; border-radius: 12px; cursor: pointer; font-size: 16px; text-transform: uppercase; }
        .theme-btn { width: 100%; padding: 18px; margin: 10px 0; border: 2px solid var(--accent); background: transparent; color: var(--text); font-weight: 800; border-radius: 10px; cursor: pointer; }
        .result-container, .payment-container, .checking-container, .welcome-container { background: var(--card); border: 4px solid var(--accent); padding: 40px 20px; border-radius: 25px; text-align: center; box-shadow: 0 0 30px rgba(128,128,128,0.2); }
        .big-score { font-size: 60px; font-weight: 900; margin: 20px 0; }
        .loader-spin { border: 4px solid rgba(128, 128, 128, 0.1); border-left-color: var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 30px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #receipt-upload { display: none; }
        .status-icon { font-size: 80px; display: block; margin-bottom: 10px; animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .subject-badge { background: var(--accent); color: var(--bg); padding: 8px 15px; border-radius: 8px; font-size: 18px; font-weight: 800; margin-top: 15px; display: inline-block; text-transform: uppercase; }
        .error-card { background: var(--card); border: 2px solid var(--accent); padding: 15px; margin-bottom: 10px; border-radius: 10px; text-align: left; position: relative; }
        .mode-badge { font-size: 9px; position: absolute; top: 15px; right: 15px; border: 1px solid var(--accent); padding: 2px 5px; border-radius: 4px; font-weight: 900; text-transform: uppercase; }
        .nav-controls { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
        .nav-btn { flex: 1; padding: 15px; border: 2px solid var(--accent); background: transparent; color: var(--text); font-weight: 800; border-radius: 12px; cursor: pointer; text-transform: uppercase; }
        .close-btn { position: absolute; top: 0; right: 0; font-size: 24px; font-weight: 900; color: var(--accent); cursor: pointer; z-index: 1001; padding: 15px; line-height: 1; }
        .finish-exam-btn { background: #ef4444 !important; color: white !important; border: none !important; margin-top: 20px; }

        /* REGISTRATION STYLES */
        .reg-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid var(--accent); background: transparent; color: var(--text); border-radius: 12px; font-size: 16px; font-weight: 600; box-sizing: border-box; }
        .reg-input::placeholder { color: var(--accent); opacity: 0.5; }

        /* TOUR & PROMO STYLES */
        .welcome-step { display: none; animation: fadeIn 0.5s ease; }
        .welcome-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .promo-banner { background: #22c55e; color: white; padding: 12px; border-radius: 12px; margin-bottom: 15px; font-size: 13px; font-weight: 800; line-height: 1.4; }
        .stat-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .stat-card { border: 2px solid var(--accent); padding: 10px; border-radius: 10px; text-align: center; }
        .stat-num { font-size: 22px; font-weight: 900; display: block; color: var(--accent); }

        /* PROFILE STYLES */
        .profile-card { background: var(--card); border: 2px solid var(--accent); border-radius: 20px; padding: 25px; margin-bottom: 20px; text-align: center; }
        .profile-avatar { width: 80px; height: 80px; background: var(--accent); color: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; font-weight: 900; margin: 0 auto 15px auto; }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed rgba(128,128,128,0.3); font-size: 14px; }
        .info-row b { text-transform: uppercase; }
    </style>
</head>
<body data-theme="dark">

<div class="container">
    <div id="welcome-screen" style="display: none;">
        <div class="welcome-container">
            <div class="welcome-step active" id="step1">
                <h1 style="font-size: 45px;">üöÄ</h1>
                <h2>XUSH KELIBSIZ!</h2>
                <p>Yakuniy imtihonlarga tayyorlanish uchun mo'ljallangan maxsus yordamchingizga xush kelibsiz.</p>
                <button class="mode-btn" onclick="nextStep(2)">KEYINGISI ‚û°Ô∏è</button>
            </div>
            <div class="welcome-step" id="step2">
                <h1 style="font-size: 45px;">üìä</h1>
                <h2>KENG BAZA</h2>
                <p>Ilovada barcha fanlardan minglab savollar mavjud. Har bir fan bo'yicha 20 ta bepul savol bilan bilimingizni sinab ko'rishingiz mumkin.</p>
                <button class="mode-btn" onclick="nextStep(3)">KEYINGISI ‚û°Ô∏è</button>
            </div>
            <div class="welcome-step" id="step3">
                <h1 style="font-size: 45px;">üì∏</h1>
                <h2>MUHIM ESLATMA!</h2>
                <p>Ilovada rasmli savollar bor. Agar rasmlar yaxshi ko'rinmasa, Sozlamalardan <b>"KUNDUZGI REJIM"</b>ni tanlashni maslahat beramiz.</p>
                <button class="mode-btn" onclick="showRegistration()">DAVOM ETISH ‚ú®</button>
            </div>
        </div>
    </div>

    <div id="registration-screen">
        <div class="welcome-container">
            <h1 style="font-size: 45px;">üë§</h1>
            <h2>RO'YXATDAN O'TISH</h2>
            <p>Ma'lumotlaringizni kiriting:</p>
            <input type="text" id="reg-firstname" class="reg-input" placeholder="Ismingiz">
            <input type="text" id="reg-lastname" class="reg-input" placeholder="Familiyangiz">
            <button class="mode-btn" id="reg-save-btn" onclick="finishRegistration()">SAQLASH VA BOSHLASH üöÄ</button>
        </div>
    </div>

    <div id="home-screen">
        <div class="header">Yakuniyga tayyorlovchi</div>
        <div id="loader" style="text-align:center;">Yuklanmoqda...</div>
        <div id="subjects-list"></div>
    </div>

    <div id="profile-screen">
        <div class="close-btn" onclick="showScreen('home')">‚úï</div>
        <div class="header">Mening Profilim</div>
        <div class="profile-card">
            <div class="profile-avatar" id="prof-initials">M</div>
            <h2 id="prof-fullname" style="margin: 5px 0; text-transform: uppercase;">ISM FAMILIYA</h2>
            <p id="prof-id" style="font-size: 11px; opacity: 0.6; margin-bottom: 20px;">ID: USER_000000</p>
            
            <div class="stat-box">
                <div class="stat-card"><span class="stat-num" id="prof-total-tests">0</span><span>Testlar</span></div>
                <div class="stat-card"><span class="stat-num" id="prof-avg-score">0</span><span>O'rtacha %</span></div>
            </div>

            <div class="info-row"><b>Ism:</b> <span id="info-fn">-</span></div>
            <div class="info-row"><b>Familiya:</b> <span id="info-ln">-</span></div>
            <div class="info-row"><b>Sana:</b> <span id="info-date">-</span></div>
        </div>
        <button class="mode-btn" style="background: #22c55e; color: white; border: none;" onclick="showScreen('home')">YANGI TEST BOSHLASH</button>
    </div>

    <div id="mode-screen">
        <div class="close-btn" onclick="showScreen('home')">‚úï</div>
        <div class="header" id="mode-subject-name">FAN NOMI</div>
        
        <div id="subject-promo" class="welcome-container" style="border-width: 2px; padding: 15px; margin-bottom: 20px;">
            <div class="promo-banner">üî• TO'LIQ BAZA IMKONIYATI</div>
            <div id="promo-stats"></div>
            <p style="font-size: 13px; font-weight: 700;">To'liq bazani ochib, imtihonga 100% tayyor bo'ling!</p>
        </div>

        <button class="mode-btn" onclick="startQuizProcess('practice')">üìñ MASHQ QILISH</button>
        <button class="mode-btn" onclick="startQuizProcess('exam')">‚è± IMTIHON (35 SAVOL 35 DAQIQA)</button>
    </div>
    <div id="quiz-screen">
        <div class="close-btn" id="quiz-close" onclick="exitQuiz()">‚úï</div>
        <div id="timer-box" class="timer-display">35:00</div>
        <div id="quiz-label" class="mode-title">MASHQ</div>
        <div id="question-box" class="question-text"></div>
        <div id="options-box"></div>
        <div id="nav-controls" class="nav-controls">
            <button class="nav-btn" onclick="prevQ()">‚¨ÖÔ∏è ORTGA</button>
            <button class="nav-btn" onclick="nextQ()">KEYINGISI ‚û°Ô∏è</button>
        </div>
        <button id="finish-exam-btn" class="finish-exam-btn mode-btn" style="display:none;" onclick="confirmFinishExam()">IMTIHONNI YAKUNLASH</button>
    </div>
    <div id="result-screen">
        <div class="close-btn" onclick="showScreen('home')">‚úï</div>
        <div class="result-container">
            <h1 id="res-status">NATIJA</h1>
            <div id="res-score" class="big-score">0/70</div>
            <p id="res-info" style="font-size: 18px; font-weight: bold;"></p>
            <button class="mode-btn" onclick="showScreen('home')">QAYTA BOSHLASH</button>
        </div>
    </div>
    <div id="payment-screen">
        <div class="close-btn" onclick="showScreen('home')">‚úï</div>
        <div class="payment-container">
            <h1>USHBU FAN BO'YICHA</h1><p>Barcha savollar uchun <b>10 000 so'm</b> to'lov qiling.</p>
            <div style="border: 2px dashed var(--accent); padding: 10px; border-radius: 10px; margin: 10px 0; cursor: pointer;" onclick="navigator.clipboard.writeText('4073420068165541'); alert('Karta nusxalandi! üìã');">
                <p style="color: var(--accent); font-size: 20px; font-weight: 900; margin: 5px 0;">4073 4200 6816 5541</p>
                <p style="margin: 0; font-weight: 700;">Maruf Raxmonov</p>
                <small style="opacity: 0.6;">(Nusxalash uchun ustiga bosing)</small>
            </div>
            <input type="file" id="receipt-upload" accept="image/*" onchange="handleFileUpload(this)">
            <button class="mode-btn" style="background: #22c55e; color: white; border: none; padding: 12px;" onclick="document.getElementById('receipt-upload').click()">TO'LADIM</button>
        </div>
    </div>
    <div id="checking-screen">
        <div class="checking-container" id="checking-content">
            <h1 id="check-title" style="font-size: 26px; font-weight: 900; color: var(--accent); margin-bottom: 20px;">TO'LOV TEKSHIRILMOQDA</h1>
            <div id="check-animation"><div class="loader-spin"></div></div>
            <p id="check-text" style="font-size: 18px; font-weight: 600; line-height: 1.5;">Sizning to'lovingiz tekshirilmoqda. To'lov tasdiqlangach fan avtomatik ochiladi.</p>
            <p id="check-subtext" style="font-size: 16px; margin-top: 20px; color: var(--accent); font-weight: 800;">Bu 5-15 daqiqa vaqt olishi mumkin.</p>
            <div id="check-footer"></div>
        </div>
    </div>
    <div id="errors-screen">
        <div class="close-btn" onclick="showScreen('home')">‚úï</div>
        <div class="header">Xatolar Banki</div>
        <button class="mode-btn" id="error-test-btn" style="background: #22c55e; color: white; border:none; margin-bottom: 20px;" onclick="startErrorQuiz()">üî• XATOLARIMDAN TEST YECHISH</button>
        <div id="errors-list"></div>
        <button class="theme-btn" onclick="clearErrors()" style="margin-top: 20px; width: 100%;">TOZALASH</button>
    </div>
    <div id="settings-screen">
        <div class="close-btn" onclick="showScreen('home')">‚úï</div>
        <div class="header">Sozlamalar</div>
        <button class="theme-btn" onclick="setTheme('light')">KUNDUZGI rejim</button>
        <button class="theme-btn" onclick="setTheme('dark')">TUNGI rejim</button>
        <button class="mode-btn" style="background: #ef4444; color: white; border: none; margin-top: 40px;" onclick="logoutSystem()">üö™ TIZIMDAN CHIQISH</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item" onclick="showScreen('home')">üè†<br>Fanlar</div>
    <div class="nav-item" onclick="showScreen('errors')">‚ùå<br>Xatolar</div>
    <div class="nav-item" onclick="showScreen('profile')">üë§<br>Profil</div>
    <div class="nav-item" onclick="showScreen('settings')">‚öôÔ∏è<br>Sozlamalar</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, off, remove, onChildChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
    authDomain: "gen-lang-client-0228947349.firebaseapp.com",
    databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
    projectId: "gen-lang-client-0228947349",
    storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
    messagingSenderId: "253793341504",
    appId: "1:253793341504:web:709752258000dab44fcfa5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allData = {}, currentSet = [], activeSub = "", idx = 0, mode = "", countdownInterval = null, points = 0, corrects = 0, totalSeconds = 0;
let userAnswers = {};
let activePaymentListener = null;
let currentShuffledOptions = [];

/* TOUR & REGISTRATION FUNCTIONS */
window.nextStep = (s) => {
    document.querySelectorAll('.welcome-step').forEach(el => el.classList.remove('active'));
    document.getElementById('step' + s).classList.add('active');
};

window.showRegistration = () => {
    localStorage.setItem('welcomeSeen', 'true');
    showScreen('registration');
};

window.finishRegistration = async () => {
    const fn = document.getElementById('reg-firstname').value.trim();
    const ln = document.getElementById('reg-lastname').value.trim();
    const btn = document.getElementById('reg-save-btn');
    
    if(!fn || !ln) {
        alert("Iltimos, ism va familiyangizni to'liq kiriting!");
        return;
    }

    btn.disabled = true;
    btn.innerText = "YUKLANMOQDA...";

    const userId = "USER_" + Date.now();
    const userRef = ref(db, 'users/' + userId);
    const regTime = new Date().toLocaleString();

    try {
        await set(userRef, {
            id: userId,
            firstname: fn,
            lastname: ln,
            regTime: regTime,
            device: navigator.userAgent
        });

        localStorage.setItem('user_firstname', fn);
        localStorage.setItem('user_lastname', ln);
        localStorage.setItem('user_id', userId);
        localStorage.setItem('reg_date', regTime);
        localStorage.setItem('isRegistered', 'true');
        showScreen('home');
    } catch (error) {
        alert("Xatolik yuz berdi: " + error.message);
        btn.disabled = false;
        btn.innerText = "SAQLASH VA BOSHLASH üöÄ";
    }
};

function isUserLoggedIn() { return localStorage.getItem('isLoggedIn') === 'true'; }

function saveSubjectLocally(subName, questions) {
    let localStore = JSON.parse(localStorage.getItem('offline_subjects')) || {};
    localStore[subName] = questions;
    localStorage.setItem('offline_subjects', JSON.stringify(localStore));
}

function removeSubjectLocally(subName) {
    let localStore = JSON.parse(localStorage.getItem('offline_subjects')) || {};
    delete localStore[subName];
    localStorage.setItem('offline_subjects', JSON.stringify(localStore));
}

function getLocalQuestions(subName) {
    let localStore = JSON.parse(localStorage.getItem('offline_subjects')) || {};
    return localStore[subName];
}

window.showScreen = (name) => {
    if(name !== 'quiz' && countdownInterval){ clearInterval(countdownInterval); countdownInterval=null; }
    
    ['home','mode','quiz','errors','settings','result','payment','checking','welcome','registration', 'profile'].forEach(s=>{ 
        const e = document.getElementById(s+'-screen'); 
        if(e) e.style.display='none'; 
    });

    if(!localStorage.getItem('welcomeSeen')) {
        document.getElementById('welcome-screen').style.display = 'block';
        document.querySelector('.bottom-nav').style.display = 'none';
        return;
    }

    if(!localStorage.getItem('isRegistered') && name !== 'registration') {
        document.getElementById('registration-screen').style.display = 'block';
        document.querySelector('.bottom-nav').style.display = 'none';
        return;
    }

    document.querySelector('.bottom-nav').style.display = (name === 'quiz' || name === 'checking' || name === 'welcome' || name === 'registration') ? 'none' : 'flex';

    const targetScreen = document.getElementById(name+'-screen');
    if(targetScreen) targetScreen.style.display='block';
    
    if(name === 'mode') {
        const questions = allData[activeSub] || [];
        const isPaid = isSubjectPaid(activeSub);
        const promoBox = document.getElementById('subject-promo');
        if(isPaid) { promoBox.style.display = 'none'; } 
        else {
            promoBox.style.display = 'block';
            document.getElementById('promo-stats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-card"><span class="stat-num">${questions.length}</span><span>Savollar</span></div>
                    <div class="stat-card"><span class="stat-num">20</span><span>Bepul</span></div>
                </div>`;
        }
    }
    if(name === 'errors') renderErrors();
    if(name === 'profile') renderProfile();
};

const paymentsRef = ref(db, 'payments');
onValue(paymentsRef, (snapshot) => {
    if(!snapshot.exists()) return;
    const payments = snapshot.val();
    let paidSubjects = JSON.parse(localStorage.getItem('paid_subjects')) || [];
    let updated = false;
    
    const userId = localStorage.getItem('user_id');

    Object.keys(payments).forEach(payId => {
        const p = payments[payId];
        // Faqat shu foydalanuvchining to'lovini tekshiramiz
        if(payId === userId) {
            if(p.status === 'approved') {
                if(!paidSubjects.includes(p.subject)) {
                    localStorage.setItem('isLoggedIn', 'true');
                    paidSubjects.push(p.subject);
                    if(allData[p.subject]) saveSubjectLocally(p.subject, allData[p.subject]);
                    updated = true;
                }
            } else if (p.status === 'rejected' && paidSubjects.includes(p.subject)) {
                paidSubjects = paidSubjects.filter(s => s !== p.subject);
                removeSubjectLocally(p.subject);
                updated = true;
            }
        }
    });
    if(updated) { localStorage.setItem('paid_subjects', JSON.stringify(paidSubjects)); renderList(); }
});

function initData() {
    if(localStorage.getItem('isLoggedIn') === null) localStorage.setItem('isLoggedIn', 'true');
    
    if(!localStorage.getItem('welcomeSeen')) {
        showScreen('welcome');
    } else if (!localStorage.getItem('isRegistered')) {
        showScreen('registration');
    } else {
        showScreen('home');
    }

    const cachedData = localStorage.getItem('cached_questions');
    if(cachedData) { allData = JSON.parse(cachedData); document.getElementById('loader').style.display='none'; renderList(); }
    
    onValue(ref(db,'questions'), (snap)=>{ 
        if(snap.exists()){ 
            allData = snap.val(); 
            localStorage.setItem('cached_questions', JSON.stringify(allData));
            document.getElementById('loader').style.display='none'; 
            renderList(); 
            if(isUserLoggedIn()) {
                const paid = JSON.parse(localStorage.getItem('paid_subjects')) || [];
                paid.forEach(sub => { if(allData[sub]) saveSubjectLocally(sub, allData[sub]); });
            }
        } 
    }, { onlyOnce: true });
}

initData();

function isSubjectPaid(subName) { return (JSON.parse(localStorage.getItem('paid_subjects')) || []).includes(subName); }

function renderList(){
    const list=document.getElementById('subjects-list'); list.innerHTML="";
    Object.keys(allData).forEach(s=>{
        const c=document.createElement('div'); c.className='card';
        const paid = isSubjectPaid(s); const trialUsed = (JSON.parse(localStorage.getItem('used_trials')) || []).includes(s);
        c.innerHTML=`<strong>${s.toUpperCase()}</strong><br><small>${paid ? "‚úîÔ∏è OCHILGAN" : (trialUsed ? "üîí SINOV TUGADI" : "üîì SINOV (20 TA SAVOL)")}</small>`;
        c.onclick=()=>{ activeSub=s; document.getElementById('mode-subject-name').innerText=s.toUpperCase(); if(!paid && trialUsed) showScreen('payment'); else showScreen('mode'); };
        list.appendChild(c);
    });
}

function renderProfile() {
    const fn = localStorage.getItem('user_firstname') || 'ISM';
    const ln = localStorage.getItem('user_lastname') || 'FAMILIYA';
    const id = localStorage.getItem('user_id') || 'USER_000000';
    const date = localStorage.getItem('reg_date') || '-';
    
    const results = JSON.parse(localStorage.getItem('test_results')) || [];
    const totalTests = results.length;
    const avgScore = totalTests > 0 ? Math.round(results.reduce((a, b) => a + b, 0) / totalTests) : 0;

    document.getElementById('prof-fullname').innerText = `${fn} ${ln}`;
    document.getElementById('prof-initials').innerText = fn[0];
    document.getElementById('prof-id').innerText = `ID: ${id}`;
    document.getElementById('prof-total-tests').innerText = totalTests;
    document.getElementById('prof-avg-score').innerText = avgScore;
    document.getElementById('info-fn').innerText = fn;
    document.getElementById('info-ln').innerText = ln;
    document.getElementById('info-date').innerText = date;
}

window.startQuizProcess=(m)=>{
    mode=m; idx=0; points=0; corrects=0; userAnswers = {}; currentShuffledOptions = [];
    let src = getLocalQuestions(activeSub) || allData[activeSub];
    const isPaid = isSubjectPaid(activeSub);
    const trialUsed = (JSON.parse(localStorage.getItem('used_trials')) || []).includes(activeSub);
    if(!isPaid && trialUsed) { showScreen('payment'); return; }
    const timerEl=document.getElementById('timer-box'); const finishBtn = document.getElementById('finish-exam-btn');
    document.getElementById('quiz-label').innerText = m === 'exam' ? '‚è± IMTIHON' : 'üìñ MASHQ';
    if(m==='exam'){
        currentSet = [...src].sort(() => Math.random() - 0.5).slice(0, 35);
        timerEl.style.display='block'; totalSeconds = 35*60; updateTimer(timerEl);
        finishBtn.style.display = 'block';
        if(countdownInterval) clearInterval(countdownInterval);
        countdownInterval=setInterval(()=>{ totalSeconds--; updateTimer(timerEl); if(totalSeconds<=0){ clearInterval(countdownInterval); calculateFinalScore(); } },1000);
    } else { 
        currentSet = isPaid ? src : src.slice(0, 20);
        timerEl.style.display='none'; finishBtn.style.display = 'none';
    }
    showScreen('quiz'); renderQ();
};

function renderQ(){
    const q=currentSet[idx]; document.getElementById('question-box').innerHTML=`${idx+1}. ${q.question}`;
    const box=document.getElementById('options-box'); box.innerHTML="";
    if(!currentShuffledOptions[idx]) {
        currentShuffledOptions[idx] = [{t:q.options.A, c:true}, {t:q.options.B, c:false}, {t:q.options.C, c:false}, {t:q.options.D, c:false}].sort(() => Math.random() - 0.5);
    }
    currentShuffledOptions[idx].forEach(o=>{
        const d=document.createElement('div'); d.className='option'; d.innerHTML=o.t;
        if(userAnswers[idx] === o.t) { if(mode === 'exam') d.classList.add('selected-exam'); else { if(o.c) d.classList.add('correct'); else d.classList.add('wrong'); } }
        if(userAnswers[idx] && mode !== 'exam' && o.c) d.classList.add('correct');
        d.onclick=()=>{
            if(mode !== 'exam' && userAnswers[idx]) return; 
            userAnswers[idx] = o.t;
            if(mode === 'exam') { box.querySelectorAll('.option').forEach(el => el.classList.remove('selected-exam')); d.classList.add('selected-exam'); } 
            else {
                if(o.c) { d.classList.add('correct'); } 
                else { d.classList.add('wrong'); box.querySelectorAll('.option').forEach(b => { if(currentShuffledOptions[idx].find(opt => opt.t === b.innerHTML && opt.c)) b.classList.add('correct'); }); if(activeSub !== "Xatolar Banki") saveX(q, activeSub, mode); }
                box.querySelectorAll('.option').forEach(el => el.style.pointerEvents = 'none');
            }
        };
        box.appendChild(d);
    });
}

window.handleFileUpload = (input) => {
    if (input.files && input.files[0]) {
        const userId = localStorage.getItem('user_id'); 
        if(activePaymentListener) off(activePaymentListener);
        const reader = new FileReader(); 
        const paymentId = userId; 
        reader.onload = function(e) {
            const base64Image = e.target.result; 
            const paymentsRef = ref(db, 'payments'); 
            const paymentRef = ref(db, 'payments/' + paymentId);
            
            showScreen('checking'); 
            resetCheckingScreen(); 
            
            // Listenerni o'rnatamiz
            onValue(paymentRef, (snapshot) => {
                if(snapshot.exists()) {
                    const data = snapshot.val();
                    if(data.status === 'approved') { displayStatus('success', data.subject); } 
                    else if (data.status === 'rejected') { displayStatus('error'); }
                }
            });

            set(paymentRef, { 
                id: paymentId, 
                subject: activeSub, 
                image: base64Image, 
                time: new Date().toLocaleString(), 
                status: 'pending', 
                userName: localStorage.getItem('user_firstname') + ' ' + localStorage.getItem('user_lastname') 
            });
        };
        reader.readAsDataURL(input.files[0]);
    }
};

function resetCheckingScreen() {
    document.getElementById('check-title').innerText = "TO'LOV TEKSHIRILMOQDA"; document.getElementById('check-title').style.color = "var(--accent)";
    document.getElementById('check-animation').innerHTML = '<div class="loader-spin"></div>'; document.getElementById('check-text').innerText = "Sizning to'lovingiz tekshirilmoqda. To'lov tasdiqlangach fan avtomatik ochiladi.";
    document.getElementById('check-subtext').style.display = "block"; document.getElementById('check-footer').innerHTML = "";
}

function displayStatus(type, subName = "") {
    const title = document.getElementById('check-title'), anim = document.getElementById('check-animation'), text = document.getElementById('check-text'), subtext = document.getElementById('check-subtext'), footer = document.getElementById('check-footer');
    subtext.style.display = "none";
    if(type === 'success') { title.innerText = "MUVAFFAQIYATLI!"; title.style.color = "#22c55e"; anim.innerHTML = '<span class="status-icon">‚úîÔ∏è</span>'; text.innerHTML = `To'lovingiz tasdiqlandi! <br> <span class="subject-badge">${subName}</span>`; footer.innerHTML = '<button class="mode-btn" onclick="showScreen(\'home\')">DAVOM ETISH</button>'; } 
    else { title.innerText = "RAD ETILDI!"; title.style.color = "#ef4444"; anim.innerHTML = '<span class="status-icon">‚ùå</span>'; text.innerText = "To'lovingiz bekor qilindi. Iltimos, qaytadan chekni tekshirib yuklang."; footer.innerHTML = '<button class="mode-btn" style="background:#ef4444; border:none;" onclick="location.reload()">QAYTADAN BOSHLASH</button>'; }
}

window.logoutSystem = async () => { 
    if(confirm("Tizimdan chiqilsa barcha ma'lumotlaringiz (shu jumladan ism-familiya, to'lovlar va natijalar) bazadan va telefondan butunlay o'chirib tashlanadi. Rozimisiz?")) { 
        const userId = localStorage.getItem('user_id');
        if(userId) {
            try {
                // remove() endi to'g'ri ishlaydi
                await remove(ref(db, 'users/' + userId));
                await remove(ref(db, 'payments/' + userId));
            } catch (e) {
                console.log("Bazadan o'chirishda xatolik:", e);
            }
        }
        localStorage.clear(); 
        sessionStorage.clear();
        window.location.href = window.location.pathname + "?v=" + Date.now();
    } 
};

function endQuiz(){ 
    if(countdownInterval) clearInterval(countdownInterval); 
    const st=document.getElementById('res-status'), sc=document.getElementById('res-score'); 
    sc.innerText=`${points}/70`; 
    document.getElementById('res-info').innerText=`To'g'ri: ${corrects}/35`; 
    
    if(mode === 'exam') {
        const results = JSON.parse(localStorage.getItem('test_results')) || [];
        const percent = Math.round((points / 70) * 100);
        results.push(percent);
        localStorage.setItem('test_results', JSON.stringify(results));
    }

    if(points>=42){ st.innerText="MUVAFFAQIYATLI!"; st.style.color="#22c55e"; } 
    else { st.innerText="YIQILDINGIZ!"; st.style.color="#ef4444"; } 
    showScreen('result'); 
}

function calculateFinalScore() { corrects = 0; points = 0; currentSet.forEach((q, i) => { if(userAnswers[i] === q.options.A) { corrects++; points += 2; } else if(userAnswers[i]) { saveX(q, activeSub, mode); } }); endQuiz(); }

function saveX(q, s, m){ let x = JSON.parse(localStorage.getItem('xatolar')) || []; if(!x.find(i => i.question === q.question)){ x.push({ ...q, sub: s, mode: m }); localStorage.setItem('xatolar', JSON.stringify(x)); } }

function renderErrors(){
    const list = document.getElementById('errors-list'), x = JSON.parse(localStorage.getItem('xatolar')) || [];
    const paidSubjects = JSON.parse(localStorage.getItem('paid_subjects')) || [];
    const filteredErrors = x.filter(e => paidSubjects.includes(e.sub));
    const btn = document.getElementById('error-test-btn'); if(filteredErrors.length >= 5) btn.style.display = 'block'; else btn.style.display = 'none';
    list.innerHTML = filteredErrors.length ? "" : "<p style='text-align:center; padding:20px;'>Hali xatolar yo'q.</p>";
    filteredErrors.forEach(e => {
        const div = document.createElement('div'); div.className = 'error-card'; const mLabel = e.mode === 'exam' ? 'Imtihon' : 'Mashq';
        div.innerHTML = `<span style="font-size:10px; background:var(--accent); color:var(--bg); padding:2px 6px; border-radius:4px; font-weight:900; text-transform:uppercase;">${e.sub}</span><span class="mode-badge">${mLabel}</span><p style="margin:10px 0; font-weight:600;">${e.question}</p><p style="color:#22c55e; margin:0; font-weight:800;">To'g'ri javob: ${e.options.A}</p>`;
        list.appendChild(div);
    });
}

window.startErrorQuiz = () => { const x = JSON.parse(localStorage.getItem('xatolar')) || []; const paidSubjects = JSON.parse(localStorage.getItem('paid_subjects')) || []; const filtered = x.filter(e => paidSubjects.includes(e.sub)); mode = "practice"; idx = 0; points = 0; corrects = 0; userAnswers = {}; currentShuffledOptions = []; currentSet = [...filtered].sort(() => Math.random() - 0.5); activeSub = "Xatolar Banki"; showScreen('quiz'); renderQ(); };

window.nextQ = () => { 
    if(idx < currentSet.length - 1) { idx++; renderQ(); } 
    else { 
        if(activeSub === "Xatolar Banki") { showScreen('home'); }
        else if(!isSubjectPaid(activeSub)) { 
            alert("SINOV REJIMI TUGADI! üöÄ\nBarcha savollarni ochish uchun to'lov qiling va imtihonga 100% tayyor bo'ling!"); 
            let used = JSON.parse(localStorage.getItem('used_trials')) || []; if(!used.includes(activeSub)) { used.push(activeSub); localStorage.setItem('used_trials', JSON.stringify(used)); }
            showScreen('payment'); 
        }
        else if(isSubjectPaid(activeSub)) { if(mode === 'exam') calculateFinalScore(); else showScreen('home'); }
    }
};
window.prevQ = () => { if(idx > 0) { idx--; renderQ(); } };
window.exitQuiz = () => { if(confirm("Mashqni yakunlaysizmi?")) showScreen('home'); };
window.confirmFinishExam = () => { if(confirm("Natijani ko'rmoqchimisiz?")) calculateFinalScore(); };
function updateTimer(el){ let mins=Math.floor(totalSeconds/60), secs=totalSeconds%60; el.innerText=`${mins}:${secs<10?'0'+secs:secs}`; }
window.clearErrors = () => { if(confirm("Xatolarni o'chirib tashlaysizmi?")) { localStorage.removeItem('xatolar'); renderErrors(); } };
window.setTheme = (t) => { document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t); };
setTheme(localStorage.getItem('theme') || 'dark');
</script>
</body>
</html>
