<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brain Pro | Maruf Raxmonov</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #0a0a0b; --card: #16161e; --green: #28a745; --red: #dc3545; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; user-select: none; }
        
        /* Layout */
        #auth, #app { display: none; padding: 20px; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; }

        /* Auth & Forms */
        input, select { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #333; background: var(--card); color: #fff; margin-bottom: 15px; outline: none; box-sizing: border-box; font-size: 16px; }
        .btn { border: none; padding: 18px; border-radius: 15px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.2s; }
        .btn-p { background: var(--p); color: #fff; box-shadow: 0 4px 15px rgba(123, 66, 245, 0.3); }
        .btn-p:active { transform: scale(0.98); }

        /* Quiz UI */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 10px; background: var(--card); border-radius: 15px; }
        .xp-badge { background: var(--p); padding: 8px 15px; border-radius: 20px; font-weight: 800; font-size: 14px; }
        
        .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid #333; margin-top: 20px; min-height: 200px; display: flex; flex-direction: column; justify-content: center; }
        #question { font-size: 20px; line-height: 1.4; margin-bottom: 20px; }
        
        .options-grid { display: grid; gap: 12px; }
        .option-btn { background: #222; color: #fff; padding: 15px; border-radius: 12px; border: 1px solid #444; text-align: left; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .option-btn:active { background: #333; }
        .correct { background: var(--green) !important; border-color: var(--green); }
        .wrong { background: var(--red) !important; border-color: var(--red); }

        /* Navigation */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { font-size: 11px; opacity: 0.5; cursor: pointer; text-align: center; color: #fff; text-decoration: none; }
        .nav-item.active { opacity: 1; color: var(--p); }
    </style>
</head>
<body>

    <div id="auth">
        <div class="container">
            <h1 style="color: var(--p); font-size: 32px;">Brain Pro üß†</h1>
            <p style="color: #888; margin-bottom: 30px;">Bilimingizni sinab ko'ring va XP yig'ing!</p>
            <input type="text" id="r-name" placeholder="Ismingiz">
            <select id="r-region">
                <option value="">Viloyatni tanlang</option>
            </select>
            <button class="btn btn-p" id="regBtn">BARMOQ IZI BILAN KIRISH</button>
        </div>
    </div>

    <div id="app">
        <div class="container">
            <div class="header">
                <span id="u-name" style="font-weight: bold; font-size: 18px;">...</span>
                <div class="xp-badge">XP: <span id="u-xp">0</span></div>
            </div>

            <div id="p-quiz" class="panel active-p">
                <div class="card">
                    <div id="question">Yuklanmoqda...</div>
                    <div id="options" class="options-grid"></div>
                </div>
                <div id="feedback" style="margin-top: 20px; font-weight: bold; font-size: 18px;"></div>
            </div>

            <div id="p-leader" class="panel" style="display: none;">
                <h2 style="color: var(--p);">üèÜ Top Talabalar</h2>
                <div id="leader-list" style="text-align: left; background: var(--card); border-radius: 15px; padding: 15px;"></div>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="nav('quiz', this)">üß†<br>Mashq</div>
            <div class="nav-item" onclick="nav('leader', this)">üèÜ<br>Reyting</div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id || "user_debug_123";
    const userRef = ref(db, 'brain_users/' + uid);
    
    let userData = { xp: 0 };
    let allQuestions = [];
    let currentQuestion = null;
    let isAnswering = false;

    // --- SETTINGS & REGIONS ---
    onValue(ref(db, 'settings/regions'), (s) => {
        const regions = s.val() || ["Toshkent", "Samarqand", "Buxoro", "Andijon"];
        const sel = document.getElementById('r-region');
        if(sel.options.length <= 1) {
            regions.forEach(r => { let o = document.createElement('option'); o.value=r; o.innerText=r; sel.appendChild(o); });
        }
    });

    // --- REGISTRATION ---
    document.getElementById('regBtn').onclick = () => {
        const name = document.getElementById('r-name').value;
        if(!name) return tg.showAlert("Ismingizni kiriting!");

        tg.BiometricManager.init(() => {
            tg.BiometricManager.requestAccess({ reason: "Profilni tasdiqlash" }, (ok) => {
                if(ok) {
                    tg.BiometricManager.authenticate({ reason: "Xavfsiz kirish" }, async (success) => {
                        if(success) {
                            const d = { name, xp: 0, region: document.getElementById('r-region').value, last_seen: Date.now() };
                            await set(userRef, d);
                            loadApp(d);
                        }
                    });
                } else {
                    tg.showAlert("Biometrika kerak!");
                }
            });
        });
    };

    // --- LOAD APP ---
    async function loadApp(data) {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('u-name').innerText = data.name;

        // Savollarni bazadan bir marta yuklab olamiz
        const qSnap = await get(ref(db, 'brain_questions'));
        if(qSnap.exists()) {
            allQuestions = qSnap.val();
            nextQuestion();
        }

        // Real-time XP yangilanishi
        onValue(ref(db, `brain_users/${uid}/xp`), (s) => {
            userData.xp = s.val() || 0;
            document.getElementById('u-xp').innerText = userData.xp;
        });
    }

    // --- QUIZ LOGIC ---
    function nextQuestion() {
        if(allQuestions.length === 0) return;
        isAnswering = false;
        document.getElementById('feedback').innerText = "";
        
        const idx = Math.floor(Math.random() * allQuestions.length);
        currentQuestion = allQuestions[idx];

        document.getElementById('question').innerText = currentQuestion.q;
        const optBox = document.getElementById('options');
        optBox.innerHTML = "";

        currentQuestion.a.forEach((opt, i) => {
            const btn = document.createElement('button');
            btn.className = "option-btn";
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(i, btn);
            optBox.appendChild(btn);
        });
    }

    async function checkAnswer(index, btn) {
        if(isAnswering) return;
        isAnswering = true;

        const correctIndex = currentQuestion.c;
        const allBtns = document.querySelectorAll('.option-btn');

        if(index === correctIndex) {
            btn.classList.add('correct');
            document.getElementById('feedback').innerText = "‚úÖ Juda yaxshi!";
            document.getElementById('feedback').style.color = "var(--green)";
            await set(ref(db, `brain_users/${uid}/xp`), userData.xp + 10);
        } else {
            btn.classList.add('wrong');
            allBtns[correctIndex].classList.add('correct');
            document.getElementById('feedback').innerText = "‚ùå Xato!";
            document.getElementById('feedback').style.color = "var(--red)";
        }

        setTimeout(nextQuestion, 2000);
    }

    // --- NAVIGATION & LEADERBOARD ---
    window.nav = (p, el) => {
        document.querySelectorAll('.panel').forEach(x => x.style.display = 'none');
        document.getElementById('p-' + p).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        el.classList.add('active');

        if(p === 'leader') loadLeaderboard();
    };

    async function loadLeaderboard() {
        const leaderBox = document.getElementById('leader-list');
        leaderBox.innerHTML = "Yuklanmoqda...";
        
        const topQuery = query(ref(db, 'brain_users'), orderByChild('xp'), limitToLast(10));
        const snap = await get(topQuery);
        
        if(snap.exists()) {
            let list = [];
            snap.forEach(child => { list.push(child.val()); });
            list.reverse(); // Eng yuqori XP tepada bo'lishi uchun
            
            leaderBox.innerHTML = list.map((u, i) => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;">
                    <span>${i+1}. ${u.name}</span>
                    <span style="color:var(--p); font-weight:bold;">${u.xp} XP</span>
                </div>
            `).join('');
        }
    }

    // STARTUP
    window.onload = async () => {
        const s = await get(userRef);
        if(s.exists()) loadApp(s.val());
        else document.getElementById('auth').style.display = 'block';
    };
</script>
</body>
</html>
