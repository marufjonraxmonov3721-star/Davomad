<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kino Pro System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #7b42f5; --bg: #000; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .app-container { height: 100vh; display: flex; flex-direction: column; }
        
        /* Kirish va Link qismi */
        .init-box { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 25px; text-align: center; }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid var(--p); background: #111; color: white; margin-bottom: 15px; outline: none; }
        
        /* Pleyer */
        #video-box { display: none; flex-grow: 1; background: #000; position: relative; }
        video { width: 100%; height: 100%; background: #000; }

        /* Nazorat Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .card { background: var(--p); padding: 35px; border-radius: 25px; width: 80%; text-align: center; box-shadow: 0 0 30px var(--p); }
        .btn { background: #fff; color: #000; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="init-view" class="init-box">
        <h1 style="color: var(--p); margin-bottom: 5px;">ðŸŽ¬ KINO PRO</h1>
        <p style="opacity: 0.6; font-size: 14px;">Botdagi xabar linkini yoki Direct linkni joylang</p>
        
        <input type="text" id="inputUrl" placeholder="https://t.me/c/..." autocomplete="off">
        
        <button class="btn" style="background: var(--p); color: #fff;" onclick="startSystem()">TIZIMNI ISHLATISH</button>
        
        <p style="font-size: 10px; margin-top: 20px; color: #444;">Osiyo International University | Maruf Raxmonov Edition</p>
    </div>

    <div id="video-box">
        <video id="mainVideo" controls playsinline></video>
        
        <div id="sleepModal" class="modal">
            <div class="card">
                <h2 style="margin: 0;">UYG'OQMISIZ? ðŸ˜´</h2>
                <p>Kino to'xtatildi. Tasdiqlang!</p>
                <div id="timer" style="font-size: 60px; font-weight: bold; margin: 10px 0;">30</div>
                <button class="btn" onclick="confirmAwake()">HA, UYG'OQMAN!</button>
            </div>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const v = document.getElementById('mainVideo');
    const modal = document.getElementById('sleepModal');
    let points = [];
    let currentPoint = 0;
    let clock;

    function startSystem() {
        let url = document.getElementById('inputUrl').value.trim();
        if(!url) return alert("Linkni kiriting!");

        // 1. Agar xabar linki bo'lsa (t.me), uni embed qilib ochishga urinadi
        // 2. Agar .mp4 bo'lsa, to'g'ridan-to'g'ri ochadi
        if(url.includes("t.me/")) {
            // Telegram bot xabari bo'lsa, uni bizga kerakli oqimga aylantirish mantiqi
            url = url.replace("t.me/", "t.me/s/") + "?embed=1";
            // Bu holda biz iframe ishlatishimiz kerak bo'ladi
            document.getElementById('video-box').innerHTML = `<iframe src="${url}" style="width:100%; height:100%; border:none;" allowfullscreen></iframe>`;
            setupIframeTimer();
        } else {
            v.src = url;
            v.onloadedmetadata = () => {
                const d = v.duration;
                points = [d/3, (d/3)*2, d-20];
                v.play();
            };
        }

        document.getElementById('init-view').style.display = 'none';
        document.getElementById('video-box').style.display = 'block';
    }

    // Video vaqtini kuzatish (3 bosqichli nazorat)
    v.ontimeupdate = () => {
        if (currentPoint < points.length && v.currentTime >= points[currentPoint]) {
            triggerCheck();
            currentPoint++;
        }
    };

    function setupIframeTimer() {
        // Iframe ichidagi vaqtni bilolmaganimiz uchun har 30 daqiqada tekshiramiz
        setInterval(() => {
            triggerCheck();
        }, 30 * 60 * 1000);
    }

    function triggerCheck() {
        v.pause();
        modal.style.display = 'flex';
        let sec = 30;
        document.getElementById('timer').innerText = sec;
        
        clock = setInterval(() => {
            sec--;
            document.getElementById('timer').innerText = sec;
            if(sec <= 0) {
                clearInterval(clock);
                tg.close();
            }
        }, 1000);
    }

    function confirmAwake() {
        clearInterval(clock);
        modal.style.display = 'none';
        v.play();
    }
</script>
</body>
</html>
