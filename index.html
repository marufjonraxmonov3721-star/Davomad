<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGate: Secure SMS Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-color: #248b65; --blue: #0088cc; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px; margin: auto; text-align: center; }
        
        .form-group { text-align: left; margin-bottom: 15px; }
        label { display: block; font-size: 13px; margin-bottom: 5px; color: #555; font-weight: 600; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--tg-color); color: white; }
        
        #recaptcha-container { margin: 10px 0; }
        .hidden { display: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--blue); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color: var(--blue);">Ro'yxatdan o'tish</h2>
    <p style="font-size: 13px; color: #888;">Ma'lumotlarni to'ldiring va raqamingizni tasdiqlang</p>

    <div id="step-info">
        <div class="form-group"><label>Ism</label><input type="text" id="reg-firstname" placeholder="Masalan: Maruf"></div>
        <div class="form-group"><label>Familiya</label><input type="text" id="reg-lastname" placeholder="Masalan: Toshpo'latov"></div>
        <div class="form-group"><label>Otasining ismi</label><input type="text" id="reg-middlename" placeholder="Masalan: Akmalovich"></div>
        <div class="form-group"><label>Telefon raqami</label><input type="tel" id="reg-phone" value="+998"></div>
        
        <div id="recaptcha-container"></div>
        <button class="btn-blue" id="send-code-btn" onclick="onSendSMS()">SMS kod yuborish</button>
    </div>

    <div id="step-otp" class="hidden">
        <div class="form-group">
            <label>SMS kodni kiriting</label>
            <input type="number" id="otp-code" placeholder="6 xonali kod">
        </div>
        <button class="btn-green" onclick="onVerifyCode()">Tasdiqlash va Kirish</button>
        <p style="font-size: 12px; color: #666; cursor: pointer; margin-top: 10px;" onclick="location.reload()">Raqamni o'zgartirish</p>
    </div>

    <div id="view-main" class="hidden">
        <h3 id="welcome-user">Xush kelibsiz!</h3>
        <div style="font-size: 50px; margin: 20px 0;">âœ…</div>
        <p>Sizning shaxsingiz real SMS orqali tasdiqlandi.</p>
        <button class="btn-green" onclick="tg.close()">Ilovadan foydalanish</button>
    </div>
</div>

<script type="module">
    // Firebase SDK larni import qilish
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
        authDomain: "gen-lang-client-0228947349.firebaseapp.com",
        databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
        projectId: "gen-lang-client-0228947349",
        storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
        messagingSenderId: "253793341504",
        appId: "1:253793341504:web:709752258000dab44fcfa5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.ready();

    let confirmationResult;

    // Recaptcha-ni sozlash
    window.setupRecaptcha = function() {
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
            'size': 'normal',
            'callback': (response) => {}
        });
    };

    // SMS yuborish
    window.onSendSMS = function() {
        const phone = document.getElementById('reg-phone').value;
        const name = document.getElementById('reg-firstname').value;
        
        if (phone.length < 12 || !name) {
            tg.showAlert("Ma'lumotlarni to'g'ri kiriting!");
            return;
        }

        if(!window.recaptchaVerifier) setupRecaptcha();

        const btn = document.getElementById('send-code-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loader"></span> Yuborilmoqda...';

        signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
            .then((result) => {
                confirmationResult = result;
                document.getElementById('step-info').classList.add('hidden');
                document.getElementById('step-otp').classList.remove('hidden');
            }).catch((error) => {
                tg.showAlert("Xatolik: " + error.message);
                btn.disabled = false;
                btn.innerText = 'SMS kod yuborish';
            });
    };

    // Kodni tekshirish va ma'lumotlarni saqlash
    window.onVerifyCode = function() {
        const code = document.getElementById('otp-code').value;
        confirmationResult.confirm(code).then((result) => {
            const user = result.user;
            const tid = tg.initDataUnsafe.user?.id || "test_user";

            const finalData = {
                firstName: document.getElementById('reg-firstname').value,
                lastName: document.getElementById('reg-lastname').value,
                middleName: document.getElementById('reg-middlename').value,
                phone: user.phoneNumber,
                uid: user.uid,
                verified: true
            };

            // Firebase-ga saqlash
            set(ref(db, `users/${tid}`), finalData).then(() => {
                showMain(finalData);
            });
        }).catch(() => {
            tg.showAlert("Kod noto'g'ri! Qayta urinib ko'ring.");
        });
    };

    function showMain(data) {
        document.getElementById('step-otp').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
        document.getElementById('welcome-user').innerText = `Xush kelibsiz, ${data.firstName}!`;
    }
</script>
</body>
</html>
